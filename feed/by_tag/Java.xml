<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="https://blog.vepo.dev/feed/by_tag/Java.xml" rel="self" type="application/atom+xml" /><link href="https://blog.vepo.dev/" rel="alternate" type="text/html" /><updated>2026-02-21T19:42:20+00:00</updated><id>https://blog.vepo.dev/feed/by_tag/Java.xml</id><title type="html">vepo</title><subtitle>Um reposit√≥rio para todos os posts, palestras e tutoriais que j√° fiz. Java, Desenvolvimento de Software e reflex√µes sobre filosofia</subtitle><author><name>{&quot;twitter&quot;=&gt;&quot;vepo&quot;, &quot;linkedin&quot;=&gt;&quot;https://www.linkedin.com/in/victorosorio/&quot;, &quot;picture&quot;=&gt;&quot;/assets/images/me.avif&quot;}</name></author><entry><title type="html">Dicas para quem est√° iniciando na programa√ß√£o</title><link href="https://blog.vepo.dev/posts/dicas-para-quem-esta-iniciando-na-programacao" rel="alternate" type="text/html" title="Dicas para quem est√° iniciando na programa√ß√£o" /><published>2026-01-21T00:00:00+00:00</published><updated>2026-01-21T00:00:00+00:00</updated><id>https://blog.vepo.dev/posts/18-44-00-dicas-para-quem-esta-iniciando-na-programacao</id><content type="html" xml:base="https://blog.vepo.dev/posts/dicas-para-quem-esta-iniciando-na-programacao"><![CDATA[<p>Desde que comecei o meu canal recebo constantemente uma pergunta semelhate: <em>estou iniciando na programa√ß√£o e preciso de dicas, pode me dar algumas?</em> Vou tentar esbo√ßar aqui alguns conselhos que podem te ajudar. A grande maioria delas sugir√° da experi√™ncia de ver <strong>incautos</strong> reclamando nas redes sociais.</p>

<p><a href="https://www.dicio.com.br/incautos/"><img src="/assets/images/incauto.png" alt="Significado da palavra incauto no dicion√°rio. As palavras &quot;desprevenido e ing√™nuo&quot; est√£o marcadas em vermelho" /></a></p>

<h2 id="1-entenda-o-que-√©-programar">1. Entenda o que √© programar</h2>

<p>J√° perdi a conta das vezes que vi pessoas reclamando que o computador n√£o faz aquilo que est√° programado, ou que ‚Äúm√°gicas‚Äù acontece. Isso pode at√© parecer uma mera ingenuidade ou piada, mas vou levar com seriedade para me dar argumento de definir o que √© programar.</p>

<p>Programar √© definir o passo a passo que um programa deve fazer. Voc√™ √© quem tem o total controle de tudo que est√° acontecendo no seu programa. Mas ele pode reagir a condi√ß√µes ou limita√ß√µes externas. Se algo aconteceu de inesperado, ou voc√™ n√£o ‚Äúprogramou‚Äù ele direito ou algo de ‚Äúinesperado‚Äù para voc√™ aconteceu. Lidar com o inesperado √© uma habilidade que aprendemos com o tempo, aprendemos a isolar o inesperado para identificar e controlar ele.</p>

<p>N√≥s, como programadores, temos que ter ci√™ncia do que est√° acontecendo, entender e prever poss√≠veis erros. E quando erros acontecerem precisamos identificar, corrigir os efeitos do erro e atualizar o c√≥digo para que o erro n√£o aconte√ßa mais.</p>

<h2 id="2-entenda-como-o-seu-c√≥digo-√©-executado">2. Entenda como o seu c√≥digo √© executado</h2>

<p>Esse √© uma dica que vai economizar muito do seu tempo. Erros acontecem e as vezes os erros acontecem porque seu c√≥digo n√£o foi executado corretamente, ou voc√™ est√° olhando para a execu√ß√£o de uma vers√£o antiga dela.</p>

<p>√â bom sempre entender como seu c√≥digo √© executado. Quais s√£o os passos para transformar aquele arquivo texto em algo que o computador entenda. Computador n√£o entende seu c√≥digo, ele s√≥ entende a linguagem de m√°quina e √© impratic√°vel voc√™s escrever programas complexos em linguagem de m√°quina. Por isso muitas pessoas preferem aprender a programar em linguagens de script, ou seja, linguagens que s√£o executadas diretamente do c√≥digo como python e javascript.</p>

<p>Linguagens como o Java ou C precisam ser compiladas e depois executadas. √â um passo um pouco dolorido para quem est√° aprendendo, mas √© recompensador voc√™ entender o processo completo. A minha dica √© que voc√™ fa√ßa apenas uma vez e depois escreva um script, quem sabe usando <code class="language-plaintext highlighter-rouge">bash</code> ou o similar do Windows, para repetir esses passos autom√°ticamente.</p>

<p>Voc√™ tamb√©m pode procurar alguma ferramenta que transforme a linguagem que voc√™ est√° estudando em script. No Java, por exemplo, existe o <a href="https://www.jbang.dev/">JBang</a>. Ou quem sabe algum site que facilita a sua vida criando ferramentas f√°ceis de executar o c√≥digo, em uma busca r√°pida encontrei o <a href="https://www.onlinegdb.com/online_c_compiler">onlinegdb.com</a> para C e sei do <a href="https://exercism.org/">exercism</a> que d√° suporte a sua linguagem.</p>

<p>Facilite a sua vida e foque no que √© piorit√°rio, tente automatizar tudo que √© secund√°rio.</p>

<h2 id="3-busque-nas-redes-sociais-as-comunidades-da-sua-linguagem">3. Busque nas redes sociais as comunidades da sua linguagem</h2>

<p>Minha pr√≥xima dica √© construir uma ‚Äútimeline‚Äù na sua rede <em>anti</em>-social preferida de pessoas que falam sobre o tema e d√£o dicas sobre o tema. Procure focar naqueles que realmente d√£o boas dicas e n√£o naqueles que ficam fazendo piadas o tempo inteiro depreciando a imagem dos outros e das outras linguagens.</p>

<p>Como exemplo, fiz o exercicio de procurar a comunidade da linguagem C no Brasil. Procurei no Google ‚Äúcomunidade c lang brasil‚Äù e achei a p√°gina <a href="https://ccppbrasil.github.io/">C &amp; C++ Brasil</a>. L√° tem uma s√©rie de blogs que podem ser uma boa ajuda, j√° procura os autores nas redes sociais e segue eles.</p>

<p>Se alguma d√∫vida surgir, pergunta pra eles nas redes sociais.</p>

<p>NOTE: N√£o siga babaca! Se voc√™ viu a pessoa sendo babaca com qualquer pessoa, unfollow √© liberdade.</p>

<h2 id="4-procure-uma-boa-ide">4. Procure uma boa IDE</h2>

<p>Eu tenho mais de 20 anos programado Java e n√£o sou ningu√©m sem uma boa IDE. N√£o vou dizer que eu n√£o conseguiria escrever um programa sem meu VSCode, IntelliJ ou o Eclipse. Conseguiria. Mas eu n√£o conhe√ßo todos os m√©todos da classe <a href="https://docs.oracle.com/en/java/javase/25/docs/api/java.base/java/lang/String.html">String</a> decorado e nem tenho acesso f√°cil a documenta√ß√£o. Para colocar a refer√™ncia a classe eu procurei no Google e muito dos m√©todos que eu sei de cabe√ßa existem desde o Java 4 (est√° na 25 hoje), tenho uma dificuldade enorme para achar os m√©todos adicionados nos √∫ltimos 10 anos. Logo a IDE √© sua melhor amiga!</p>

<p>IDEs s√£o Integrated Development Environment, ou Ambiente de Desenvolvimento Integrado. As pessoas n√£o usam o Word ou o Notepad pra desenvolver, nem o Notepad++. Usam uma IDE e uma IDE com plugins que d√£o suporte a sua linguagem. Est√° com uma vari√°vel e n√£o conhece a documenta√ß√£o do tiop dela? <code class="language-plaintext highlighter-rouge">CTRL+SPACE</code> e a lista de m√©todos que voc√™ pode chamar est√° na m√£o, isso √© o que se chama Code Completion e √© infinitamente melhor do que qualquer LLM da vida porque ela vai te dar possibilidades e documenta√ß√£o.</p>

<p>Com a IDE √© poss√≠vel tamb√©m rodar seu c√≥digo, de forma f√°cil. As vezes s√≥ aperta no play ‚ñ∂Ô∏è e üí°! Isso tamb√©m cobre o que falei na dica 2.</p>

<h2 id="5-entenda-a-estrutura-b√°sica-da-linguagem">5. Entenda a estrutura b√°sica da linguagem</h2>

<p>Voc√™ tem que entender 2 coisas b√°sicas sobre a linguagem que voc√™ est√° aprendendo.</p>

<ol>
  <li>Qual o paradigma dela?</li>
  <li>Quais as estruturas sintaticas dela?</li>
</ol>

<p>A resposta da primeira pergunta vai te levar em um mundo de possibilidades que definir√£o a forma que voc√™ vai desenvolver. Saber que Java √© uma linguagem Orientada a Objetos ou que Elixir √© uma linguagem funcional, vai dar uma luz na hora de pensar o que voc√™ pode fazer.</p>

<p>J√° a segunda pergunta vai te dar uma resposta bem √≥bvia. Joga ‚Äú<linguagem> syntax" no Google e veja o resultado. Fiz o experimento e aqui est√£o as duas primeiras resposta em ordem:</linguagem></p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Java syntax</code>
    <ol>
      <li><a href="https://www.w3schools.com/java/java_syntax.asp">W3 Schools: Java Syntax</a> ‚Üê LEIA ESSE!!!!</li>
      <li><a href="https://docs.oracle.com/javase/specs/jls/se7/html/jls-18.html">Especifica√ß√£o do Java Chapter 18. Syntax</a> ‚Üê Se quiser ir a fundo, depois de 10 anos de experi√™ncia, leia esse.</li>
    </ol>
  </li>
  <li><code class="language-plaintext highlighter-rouge">golang syntax</code>
    <ol>
      <li><a href="https://www.w3schools.com/go/go_syntax.php">W3 Schools: Go Syntax</a> ‚Üê LEIA ESSE!!!!</li>
      <li><a href="https://go.dev/ref/spec">Especifica√ß√£o do GO</a> ‚Üê Se quiser ir a fundo, depois de 10 anos de experi√™ncia, leia esse.</li>
    </ol>
  </li>
</ol>

<p>De posse de um tutorial sobre a sintaxe, v√° experimentado a linguagem, tentando entender cada passo.</p>

<h2 id="6-fa√ßa-exemplos-simples">6. Fa√ßa exemplos simples</h2>

<p>Existem in√∫meros sites com exemplos que podem te ensinar a programar. Abra o <a href="https://exercism.org/">exercism</a>, <a href="https://www.codewars.com/">codewars.com</a> ou <a href="https://www.hackerrank.com/">hackerrank.com</a> e vai aprendendo. N√£o tente fazer um servidor web de inicio, isso s√≥ vai fazer voc√™ desistir.</p>

<p>V√° no exemplo simples. Comece com o programa que pergunta a sua idade e imprime com uma mensagem bonita. Depois escreva um programa que pergunta um n√∫mero e imprime o valor do fatorial dele, ou imprime n√∫mero na sequ√™ncia fibonacci na posi√ß√£o do n√∫mero. Depois fa√ßa um programa que l√™ um arquivo e verifica se os <code class="language-plaintext highlighter-rouge">(</code>, <code class="language-plaintext highlighter-rouge">[</code> e <code class="language-plaintext highlighter-rouge">{</code> est√£o corretamente definidos.</p>

<p>Evite usar a biblioteca da linguagem a principio, v√° implementando na m√£o cada passo. Programar √© aprender e aprender envolve desafio. Sem desafio voc√™ n√£o vai muito longe n√£o, vai estagnar.</p>

<h2 id="7-livros-√©-bom">7. Livros √© bom?</h2>

<p>Livros s√£o excelentes, mas √© preciso ter calma para escolher um livro bom. Em muitos casos os livros s√£o verborr√°gicos e est√£o bem ultrapassados. Evite comprar livros muito caros a principio, a n√£o ser que algu√©m de confian√ßa tenha te indicado.</p>

<p>Prefira baixar o livro, quem sabe voc√™ n√£o encontra ele por a√≠.</p>

<h2 id="8-curso-√©-bom">8. Curso √© bom?</h2>

<p>Tamb√©m v√° com calma! Escolha bem o curso antes de comprar. Existe muito picareta no mercado. Escolha muito bem o curso e a dica que eu te dou √© evitar promessas miraculosas e escolher aquele que d√° um bom acompanhamento. Se o material do curso s√≥ for liberado depois do s√©timo dia, cancela!!!! Isso acontece porque n√£o existe material, o vendendor do curso est√° esperando vencer o prazo de cancelamento do curso para te mostrar que voc√™ foi engando.</p>]]></content><author><name>{&quot;twitter&quot;=&gt;&quot;vepo&quot;, &quot;linkedin&quot;=&gt;&quot;https://www.linkedin.com/in/victorosorio/&quot;, &quot;picture&quot;=&gt;&quot;/assets/images/me.avif&quot;}</name></author><category term="Como aprender a programar" /><category term="Dicas para iniciantes" /><category term="Java" /><category term="Comunidade" /><summary type="html"><![CDATA[Um guia pr√°tico com dicas essenciais para quem est√° come√ßando na programa√ß√£o, desde entender o que √© programar at√© escolher a IDE certa e evitar armadilhas comuns. Baseado em anos de experi√™ncia e observa√ß√µes de iniciantes nas redes sociais.]]></summary></entry><entry><title type="html">Sotaques e flu√™ncia em linguagens de programa√ß√£o</title><link href="https://blog.vepo.dev/posts/sotaques-e-fluencia-em-linguagens-de-programacao" rel="alternate" type="text/html" title="Sotaques e flu√™ncia em linguagens de programa√ß√£o" /><published>2025-08-28T00:00:00+00:00</published><updated>2025-08-28T00:00:00+00:00</updated><id>https://blog.vepo.dev/posts/09-49-00-java-language</id><content type="html" xml:base="https://blog.vepo.dev/posts/sotaques-e-fluencia-em-linguagens-de-programacao"><![CDATA[<p>Linguagens de programa√ß√£o s√£o uma forma de express√£o, da mesma forma que as linguas falantes. Elas possuem uma comunidade e, em consegu√™ncia, uma cultura associada. Dessa forma, podemos concluir que cada linguagem possui sua pr√≥pria ‚Äúpersonalidade‚Äù - um conjunto de conven√ß√µes, padr√µes e estilos que constituem sua express√£o idiom√°tica. Eu sempre digo que todo c√≥digo √© idiom√°tico, s√≥ precisamos descobri qual idioma ele est√° expressando. Escrever c√≥digo idiom√°tico significa n√£o apenas fazer funcionar, mas fazer da maneira que a comunidade daquela linguagem espera e valoriza.</p>

<h2 id="o-que-s√£o-padr√µes-idiom√°ticos">O que s√£o Padr√µes Idiom√°ticos?</h2>

<p>Padr√µes idiom√°ticos s√£o conven√ß√µes estabelecidas pela comunidade que tornam o c√≥digo mais leg√≠vel, maintainable e alinhado com a filosofia da linguagem. √â a diferen√ßa entre simplesmente falar uma l√≠ngua e fal√°-la com flu√™ncia nativa.</p>

<h2 id="java-a-linguagem-corporativa-por-excel√™ncia">Java: A Linguagem Corporativa por Excel√™ncia</h2>

<p>Java surgiu em 1995 com o mantra ‚ÄúWrite Once, Run Anywhere‚Äù e rapidamente se estabeleceu como a linguagem preferida para aplica√ß√µes empresariais. Sua filosofia valoriza:</p>

<ul>
  <li><strong>Clareza acima de brevidade</strong></li>
  <li><strong>Manutenibilidade a longo prazo</strong></li>
  <li><strong>Robustez e seguran√ßa</strong></li>
  <li><strong>Compatibilidade reversa</strong></li>
</ul>

<h2 id="como-escrever-c√≥digo-java-idiom√°tico">Como Escrever C√≥digo Java Idiom√°tico</h2>

<h3 id="1-conven√ß√µes-de-nomenclatura">1. Conven√ß√µes de Nomenclatura</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Classes e interfaces: PascalCase</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerService</span> <span class="kd">implements</span> <span class="nc">Validatable</span> <span class="o">{</span>
    
    <span class="c1">// Constantes: UPPER_SNAKE_CASE</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MAX_RETRY_ATTEMPTS</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DEFAULT_TIMEZONE</span> <span class="o">=</span> <span class="s">"UTC"</span><span class="o">;</span>
    
    <span class="c1">// Vari√°veis e m√©todos: camelCase</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">customerName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">pendingOrders</span><span class="o">;</span>
    
    <span class="c1">// M√©todos devem ser verbos</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processOrder</span><span class="o">(</span><span class="nc">Order</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">validateOrder</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
        <span class="n">calculateTotal</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
        <span class="n">persistOrder</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="c1">// M√©todos booleanos geralmente come√ßam com "is", "has", "can"</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValidCustomer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">customerName</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">customerName</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="2-estrutura-de-classes-e-pacotes">2. Estrutura de Classes e Pacotes</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Ordem recomendada dentro de uma classe:</span>
<span class="c1">// 1. Vari√°veis est√°ticas</span>
<span class="c1">// 2. Vari√°veis de inst√¢ncia</span>
<span class="c1">// 3. Construtores</span>
<span class="c1">// 4. M√©todos</span>

<span class="kn">package</span> <span class="nn">com.empresa.projeto.modulo.service</span><span class="o">;</span> <span class="c1">// Pacotes em lowercase</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Entity</span><span class="o">;</span>

<span class="c1">// Uma classe por arquivo, nome do arquivo = nome da classe</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderProcessor</span> <span class="o">{</span>
    
    <span class="c1">// Campos primeiro</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">OrderRepository</span> <span class="n">orderRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">NotificationService</span> <span class="n">notificationService</span><span class="o">;</span>
    
    <span class="c1">// Inje√ß√£o de depend√™ncias via construtor</span>
    <span class="kd">public</span> <span class="nf">OrderProcessor</span><span class="o">(</span><span class="nc">OrderRepository</span> <span class="n">orderRepository</span><span class="o">,</span> 
                         <span class="nc">NotificationService</span> <span class="n">notificationService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">orderRepository</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">notificationService</span> <span class="o">=</span> <span class="n">notificationService</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="c1">// M√©todos p√∫blicos primeiro, depois privados</span>
    <span class="kd">public</span> <span class="nc">ProcessingResult</span> <span class="nf">processBatch</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">orders</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">validateOrders</span><span class="o">(</span><span class="n">orders</span><span class="o">);</span>
        <span class="k">return</span> <span class="nf">internalProcess</span><span class="o">(</span><span class="n">orders</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="nc">ProcessingResult</span> <span class="nf">internalProcess</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">orders</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Implementa√ß√£o</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="3-tratamento-de-exce√ß√µes">3. Tratamento de Exce√ß√µes</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentService</span> <span class="o">{</span>
    
    <span class="c1">// Use exce√ß√µes espec√≠ficas</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processPayment</span><span class="o">(</span><span class="nc">Payment</span> <span class="n">payment</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">PaymentProcessingException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">validatePayment</span><span class="o">(</span><span class="n">payment</span><span class="o">);</span>
            <span class="n">gateway</span><span class="o">.</span><span class="na">charge</span><span class="o">(</span><span class="n">payment</span><span class="o">);</span>
            <span class="n">logSuccess</span><span class="o">(</span><span class="n">payment</span><span class="o">);</span>
            
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InvalidPaymentException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Exce√ß√µes de neg√≥cio - geralmente unchecked</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">PaymentProcessingException</span><span class="o">(</span><span class="s">"Pagamento inv√°lido"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">GatewayTimeoutException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Exce√ß√µes t√©cnicas - possivelmente checked</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">PaymentProcessingException</span><span class="o">(</span><span class="s">"Timeout no gateway"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">// Sempre libere recursos no finally</span>
            <span class="n">cleanupResources</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="c1">// Prefira exce√ß√µes unchecked para erros de programa√ß√£o</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">validatePayment</span><span class="o">(</span><span class="nc">Payment</span> <span class="n">payment</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">payment</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Payment cannot be null"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="4-uso-de-collections-e-streams-api">4. Uso de Collections e Streams API</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderAnalyzer</span> <span class="o">{</span>
    
    <span class="c1">// Prefira interfaces sobre implementa√ß√µes</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="nf">filterActiveOrders</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">orders</span><span class="o">)</span> <span class="o">{</span>
        
        <span class="c1">// Java moderno: use Streams API para processamento</span>
        <span class="k">return</span> <span class="n">orders</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
            <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="nl">Order:</span><span class="o">:</span><span class="n">isActive</span><span class="o">)</span>          <span class="c1">// Method reference</span>
            <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">order</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">order</span><span class="o">.</span><span class="na">isExpired</span><span class="o">())</span> <span class="c1">// Lambda expression</span>
            <span class="o">.</span><span class="na">sorted</span><span class="o">(</span><span class="nc">Comparator</span><span class="o">.</span><span class="na">comparing</span><span class="o">(</span><span class="nl">Order:</span><span class="o">:</span><span class="n">getCreatedDate</span><span class="o">)</span>
            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>    <span class="c1">// Coletor idiom√°tico</span>
    <span class="o">}</span>
    
    <span class="c1">// Use factories para criar collections</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;&gt;</span> <span class="nf">groupOrdersByCategory</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">orders</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;&gt;</span> <span class="n">grouped</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        
        <span class="k">for</span> <span class="o">(</span><span class="nc">Order</span> <span class="n">order</span> <span class="o">:</span> <span class="n">orders</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// ComputeIfAbsent √© idiom√°tico para agrupamento</span>
            <span class="n">grouped</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getCategory</span><span class="o">(),</span> <span class="n">k</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;())</span>
                  <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
        <span class="o">}</span>
        
        <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">unmodifiableMap</span><span class="o">(</span><span class="n">grouped</span><span class="o">);</span> <span class="c1">// Retorne views imut√°veis</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="5-gerenciamento-de-recursos-com-try-with-resources">5. Gerenciamento de Recursos com try-with-resources</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileProcessor</span> <span class="o">{</span>
    
    <span class="c1">// Sempre use try-with-resources para recursos que precisam ser fechados</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">readFile</span><span class="o">(</span><span class="nc">String</span> <span class="n">filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileReader</span><span class="o">(</span><span class="n">filename</span><span class="o">)))</span> <span class="o">{</span>
            <span class="nc">StringBuilder</span> <span class="n">content</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
            <span class="nc">String</span> <span class="n">line</span><span class="o">;</span>
            
            <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">content</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">line</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
            <span class="o">}</span>
            
            <span class="k">return</span> <span class="n">content</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="o">}</span> <span class="c1">// BufferedReader √© automaticamente fechado aqui</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="6-imutabilidade-e-records">6. Imutabilidade e Records</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Prefira imutabilidade onde poss√≠vel</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ImmutableCustomer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tags</span><span class="o">;</span> <span class="c1">// Defensiva para collections</span>
    
    <span class="kd">public</span> <span class="nf">ImmutableCustomer</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">email</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tags</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tags</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">tags</span><span class="o">));</span>
    <span class="o">}</span>
    
    <span class="c1">// Apenas getters, sem setters</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getTags</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">tags</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Java 14+: Use records para DTOs imut√°veis</span>
<span class="kd">public</span> <span class="n">record</span> <span class="nf">CustomerRecord</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">email</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tags</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Construtor compacto para valida√ß√£o</span>
    <span class="kd">public</span> <span class="nc">CustomerRecord</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">name</span><span class="o">.</span><span class="na">isBlank</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Name cannot be blank"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="nc">List</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">tags</span><span class="o">);</span> <span class="c1">// Garante imutabilidade</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="7-padr√µes-de-projeto-idiom√°ticos">7. Padr√µes de Projeto Idiom√°ticos</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Builder pattern para objetos complexos</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerBuilder</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">phone</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nc">CustomerBuilder</span> <span class="nf">setName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nc">Customer</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Customer</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">email</span><span class="o">,</span> <span class="n">phone</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Factory method pattern</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PaymentProcessor</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="nc">PaymentProcessor</span> <span class="nf">create</span><span class="o">(</span><span class="nc">String</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">case</span> <span class="s">"creditcard"</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">CreditCardProcessor</span><span class="o">();</span>
            <span class="k">case</span> <span class="s">"paypal"</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">PayPalProcessor</span><span class="o">();</span>
            <span class="k">default</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span><span class="s">"Unknown processor type: "</span> <span class="o">+</span> <span class="n">type</span><span class="o">);</span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="8-anota√ß√µes-e-metadados">8. Anota√ß√µes e Metadados</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Use anota√ß√µes consistentemente</span>
<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/api/customers"</span><span class="o">)</span>
<span class="nd">@Validated</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerController</span> <span class="o">{</span>
    
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/{id}"</span><span class="o">)</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">CustomerResponse</span> <span class="nf">getCustomer</span><span class="o">(</span>
            <span class="nd">@PathVariable</span> <span class="nd">@Min</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span>
            <span class="nd">@RequestParam</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span> <span class="nc">String</span> <span class="n">expand</span><span class="o">)</span> <span class="o">{</span>
        
        <span class="k">return</span> <span class="n">customerService</span><span class="o">.</span><span class="na">findCustomerById</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">expand</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@PostMapping</span>
    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">CREATED</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">CustomerResponse</span> <span class="nf">createCustomer</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nd">@Valid</span> <span class="nc">CustomerRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">customerService</span><span class="o">.</span><span class="na">createCustomer</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="boas-pr√°ticas-adicionais">Boas Pr√°ticas Adicionais</h2>

<ol>
  <li><strong>Documenta√ß√£o</strong>: Use Javadoc consistentemente</li>
  <li><strong>Testes</strong>: Junit 5 com nomes descritivos</li>
  <li><strong>Logging</strong>: Use SLF4J com logs significativos</li>
  <li><strong>Null Safety</strong>: Use Optional para retornos potencialmente nulos</li>
  <li><strong>Performance</strong>: Evite otimiza√ß√£o prematura, mas conhe√ßa o custo das opera√ß√µes</li>
</ol>

<h2 id="conclus√£o">Conclus√£o</h2>

<p>Escrever c√≥digo Java idiom√°tico vai al√©m da sintaxe correta. √â sobre entender a cultura Java: valorizar clareza, robustez e maintainability. √â escrever c√≥digo que n√£o apenas funciona, mas que comunica claramente sua inten√ß√£o para outros desenvolvedores Java.</p>

<p>O c√≥digo Java idiom√°tico √© como um bom documento legal: preciso, completo e sem ambiguidades. Pode n√£o ser o mais conciso, mas √© certamente um dos mais leg√≠veis e maintainable quando feito corretamente.</p>

<p>Lembre-se: o c√≥digo √© lido muitas mais vezes do que escrito. Escreva para o leitor, n√£o apenas para o compilador.</p>]]></content><author><name>{&quot;twitter&quot;=&gt;&quot;vepo&quot;, &quot;linkedin&quot;=&gt;&quot;https://www.linkedin.com/in/victorosorio/&quot;, &quot;picture&quot;=&gt;&quot;/assets/images/me.avif&quot;}</name></author><category term="Java" /><summary type="html"><![CDATA[Cada linguagem de programa√ß√£o possui um sotque espec√≠fico e √© f√°cil identificar quando um desenvoledor de outra linguagem n√£o busca conhecer a cultura e os padr√µes de uma linguagem. Mas esse comportamento n√£o √© um mero preciosismo est√©tico, bugs podem aparecer ao n√£o se atentar para a maneira como as coisas s√£o feitas.]]></summary></entry><entry><title type="html">Como gerar flamegraph em aplica√ß√µes Java</title><link href="https://blog.vepo.dev/posts/como-gerar-flamegraph-na-jvm" rel="alternate" type="text/html" title="Como gerar flamegraph em aplica√ß√µes Java" /><published>2025-02-24T00:00:00+00:00</published><updated>2025-02-24T00:00:00+00:00</updated><id>https://blog.vepo.dev/posts/07-59-00-como-gerar-flamegraph-em-java</id><content type="html" xml:base="https://blog.vepo.dev/posts/como-gerar-flamegraph-na-jvm"><![CDATA[<div class="paragraph">
<p>Profiling tem sido uma das minhas principais atividades nos √∫ltimos meses. Como a aplica√ß√£o que eu trabalho chegou a um bom grau de
maturidade onde h√° poucas funcionalidades a sere feitas e os bugs de produ√ß√£o s√£o raros, hoje o principal esfor√ßo √© melhorar o desempenho
e reduzir o uso de recursos. Por isso muito se pede para investigar o uso de CPU ou reduzir o tempo de processamento, o que me levou a
estudar com se d√° o uso da CPU em produ√ß√£o e como funciona internamente o Kafka Stream.</p>
</div>
<div class="paragraph">
<p>√â nesse contexto que resolvi finalmente investir um tempo para tentar gerar um diagrama muito interessante chamado Flamegraph. Caso voc√™
ainda n√£o o conhe√ßa, vamos primeiro falar sobre ele e depois mostrar como voc√™ pode gerar ele na sua aplica√ß√£o Java facilmente!</p>
</div>
<div class="sect1">
<h2 id="_o-flamegraph">O Flamegraph</h2>
<div class="sectionbody">
<div class="paragraph">
<p>O Flamegraph √© um diagrama de monitoramento do uso da CPU <a href="https://www.brendangregg.com/flamegraphs.html">criado por Brendan Gregg</a> enquanto trabalhava
investigando problemas de performance no MySQL. Caso voc√™ queira ler a descri√ß√£o do pr√≥prio criador, recomendo um post no site pessoal dele
<a href="https://www.brendangregg.com/flamegraphs.html">Flame Graphs</a> e um artigo na Communications da ACM chamado
<a href="https://cacm.acm.org/practice/the-flame-graph/">The Flame Graph</a>.</p>
</div>
<div id="cpu-mysql-updated" class="imageblock text-center text-center">
<div class="content">
<img src="/assets/images/cpu-mysql-updated.svg" alt="cpu mysql updated">
</div>
<div class="title">Figura 1. Flamegraph do uso de CPU do MySQL</div>
</div>
<div class="paragraph">
<p>A informa√ß√£o provida pelo flamegraph pode n√£o parecer nova, ela j√° era provida por diversas ferramentas de profiling, mas a forma de intera√ß√£o
com o dado √© mais interessante e dos d√° mais informa√ß√µes sobre o que realmente acontece em tempo de execu√ß√£o. O VisualVM j√° prov√™ informa√ß√£o semelhante,
mas a forma que ela √© exibida, apesar de mais acurada, torna dif√≠cil visualizar o real uso da CPU. As ferramentas tradicionais agrupavam o uso de CPUs por
<em>threads</em>, como √© visto na imagem abaixo. Conseguimos ver o uso de cada thread, o que de certa forma est√° parcialmente certo, mas dificulta a visualiza√ß√£o
pois n√£o vemos o dado real por CPU.</p>
</div>
<div id="visualvm-cpu-profiling" class="imageblock text-center text-center">
<div class="content">
<img src="/assets/images/java/visualvm-cpu-profiling.png" alt="visualvm cpu profiling">
</div>
<div class="title">Figura 2. Profiling da CPU pelo VisualVM.</div>
</div>
<div class="paragraph">
<p>Pode parecer estranho o que vou afirmar aqui, mas <em>threads</em> n√£o existem! <em>Threads</em> s√£o uma abstra√ß√£o do Sistema Operacional que facilitam o desenvolvimento de
software ao tratar o paralelismo como uma necessidade b√°sica. Para entender melhor essa afirma√ß√£o temos que entender que CPU √© um recurso do nosso sistema que √©
compartilhado entre as diversas <em>threads</em>. O que o flamegraph faz √© mostrar todo o uso de CPU ignorando a exist√™ncia de <em>threads</em> e isso ajuda muito na visualiza√ß√£o!</p>
</div>
<div class="paragraph">
<p>Ao afirmar the <em>threads</em> n√£o existem n√£o estou dizendo que voc√™ n√£o deva abolir <em>threads</em>, muito pelo contr√°rio. Mas muitas vezes o processamento que est√° distribu√≠do
em diversas <em>threads</em> √© implementado pelo memso c√≥digo. Vamos pensar no Kafka Stream! N√≥s normalmente implementamos uma pipeline que √© √∫nica e ser√° executada pela
<em>StreamThread</em>. Uma aplica√ß√£o em produ√ß√£o ter√° diversas <em>StreamThread</em> executando o mesmo c√≥digo! Quando olhamos para o VisualVM, temos que optar por uma dessas
<em>StreamThread</em>, enquanto ao olharmos para o flamegraph, vemos todas as <em>StreamThreads</em>!!!</p>
</div>
<div class="paragraph">
<p>Isso acontece porque ao se colocar todo o tempo de CPU em um √∫nico eixo, facilita-se a visualiza√ß√£o. O flamegraph reduz o n√∫mero de vari√°veis a se considerar para
se extrair um dado simples: tempo de CPU!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_como-extrair-o-flamegraph">Como extrair o Flamegraph?!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Se voc√™ fizer essa pesquisa no Google, j√° aviso que se deparar√° com diversos posts com muita informa√ß√£o antiga e pouca compara√ß√£o. Ver√° posts onde s√≥ se usou
as ferramentas de performance do Linux, outros posts usando somente o Java Flight Recorder e outros posts usando agentes nativos que integram c√≥digo Java com
as ferramentas nativas do Linux. Nesse post eu vou mostrar como exatrair de duas formas e depois comparar os resultados obtidos por ambas as formas.</p>
</div>
<div class="sect2">
<h3 id="_extraindo-usando-apenas-o-java-flight-recorder">Extraindo usando apenas o Java Flight Recorder!</h3>
<div class="paragraph">
<p>A primeira forma de se extrair o flamegraph √© pegar as informa√ß√µes necess√°rias usando apenas ferramentas providas pela JVM e depois processar essa informa√ß√µes
criando o framegraph. A JVM j√° prov√™ uma s√©rie de ferramentas de profiling que est√£o dentro do JDK. Se voc√™ n√£o conhece o comando <code>jcmd</code> recomendo parar tudo que
est√° fazendo e dar uma olhada nele. <a href="https://docs.oracle.com/en/java/javase/21/docs/specs/man/jcmd.html">Na documenta√ß√£o do <code>jcmd</code></a> voc√™ consegue encontrar a
descri√ß√£o de todo comandos que voc√™ pode executar s√≥ passando o PID da JVM que voc√™ quer olhar.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> jcmd MyProgram <span class="nb">help</span> <span class="o">(</span>or <span class="s2">"jcmd 2125 help"</span><span class="o">)</span>
2125:
The following commands are available:
JFR.stop
JFR.start
JFR.dump
JFR.check
VM.native_memory
VM.check_commercial_features
VM.unlock_commercial_features
ManagementAgent.stop
ManagementAgent.start_local
ManagementAgent.start
Thread.print
GC.class_stats
GC.class_histogram
GC.heap_dump
GC.run_finalization
GC.run
VM.uptime
VM.flags
VM.system_properties
VM.command_line
VM.version
<span class="nb">help</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para gerar o flamegraph independentemente do m√©todo, voc√™ precisar√° do <a href="https://github.com/async-profiler/async-profiler"><strong>async-profiler</strong></a>. √â uma excelente
ferramenta que gera o flamegraph a partir da grava√ß√£o do Java Flight Recorder e tamb√©m gera usando o agente nativo.</p>
</div>
<div class="paragraph">
<p>Nesse primeiro m√©todo vamos usar o Java Flight Recorder para gravar as informa√ß√µes de execu√ß√£o e depois gerar o flamegraph, para gravar as informa√ß√µes voc√™
pode usar os dois m√©todos abaixos, ambos foram extra√≠dos de scripts de profile que eu uso. No primeiro eu inicio a grava√ß√£o, depois gero trafego (o qual foi
substitu√≠do pelo <code>sleep</code>) e por fim finalizo a grava√ß√£o. A vantagem desse m√©todo √© que voc√™ grava somente o periodo em que o trafego foi gerado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">DURATION</span><span class="o">=</span>1200 <span class="c">## 2 minutos</span>
<span class="nb">rm</span> <span class="nt">-f</span> /tmp/recording.jfr                                            <span class="c">## Apaga grava√ß√µes antigas que podem ter sido feitas</span>
<span class="nv">NAME</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat</span> /dev/urandom | <span class="nb">tr</span> <span class="nt">-dc</span> <span class="s1">'a-zA-Z'</span> | <span class="nb">fold</span> <span class="nt">-w</span> 15 | <span class="nb">head</span> <span class="nt">-n</span> 1<span class="si">)</span> <span class="c">## Gera um nome aleat√≥rio para evitar conflitos</span>
<span class="nv">PID</span><span class="o">=</span><span class="si">$(</span>ps <span class="nt">-a</span> | <span class="nb">grep </span>java | <span class="nb">awk</span> <span class="s1">'{print $1}'</span><span class="si">)</span>                         <span class="c">## Acessa n√∫mero do processo em execu√ß√£o se rodando em docker/k8s</span>
jcmd <span class="nv">$PID</span> JFR.start <span class="nv">name</span><span class="o">=</span><span class="nv">$NAME</span> <span class="nv">settings</span><span class="o">=</span>profile                     <span class="c">## Inicia grava√ß√£o</span>
<span class="nb">sleep</span> <span class="nv">$DURATION</span>
jcmd <span class="nv">$PID</span> JFR.stop <span class="nv">name</span><span class="o">=</span><span class="nv">$NAME</span> <span class="nv">filename</span><span class="o">=</span>/tmp/recording.jfr</code></pre>
</div>
</div>
<div class="paragraph">
<p>No segundo m√©todo, o <code>jcmd</code> √© executado de forma asincrona usando os par√¢metros <code>duration</code> e <code>delay</code>. Esse m√©todo √© bom para capturar informa√ß√µes
do ambiente de produ√ß√£o sem precisar reiniciar o servidor.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">DELAY</span><span class="o">=</span>10m
<span class="nv">DURATION</span><span class="o">=</span>20m
<span class="nb">rm</span> <span class="nt">-f</span> /tmp/recording.jfr                                                        <span class="c">## Apaga grava√ß√µes antigas que podem ter sido feitas</span>
<span class="nv">NAME</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat</span> /dev/urandom | <span class="nb">tr</span> <span class="nt">-dc</span> <span class="s1">'a-zA-Z'</span> | <span class="nb">fold</span> <span class="nt">-w</span> 15 | <span class="nb">head</span> <span class="nt">-n</span> 1<span class="si">)</span>             <span class="c">## Gera um nome aleat√≥rio para evitar conflitos</span>
<span class="nv">PID</span><span class="o">=</span><span class="si">$(</span>ps <span class="nt">-a</span> | <span class="nb">grep </span>java | <span class="nb">awk</span> <span class="s1">'{print $1}'</span><span class="si">)</span>                                     <span class="c">## Acessa n√∫mero do processo em execu√ß√£o se rodando em docker/k8s</span>
jcmd <span class="nv">$PID</span> JFR.start <span class="nv">name</span><span class="o">=</span><span class="nv">$NAME</span> <span class="nv">settings</span><span class="o">=</span>profile <span class="nv">delay</span><span class="o">=</span><span class="nv">$DELAY</span> <span class="nv">duration</span><span class="o">=</span><span class="nv">$DURATION</span> <span class="c">## Inicia grava√ß√£o</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Depois de capturado o arquivo <code>recording.jfr</code>, voc√™ precisa gerar o flamegraph usando o
<a href="https://github.com/async-profiler/async-profiler/releases/download/v3.0/converter.jar">converter</a> do async-profile.
Para isso execute o comando abaixo e <em>voil√†</em>!!! Voc√™ tem uma pagina HTML pura para colocar onde quiser. Eu coloquei ela como
artefato dos testes de carga da aplica√ß√£o.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">java <span class="nt">-cp</span> converter.jar jfr2flame <span class="nt">--dot</span> <span class="nt">--total</span> <span class="nt">--alloc</span> <span class="nt">--classify</span> <span class="nt">--title</span> <span class="s2">"My CPU Profile"</span> /tmp/recording.jfr /tmp/flamegraph.html</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 1. Aviso</div>
<div class="content">
<div class="paragraph">
<p>O tamanho do arquivo gerado ser√° proporcional ao tempo de grava√ß√£o, por isso garanta que h√° espa√ßo em disco
e use sabiamente a dura√ß√£o (<em>duration</em>) e o atrado (<em>delay</em>) para capturar o melhor momento da execu√ß√£o.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_extraindo-usando-agente-nativo">Extraindo usando agente nativo</h3>
<div class="paragraph">
<p>A grande desvantagem de usar somente o Java Flight Recorder √© que algumas informa√ß√µes sobre a execu√ß√£o nativa √© perdida. Ao migrar para
a execu√ß√£o usando o agente nativo consegui, por exemplo, identificar alguns trechos de c√≥digo que usavam <strong>exceptions para controle de fluxo
o que pode ser um grande problema de desempenho</strong>.</p>
</div>
<div class="paragraph">
<p>Para executar usando agente natvo com o <a href="https://github.com/async-profiler/async-profiler"><strong>async-profiler</strong></a>, basta fazer o download da buil,
copiar para o ambiente de execu√ß√£o e depois executar o comando <code>asprof</code> como mostrado abaixo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">DURATION</span><span class="o">=</span>1200
<span class="nv">PID</span><span class="o">=</span><span class="si">$(</span>ps <span class="nt">-a</span> | <span class="nb">grep </span>java | <span class="nb">awk</span> <span class="s1">'{print $1}'</span><span class="si">)</span>                                                <span class="c">## Acessa n√∫mero do processo em execu√ß√£o se rodando em docker/k8s</span>
/tmp/async-profiler-3.0-linux-x64/bin<span class="p">;</span> ./asprof <span class="nt">-d</span> <span class="nv">$DURATION</span> <span class="nt">-f</span> /tmp/flamegraph.html <span class="nv">$PID</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A desvantagem desse m√©todo √© que voc√™ alterou o ambiente em que o seu software est√° rodando. Isso n√£o tem problemas na grande maioria dos casos,
mas n√£o √© muito bem visto para ambientes de produ√ß√£o.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recomenda√ß√µes">Recomenda√ß√µes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Eu recomendo que voc√™ use constantemente ferramentas de profiling para visualizar o que est√° acontecendo no seu software. Existe uma m√°xima na √°rea
de adminstra√ß√£o que pode ser aplicada em qualquer lugar das nossa vidas "o que n√£o pode ser medido, n√£o pode ser gerenciado", logo √© importante para
voc√™ saber como est√° o tempo de execu√ß√£o do seu software.</p>
</div>
<div class="paragraph">
<p>A segunda recomenda√ß√£o √© voc√™, caso precise melhorar o desempenho do seu software, olhar primeiro para o local que mais impacta o desemepenho. Ganho
de performance √© proprocional ao tempo de desempenho, por isso s√≥ investa tempo onde h√° mais indicios de tempo gasto.</p>
</div>
<div class="paragraph">
<p>Uma outra recomenda√ß√£o √© que voc√™ pode criar ferramentas de an√°lise de desempenho automatizadas usando ferramentas de DevOps. Quem sabe criar uma task no
Jenkins que extrai o FlameGraph e depois salva para an√°lises futuras? Ou salvar essa p√°gina para cada nova vers√£o e comparar como o desempenho tem evoluido?</p>
</div>
<div class="paragraph">
<p>Eu espero ter ajuda com alguma coisa!</p>
</div>
</div>
</div>]]></content><author><name>{&quot;twitter&quot;=&gt;&quot;vepo&quot;, &quot;linkedin&quot;=&gt;&quot;https://www.linkedin.com/in/victorosorio/&quot;, &quot;picture&quot;=&gt;&quot;/assets/images/me.avif&quot;}</name></author><category term="Java" /><category term="Observabilidade" /><category term="Profiling" /><category term="Tuning" /><category term="JVM" /><category term="Flamegraph" /><summary type="html"><![CDATA[J√° ouviu falar de Flamegraph? E quais ferramentas de profiling voc√™ usa? Nesse post vamos falar de como podemos ver qual √© o uso da CPU em produ√ß√£o de uma aplica√ß√£o rodando na JVM usando ferramentas simples e um √≥timo formato de visualiza√ß√£o.]]></summary></entry><entry><title type="html">Entendendo equals(), hashCode() e Collections em Java</title><link href="https://blog.vepo.dev/posts/java-collections-equals-hashcode" rel="alternate" type="text/html" title="Entendendo equals(), hashCode() e Collections em Java" /><published>2024-01-09T00:00:00+00:00</published><updated>2024-01-09T00:00:00+00:00</updated><id>https://blog.vepo.dev/posts/14-13-46-java-collections-equals-hashcode</id><content type="html" xml:base="https://blog.vepo.dev/posts/java-collections-equals-hashcode"><![CDATA[<p>Neste post, vamos explorar os conceitos fundamentais de <code class="language-plaintext highlighter-rouge">equals()</code>, <code class="language-plaintext highlighter-rouge">hashCode()</code> e como eles s√£o utilizados em estruturas de dados como <code class="language-plaintext highlighter-rouge">HashSet</code> e <code class="language-plaintext highlighter-rouge">HashMap</code> no Java. Al√©m disso, discutiremos a import√¢ncia da imutabilidade e como implementar esses m√©todos corretamente.</p>

<hr />
<iframe width="560" height="315" src="https://www.youtube.com/embed/-ATMYvny-7Y" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
<hr />

<h2 id="introdu√ß√£o-ao-java-collections">Introdu√ß√£o ao Java Collections</h2>

<p>O pacote <code class="language-plaintext highlighter-rouge">java.util.Collections</code> √© uma biblioteca padr√£o do Java que fornece implementa√ß√µes de estruturas de dados comuns, como listas, conjuntos e mapas. Essas estruturas s√£o essenciais para o desenvolvimento eficiente em Java, pois eliminam a necessidade de implementar solu√ß√µes personalizadas para problemas recorrentes.</p>

<hr />

<h2 id="contratos-em-java">Contratos em Java</h2>

<p>Em Java, os contratos s√£o regras documentadas que definem como determinados m√©todos devem se comportar. Diferentemente de outras linguagens, o Java n√£o possui um mecanismo embutido para valida√ß√£o de contratos, mas a documenta√ß√£o √© clara sobre as expectativas. Dois dos contratos mais importantes s√£o os m√©todos <code class="language-plaintext highlighter-rouge">equals()</code> e <code class="language-plaintext highlighter-rouge">hashCode()</code>, herdados da classe <code class="language-plaintext highlighter-rouge">Object</code>.</p>

<h3 id="regras-para-equals">Regras para <code class="language-plaintext highlighter-rouge">equals()</code></h3>
<ol>
  <li><strong>Reflexividade</strong>: Um objeto deve ser igual a si mesmo.</li>
  <li><strong>Simetria</strong>: Se <code class="language-plaintext highlighter-rouge">A.equals(B)</code> √© <code class="language-plaintext highlighter-rouge">true</code>, ent√£o <code class="language-plaintext highlighter-rouge">B.equals(A)</code> tamb√©m deve ser <code class="language-plaintext highlighter-rouge">true</code>.</li>
  <li><strong>Transitividade</strong>: Se <code class="language-plaintext highlighter-rouge">A.equals(B)</code> e <code class="language-plaintext highlighter-rouge">B.equals(C)</code> s√£o <code class="language-plaintext highlighter-rouge">true</code>, ent√£o <code class="language-plaintext highlighter-rouge">A.equals(C)</code> tamb√©m deve ser <code class="language-plaintext highlighter-rouge">true</code>.</li>
  <li><strong>Consist√™ncia</strong>: O m√©todo deve sempre retornar o mesmo valor, desde que o objeto n√£o seja modificado.</li>
  <li><strong>N√£o-nulidade</strong>: Um objeto nunca deve ser igual a <code class="language-plaintext highlighter-rouge">null</code>.</li>
</ol>

<h3 id="regras-para-hashcode">Regras para <code class="language-plaintext highlighter-rouge">hashCode()</code></h3>
<ol>
  <li><strong>Consist√™ncia</strong>: Deve retornar o mesmo valor para um objeto n√£o modificado.</li>
  <li><strong>Correspond√™ncia com <code class="language-plaintext highlighter-rouge">equals()</code></strong>: Se dois objetos s√£o iguais (<code class="language-plaintext highlighter-rouge">equals()</code> retorna <code class="language-plaintext highlighter-rouge">true</code>), seus <code class="language-plaintext highlighter-rouge">hashCode()</code> devem ser iguais. O inverso n√£o √© necessariamente verdadeiro.</li>
</ol>

<hr />

<h2 id="hashset-e-hashmap">HashSet e HashMap</h2>

<h3 id="hashset">HashSet</h3>
<ul>
  <li>√â uma implementa√ß√£o de <code class="language-plaintext highlighter-rouge">Set</code> que n√£o permite elementos duplicados.</li>
  <li>Utiliza <code class="language-plaintext highlighter-rouge">hashCode()</code> para determinar a posi√ß√£o do elemento em uma tabela interna.</li>
  <li>Em caso de colis√µes (dois objetos com o mesmo <code class="language-plaintext highlighter-rouge">hashCode()</code>), o <code class="language-plaintext highlighter-rouge">equals()</code> √© usado para verificar a igualdade.</li>
</ul>

<h3 id="hashmap">HashMap</h3>
<ul>
  <li>√â uma implementa√ß√£o de <code class="language-plaintext highlighter-rouge">Map</code> que armazena pares chave-valor.</li>
  <li>A chave √© usada para calcular o <code class="language-plaintext highlighter-rouge">hashCode()</code> e determinar a posi√ß√£o na tabela.</li>
  <li>Assim como no <code class="language-plaintext highlighter-rouge">HashSet</code>, colis√µes s√£o resolvidas usando <code class="language-plaintext highlighter-rouge">equals()</code>.</li>
</ul>

<h4 id="exemplo-de-colis√£o">Exemplo de Colis√£o</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">HashSet</span><span class="o">&lt;</span><span class="nc">Objeto</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
<span class="nc">Objeto</span> <span class="n">obj1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Objeto</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="nc">Objeto</span> <span class="n">obj2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Objeto</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span> <span class="c1">// Mesmo hashCode que obj1</span>
<span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">obj1</span><span class="o">);</span>
<span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">obj2</span><span class="o">);</span> <span class="c1">// S√≥ ser√° adicionado se obj1.equals(obj2) for false</span>
</code></pre></div></div>

<hr />

<h2 id="imutabilidade">Imutabilidade</h2>

<p>Objetos imut√°veis s√£o aqueles cujo estado n√£o pode ser alterado ap√≥s a cria√ß√£o. Eles s√£o ideais para uso em <code class="language-plaintext highlighter-rouge">HashSet</code> e <code class="language-plaintext highlighter-rouge">HashMap</code> porque:</p>

<ol>
  <li><strong>Consist√™ncia</strong>: O <code class="language-plaintext highlighter-rouge">hashCode()</code> n√£o muda, evitando comportamentos inesperados.</li>
  <li><strong>Seguran√ßa</strong>: N√£o h√° risco de modificar uma chave ap√≥s inser√ß√£o, o que poderia tornar o valor inacess√≠vel.</li>
</ol>

<h3 id="como-criar-uma-classe-imut√°vel">Como criar uma classe imut√°vel</h3>
<ul>
  <li>Declare todos os campos como <code class="language-plaintext highlighter-rouge">final</code>.</li>
  <li>N√£o forne√ßa m√©todos modificadores (setters).</li>
  <li>Para campos que requerem inicializa√ß√£o tardia (lazy initialization), use campos n√£o <code class="language-plaintext highlighter-rouge">final</code> com cuidado.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Pessoa</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">nome</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">idade</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Pessoa</span><span class="o">(</span><span class="nc">String</span> <span class="n">nome</span><span class="o">,</span> <span class="kt">int</span> <span class="n">idade</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">nome</span> <span class="o">=</span> <span class="n">nome</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">idade</span> <span class="o">=</span> <span class="n">idade</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// Getters, mas sem setters!</span>
<span class="o">}</span>
</code></pre></div></div>

<hr />

<h2 id="implementando-equals-e-hashcode">Implementando <code class="language-plaintext highlighter-rouge">equals()</code> e <code class="language-plaintext highlighter-rouge">hashCode()</code></h2>

<h3 id="usando-a-ide">Usando a IDE</h3>
<p>A maioria das IDEs (como IntelliJ ou Eclipse) pode gerar automaticamente esses m√©todos. Basta selecionar os campos relevantes.</p>

<h3 id="implementa√ß√£o-manual">Implementa√ß√£o manual</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">o</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// Reflexividade</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">Pessoa</span> <span class="n">pessoa</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Pessoa</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">idade</span> <span class="o">==</span> <span class="n">pessoa</span><span class="o">.</span><span class="na">idade</span> <span class="o">&amp;&amp;</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">nome</span><span class="o">,</span> <span class="n">pessoa</span><span class="o">.</span><span class="na">nome</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">hash</span><span class="o">(</span><span class="n">nome</span><span class="o">,</span> <span class="n">idade</span><span class="o">);</span> <span class="c1">// Usa a classe utilit√°ria Objects</span>
<span class="o">}</span>
</code></pre></div></div>

<hr />

<h2 id="conclus√£o">Conclus√£o</h2>

<ol>
  <li><strong>Siga os contratos</strong>: Implemente <code class="language-plaintext highlighter-rouge">equals()</code> e <code class="language-plaintext highlighter-rouge">hashCode()</code> corretamente para evitar bugs.</li>
  <li><strong>Prefira imutabilidade</strong>: Objetos imut√°veis simplificam o uso em <code class="language-plaintext highlighter-rouge">HashSet</code> e <code class="language-plaintext highlighter-rouge">HashMap</code>.</li>
  <li><strong>Use ferramentas</strong>: Aproveite as IDEs para gerar c√≥digo, mas entenda o que est√° sendo gerado.</li>
</ol>

<p>Dominar esses conceitos √© essencial para escrever c√≥digo Java eficiente e livre de erros. Se tiver d√∫vidas, consulte a documenta√ß√£o oficial ou livros como <em>‚ÄúJava Efetivo‚Äù</em> de Joshua Bloch.</p>

<p><strong>Palavras-chave</strong>: Java, equals, hashCode, HashSet, HashMap, imutabilidade, collections.
```</p>

<p>Este post resume os principais pontos da transcri√ß√£o, organizando-os em um formato claro e f√°cil de seguir, com exemplos pr√°ticos e dicas √∫teis.</p>]]></content><author><name>{&quot;twitter&quot;=&gt;&quot;vepo&quot;, &quot;linkedin&quot;=&gt;&quot;https://www.linkedin.com/in/victorosorio/&quot;, &quot;picture&quot;=&gt;&quot;/assets/images/me.avif&quot;}</name></author><category term="Java" /><category term="Collections" /><category term="Algoritmos" /><summary type="html"><![CDATA[Neste post, vamos explorar os conceitos fundamentais de equals(), hashCode() e como eles s√£o utilizados em estruturas de dados como HashSet e HashMap no Java. Al√©m disso, discutiremos a import√¢ncia da imutabilidade e como implementar esses m√©todos corretamente.]]></summary></entry><entry><title type="html">A Evolu√ß√£o do Java no Backend: Jakarta EE, Spring e Quarkus</title><link href="https://blog.vepo.dev/posts/java-no-backend" rel="alternate" type="text/html" title="A Evolu√ß√£o do Java no Backend: Jakarta EE, Spring e Quarkus" /><published>2023-10-16T00:00:00+00:00</published><updated>2023-10-16T00:00:00+00:00</updated><id>https://blog.vepo.dev/posts/11-15-52-java-no-backend</id><content type="html" xml:base="https://blog.vepo.dev/posts/java-no-backend"><![CDATA[<p>O ecossistema Java para desenvolvimento backend passou por diversas transforma√ß√µes ao longo dos anos, desde os prim√≥rdios da orienta√ß√£o a objetos at√© as modernas solu√ß√µes como microsservi√ßos e cont√™ineres. Neste post, exploramos essa jornada, destacando as tecnologias que moldaram o Java no backend e como elas se relacionam hoje.</p>

<hr />
<iframe width="560" height="315" src="https://www.youtube.com/embed/uTHZet430rs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
<hr />

<h2 id="1-as-fases-do-java-no-backend"><strong>1. As Fases do Java no Backend</strong></h2>

<h3 id="orienta√ß√£o-a-objetos-e-servidores-de-aplica√ß√£o"><strong>Orienta√ß√£o a Objetos e Servidores de Aplica√ß√£o</strong></h3>
<ul>
  <li><strong>Anos 90</strong>: Java surgiu em 1995 incorporando conceitos como CORBA e servlets (1996).</li>
  <li><strong>J2EE (1999)</strong>: Trouxe solu√ß√µes como EJB (Enterprise JavaBeans) para objetos distribu√≠dos e JDBC para conex√£o com bancos de dados.</li>
  <li><strong>Servidores de Aplica√ß√£o (2001)</strong>: Como JBoss e WebLogic, permitiam deploy de aplica√ß√µes em um √∫nico processo Java, facilitando a gest√£o de recursos.</li>
</ul>

<h3 id="a-revolu√ß√£o-do-docker-2013"><strong>A Revolu√ß√£o do Docker (2013)</strong></h3>
<ul>
  <li>A conteineriza√ß√£o mudou a forma como aplica√ß√µes eram deployadas, eliminando a necessidade de servidores de aplica√ß√£o monol√≠ticos.</li>
  <li>Java 8 (2014) e Spring Boot surgiram como respostas √°geis a essa nova era.</li>
</ul>

<hr />

<h2 id="2-jakarta-ee-o-modelo-baseado-em-especifica√ß√µes"><strong>2. Jakarta EE: O Modelo Baseado em Especifica√ß√µes</strong></h2>
<p>Jakarta EE (antigo Java EE) √© um <strong>modelo de programa√ß√£o baseado em specs</strong>, garantindo compatibilidade e flexibilidade.</p>

<h3 id="principais-especifica√ß√µes"><strong>Principais Especifica√ß√µes</strong></h3>
<ul>
  <li><strong>JPA</strong>: Persist√™ncia de dados.</li>
  <li><strong>JAX-RS</strong>: Desenvolvimento de APIs REST.</li>
  <li><strong>Bean Validation</strong>: Valida√ß√£o de dados com anota√ß√µes.</li>
  <li><strong>CDI</strong>: Inje√ß√£o de depend√™ncias.</li>
</ul>

<h3 id="vantagens"><strong>Vantagens</strong></h3>
<ul>
  <li><strong>Estabilidade</strong>: C√≥digo escrito h√° 20 anos ainda roda em servidores modernos.</li>
  <li><strong>Portabilidade</strong>: Depende de interfaces, n√£o de implementa√ß√µes espec√≠ficas.</li>
</ul>

<h3 id="microprofile-jakarta-ee-para-microsservi√ßos"><strong>MicroProfile: Jakarta EE para Microsservi√ßos</strong></h3>
<ul>
  <li>Extens√£o do Jakarta EE com foco em:
    <ul>
      <li>Observabilidade (OpenTelemetry).</li>
      <li>Toler√¢ncia a falhas.</li>
      <li>Autentica√ß√£o via JWT.</li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="3-spring-acelerando-o-desenvolvimento"><strong>3. Spring: Acelerando o Desenvolvimento</strong></h2>
<ul>
  <li><strong>Contexto</strong>: Surgiu para simplificar o desenvolvimento Java EE, que era lento e burocr√°tico.</li>
  <li><strong>Spring Boot (2014)</strong>: Revolucionou com:
    <ul>
      <li>Execut√°veis independentes (sem servidor de aplica√ß√£o).</li>
      <li>Configura√ß√£o simplificada (menos XML, mais anota√ß√µes).</li>
    </ul>
  </li>
</ul>

<h3 id="compara√ß√£o-com-jakarta-ee"><strong>Compara√ß√£o com Jakarta EE</strong></h3>
<p>| <strong>Spring</strong>          | <strong>Jakarta EE</strong>       |
|‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî-|‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî-|
| <code class="language-plaintext highlighter-rouge">@GetMapping</code>       | <code class="language-plaintext highlighter-rouge">@Path</code> (JAX-RS)    |
| <code class="language-plaintext highlighter-rouge">@RestController</code>   | <code class="language-plaintext highlighter-rouge">@ApplicationScoped</code> (CDI) |
| Foco em produtividade | Foco em padr√µes empresariais |</p>

<hr />

<h2 id="4-quarkus-java-para-a-era-kubernetes"><strong>4. Quarkus: Java para a Era Kubernetes</strong></h2>
<ul>
  <li><strong>Origem</strong>: Evolu√ß√£o do JBoss/WildFly, focada em:
    <ul>
      <li><strong>Tempo de inicializa√ß√£o r√°pido</strong> (crucial para microsservi√ßos).</li>
      <li><strong>Experi√™ncia do desenvolvedor</strong> (live coding, integra√ß√£o com Kubernetes).</li>
    </ul>
  </li>
  <li><strong>Relacionamento com Jakarta EE</strong>: Implementa specs como JAX-RS e CDI, mas com abordagem moderna.</li>
</ul>

<hr />

<h2 id="conclus√£o-qual-escolher"><strong>Conclus√£o: Qual Escolher?</strong></h2>
<ul>
  <li><strong>Jakarta EE</strong>: Ideal para aplica√ß√µes empresariais robustas e de longa vida.</li>
  <li><strong>Spring</strong>: Melhor para produtividade e ado√ß√£o r√°pida.</li>
  <li><strong>Quarkus</strong>: Focado em microsservi√ßos e cloud-native.</li>
</ul>

<h3 id="dicas-para-aprofundar"><strong>Dicas para Aprofundar</strong></h3>
<ol>
  <li>Explore specs como <strong>JAX-RS</strong> e <strong>Bean Validation</strong>.</li>
  <li>Experimente starters em <a href="https://start.jakarta.ee">start.jakarta.ee</a> e <a href="https://code.quarkus.io">code.quarkus.io</a>.</li>
  <li>Para Spring, use <a href="https://start.spring.io">start.spring.io</a>.</li>
</ol>

<p>O Java no backend continua evoluindo, e entender essas tecnologias √© essencial para escolher a melhor ferramenta para seu projeto.</p>

<p><strong>#Java #JakartaEE #Spring #Quarkus #Backend</strong></p>]]></content><author><name>{&quot;twitter&quot;=&gt;&quot;vepo&quot;, &quot;linkedin&quot;=&gt;&quot;https://www.linkedin.com/in/victorosorio/&quot;, &quot;picture&quot;=&gt;&quot;/assets/images/me.avif&quot;}</name></author><category term="Java" /><category term="Backend" /><category term="Quarkus" /><category term="Spring" /><category term="Jakarta EE" /><summary type="html"><![CDATA[O ecossistema Java para desenvolvimento backend passou por diversas transforma√ß√µes ao longo dos anos, desde os prim√≥rdios da orienta√ß√£o a objetos at√© as modernas solu√ß√µes como microsservi√ßos e cont√™ineres. Neste post, exploramos essa jornada, destacando as tecnologias que moldaram o Java no backend e como elas se relacionam hoje.]]></summary></entry><entry><title type="html">Testes de Kafka Stream e Schema Registry</title><link href="https://blog.vepo.dev/posts/mock-schema-registry" rel="alternate" type="text/html" title="Testes de Kafka Stream e Schema Registry" /><published>2023-01-27T00:00:00+00:00</published><updated>2023-01-27T00:00:00+00:00</updated><id>https://blog.vepo.dev/posts/10-18-00-mock-schema-registry</id><content type="html" xml:base="https://blog.vepo.dev/posts/mock-schema-registry"><![CDATA[<p>Testes unit√°rios s√£o algo bem complexos usando Kafka Stream. √â muito dif√≠cil separar o que √© middleware do que √© seu c√≥digo pr√≥prio porque todo c√≥digo vai depender de alguma depend√™ncia do Kafka que ser√° muito dif√≠cil de criar mocks. Aqui vou mostrar de forma superficial como √© poss√≠vel criar testes unit√°rios para Kafka Streams.</p>

<p>Antes de continuar precisamos trazer um pequeno esclarecimento sobre testes. Quando falamos de Unit Testing estamos separando uma parte de c√≥digo para testar isoladamente. J√° os testes de integra√ß√£o ser√£o feitos usando os componentes externos. Essa √© uma explica√ß√£o superficial, seja benevolente pois minha inten√ß√£o aqui n√£o √© falar sobre testes em geral.</p>

<h1 id="1-como-testar-um-kafka-stream">1. Como testar um Kafka Stream</h1>

<p>Antes de testar um Kafka Stream voc√™ precisa diferenciar dois conceitos do Stream. Todo Stream √© um fluxo de dados e esse fluxo √© representado pela classe <a href="https://kafka.apache.org/34/javadoc/org/apache/kafka/streams/Topology.html"><code class="language-plaintext highlighter-rouge">Topology</code></a>. A topologia √© a implementa√ß√£o da sua l√≥gica de neg√≥cios e com ela d√° para criar um Stream. Vamos ver isso no c√≥digo abaixo?</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CountDownLatch</span> <span class="n">latch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>    <span class="o">(</span><span class="mi">1</span><span class="o">)</span>

<span class="nc">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">APPLICATION_ID_CONFIG</span><span class="o">,</span> <span class="n">applicationId</span><span class="o">);</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">BOOTSTRAP_SERVERS_CONFIG</span><span class="o">,</span> <span class="n">bootstrapServers</span><span class="o">);</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">DEFAULT_KEY_SERDE_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">().</span><span class="na">getClass</span><span class="o">());</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">DEFAULT_VALUE_SERDE_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">().</span><span class="na">getClass</span><span class="o">());</span>

<span class="nc">StreamsBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StreamsBuilder</span><span class="o">();</span>    <span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="nc">KStream</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">textLines</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">inputTopic</span><span class="o">);</span>    <span class="o">(</span><span class="mi">3</span><span class="o">)</span>
<span class="nc">KTable</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">wordCounts</span> <span class="o">=</span> <span class="n">textLines</span><span class="o">.</span><span class="na">flatMapValues</span><span class="o">(</span><span class="n">textLine</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Flat Map: "</span> <span class="o">+</span> <span class="n">textLine</span><span class="o">);</span>
                                                            <span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">textLine</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">"\\W+"</span><span class="o">));</span>
                                                          <span class="o">}).</span><span class="na">groupBy</span><span class="o">((</span><span class="n">key</span><span class="o">,</span> <span class="n">word</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                                                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Grouping: key="</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">" work="</span> <span class="o">+</span> <span class="n">word</span><span class="o">);</span>
                                                                        <span class="k">return</span> <span class="n">word</span><span class="o">;</span>
                                                          <span class="o">}).</span><span class="na">count</span><span class="o">(</span><span class="nc">Materialized</span><span class="o">.&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">,</span> <span class="nc">KeyValueStore</span><span class="o">&lt;</span><span class="nc">Bytes</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;&gt;</span><span class="n">as</span><span class="o">(</span><span class="s">"counts-store"</span><span class="o">));</span>
<span class="n">wordCounts</span><span class="o">.</span><span class="na">toStream</span><span class="o">().</span><span class="na">to</span><span class="o">(</span><span class="n">outputTopic</span><span class="o">,</span> <span class="nc">Produced</span><span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">(),</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">Long</span><span class="o">()));</span>
<span class="nc">Topology</span> <span class="n">topology</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>    <span class="o">(</span><span class="mi">4</span><span class="o">)</span>
<span class="nc">KafkaStreams</span> <span class="n">streams</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">KafkaStreams</span><span class="o">(</span><span class="n">topology</span><span class="o">,</span> <span class="n">props</span><span class="o">);</span>   <span class="o">(</span><span class="mi">5</span><span class="o">)</span>

<span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">addShutdownHook</span><span class="o">(</span><span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="s">"streams-shutdown-hook"</span><span class="o">)</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">streams</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">});</span>
<span class="n">streams</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="n">latch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</code></pre></div></div>

<p>Para explicar esse c√≥digo vou levantar 5 pontos sobre ele. O primeiro <strong>(1)</strong> √© que como o Stream funciona assincronamente quando usamos ele sem o auxilio de um framework precisamos garantir que o thread principal n√£o seja finalizada, por isso eu uso o <code class="language-plaintext highlighter-rouge">CountDownLatch</code>. Depois <strong>(2)</strong> temos a classe <code class="language-plaintext highlighter-rouge">StreamsBuilder</code> que deve ser usada para se construir o Stream, como podemos ver no trecho iniciado em <strong>(3)</strong> deve existir um inicio e um fim do fluxo de dados, isso √© feito usando uma DSL, mas depois o builder √© usado para se gerar a topologia <strong>(4)</strong>. E por fim usamos a topologia gerada e as propriedades para criar o <code class="language-plaintext highlighter-rouge">KafkaStreams</code>.</p>

<p>A classe gerada pelo <code class="language-plaintext highlighter-rouge">KafkaStreams</code> vai se conectar diretamente com o Kafka, qualquer teste usando ela ser√° um teste de integra√ß√£o, caso voc√™ queira fazer um teste de integra√ß√£o, recomendo o uso do <a href="https://www.testcontainers.org/modules/kafka/">TestContainers</a> eu fiz um exemplo uma vez, mas <a href="https://github.com/vepo/kafka-stream-with-testcontainers/blob/main/src/test/java/io/vepo/kafka/stream/delay/KafkaStreamTest.java">o teste</a> fica um pouco lento e limitado.</p>

<p>Mas o Kafka prov√™ uma forma de testarmos a nossa topologia sem criar um Stream, para isso devemos usar a classe <a href="https://kafka.apache.org/34/javadoc/org/apache/kafka/streams/TopologyTestDriver.html"><code class="language-plaintext highlighter-rouge">TopologyTestDriver</code></a>. Ela √© instanciada da mesma forma do <code class="language-plaintext highlighter-rouge">KafkaStream</code>. Logo o c√≥digo acima poderia ser refatorada para que a cria√ß√£o da topologia e o controle do stream fossem feito por trechos de c√≥digo diferentes (<em>n√£o vou propor nada</em>).</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">APPLICATION_ID_CONFIG</span><span class="o">,</span> <span class="n">applicationId</span><span class="o">);</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">BOOTSTRAP_SERVERS_CONFIG</span><span class="o">,</span> <span class="s">"dummy:1234"</span><span class="o">);</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">DEFAULT_KEY_SERDE_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">().</span><span class="na">getClass</span><span class="o">());</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">DEFAULT_VALUE_SERDE_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">().</span><span class="na">getClass</span><span class="o">());</span>

<span class="nc">StreamsBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StreamsBuilder</span><span class="o">();</span>

<span class="nc">KStream</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">textLines</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">inputTopic</span><span class="o">);</span>
<span class="nc">KTable</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">wordCounts</span> <span class="o">=</span> <span class="n">textLines</span><span class="o">.</span><span class="na">flatMapValues</span><span class="o">(</span><span class="n">textLine</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Flat Map: "</span> <span class="o">+</span> <span class="n">textLine</span><span class="o">);</span>
                                                            <span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">textLine</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">"\\W+"</span><span class="o">));</span>
                                                          <span class="o">}).</span><span class="na">groupBy</span><span class="o">((</span><span class="n">key</span><span class="o">,</span> <span class="n">word</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                                                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Grouping: key="</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">" work="</span> <span class="o">+</span> <span class="n">word</span><span class="o">);</span>
                                                                        <span class="k">return</span> <span class="n">word</span><span class="o">;</span>
                                                          <span class="o">}).</span><span class="na">count</span><span class="o">(</span><span class="nc">Materialized</span><span class="o">.&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">,</span> <span class="nc">KeyValueStore</span><span class="o">&lt;</span><span class="nc">Bytes</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;&gt;</span><span class="n">as</span><span class="o">(</span><span class="s">"counts-store"</span><span class="o">));</span>
<span class="n">wordCounts</span><span class="o">.</span><span class="na">toStream</span><span class="o">().</span><span class="na">to</span><span class="o">(</span><span class="n">outputTopic</span><span class="o">,</span> <span class="nc">Produced</span><span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">(),</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">Long</span><span class="o">()));</span>
<span class="nc">Topology</span> <span class="n">topology</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="k">try</span> <span class="o">(</span><span class="nc">TopologyTestDriver</span> <span class="n">testDriver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TopologyTestDriver</span><span class="o">(</span><span class="n">topology</span><span class="o">,</span> <span class="n">topologyProps</span><span class="o">))</span> <span class="o">{</span>    <span class="o">(</span><span class="mi">1</span><span class="o">)</span>
    <span class="nc">TestInputTopic</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">input</span> <span class="o">=</span> <span class="n">testDriver</span><span class="o">.</span><span class="na">createInputTopic</span><span class="o">(</span><span class="n">inputTopic</span><span class="o">,</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">().</span><span class="na">serializer</span><span class="o">(),</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">().</span><span class="na">serializer</span><span class="o">());</span>    <span class="o">(</span><span class="mi">2</span><span class="o">)</span>
    <span class="nc">TestOutputTopic</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">testDriver</span><span class="o">.</span><span class="na">createOutputTopic</span><span class="o">(</span><span class="n">outputTopic</span><span class="o">,</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">().</span><span class="na">deserializer</span><span class="o">(),</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">Long</span><span class="o">().</span><span class="na">deserializer</span><span class="o">());</span>
    <span class="n">input</span><span class="o">.</span><span class="na">pipeInput</span><span class="o">(</span><span class="s">"record-001"</span><span class="o">,</span> <span class="s">"word-1"</span><span class="o">);</span>    <span class="o">(</span><span class="mi">3</span><span class="o">)</span>
    <span class="n">input</span><span class="o">.</span><span class="na">pipeInput</span><span class="o">(</span><span class="s">"record-002"</span><span class="o">,</span> <span class="s">"word-2"</span><span class="o">);</span>
    <span class="n">input</span><span class="o">.</span><span class="na">pipeInput</span><span class="o">(</span><span class="s">"record-003"</span><span class="o">,</span> <span class="s">"word-1"</span><span class="o">);</span>
    <span class="nc">TestRecord</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">outputRecord</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="na">readRecord</span><span class="o">();</span>    <span class="o">(</span><span class="mi">4</span><span class="o">)</span>
    <span class="o">[...]</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Como podemos ver o mock do Stream √© criado em <strong>(1)</strong>, depois devemos definir quais t√≥picos est√£o envolvidos no Stream <strong>(2)</strong>, enviamos os dados <strong>(3)</strong> e por fim consumimos as sa√≠das do stream <strong>(4)</strong>. Existe uma s√©rie de vantagens ao se usar o <code class="language-plaintext highlighter-rouge">TopologyTestDriver</code> e a principal delas √© que podemos controlar o avan√ßo do tempo usando <a href="https://kafka.apache.org/34/javadoc/org/apache/kafka/streams/TopologyTestDriver.html#advanceWallClockTime(java.time.Duration)">testDriver.advanceWallClockTime(Duration.ofMinutes(60))</a>. Sem essa funcionalidade se torna imposs√≠vel fazermos testes de streams que efetuam agrega√ß√£o no tempo.</p>

<p>Usando esse trecho de c√≥digo √© poss√≠vel injetar e consultar dados no stream e atrav√©s da biblioteca de assertions do <a href="https://junit.org/junit5/docs/5.8.2/api/org.junit.jupiter.api/org/junit/jupiter/api/Assertions.html">JUnit 5</a> ou do <a href="https://www.javadoc.io/doc/org.assertj/assertj-core/latest/org/assertj/core/api/Assertions.html">AssertJ</a> podemos criar testes unit√°rios consistentes.</p>

<h1 id="2-como-testar-um-kafka-stream-usando-schema-registry">2. Como testar um Kafka Stream usando Schema Registry</h1>

<p>Quando temos um ambiente de microsservi√ßos um pouco mais complexos, precisamos garantir a evolu√ß√£o dos Schemas das mensagens no Kafka. Existe <a href="https://www.sciencedirect.com/science/article/pii/S0164121221000674#b26">alguma literatura</a> sobre o assunto mas temos apenas alguns produtos no mercado. Os mais comuns s√£o o <a href="https://docs.confluent.io/platform/current/schema-registry/index.html">Schema Registry da Confluent</a> e o <a href="https://www.apicur.io/registry/">Apicurio registry</a>, que segundo a documenta√ß√£o √© compat√≠vel com o produto da Confluent.</p>

<p>Um Schema Registry vai funcionar como registro de todos os schemas que s√£o usados tanto para se produzir quanto consumir mensagens. Quando um producer vai enviar uma mensagem, ele ir√° ger√° um Schema, que pode ser JSON, AVRO ou Protobuf, depois ir√° enviar para o registry afim de se garantir que ele j√° est√° registrado. Na mensagem enviada os primeiros bytes s√£o reservados ao armazenamento do identificado do Schema. Sendo bem simplista, o schema registry √© um CRUD de schema que associa cada t√≥pico a um schema e suas vers√µes. Se eu enviar uma mensagem com um schema diferente, ela ser√° adicionada ao t√≥pico como uma nova vers√£o e eu posso consultar todas as vers√µes existente, assim como alterar a valida√ß√£o de compatibilidade dos schemas.</p>

<p>A grande dificuldade de se testar o Schema Registry √© que o cliente √© implementado dentro do Serializar/Deserializer do Apache Kafka. Como vimos na primeira parte, os serializers podem ser alterados pois as propriedades usadas para criar o <code class="language-plaintext highlighter-rouge">TopologyTestDriver</code> s√£o diferentes das usadas no <code class="language-plaintext highlighter-rouge">KafkaStreams</code>. Mas algumas vezes n√£o √© poss√≠vel fazer essa diferencia√ß√£o, pois aquele √© o serializer padr√£o e em alguns casos o serializer √© definido pela topologia.</p>

<p>A documenta√ß√£o da Confluent n√£o ajuda muito quando falamos de testes, essa √© a maior insatisfa√ß√£o ao se usar qualquer produtos deles, mas descobrimos olhando o <a href="https://github.com/confluentinc/schema-registry/blob/master/avro-serializer/src/main/java/io/confluent/kafka/serializers/AbstractKafkaAvroSerDeConfig.java#L41">c√≥digo fonte</a> que existe uma maneira de se fazer o teste. Depois quem encontramos isso foi poss√≠vel ver que essa solu√ß√£o √© bem conhecida, mas n√£o h√° men√ß√µes dela na documenta√ß√£o.</p>

<p>No trecho de c√≥digo abaixo conseguimos criar um mock do cliente do Schema Registry, mesmo usando o <a href="https://kafka.apache.org/34/javadoc/org/apache/kafka/common/serialization/Serde.html"><code class="language-plaintext highlighter-rouge">Serde</code></a> padr√£o para AVRO e foi poss√≠vel registrar os schemas desejados. Repare que os nomes do t√≥picos s√£o <code class="language-plaintext highlighter-rouge">input</code>, <code class="language-plaintext highlighter-rouge">join</code> e <code class="language-plaintext highlighter-rouge">output</code>, mas internamente o Schema Registry adiciona os sufixos <code class="language-plaintext highlighter-rouge">-value</code> para o schema da mensagem e <code class="language-plaintext highlighter-rouge">-key</code> para a chave (<em>n√≥s usamos String da massa</em>). Cada schema desejado deve ser configurado se usando a classe <code class="language-plaintext highlighter-rouge">MockSchemaRegistry</code> que criar√° um cliente local sem usar nenhum servidor web.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[...]</span>

<span class="n">topologyProps</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">DEFAULT_VALUE_SERDE_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">GenericAvroSerde</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
<span class="n">topologyProps</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">AbstractKafkaSchemaSerDeConfig</span><span class="o">.</span><span class="na">SCHEMA_REGISTRY_URL_CONFIG</span><span class="o">,</span> <span class="s">"mock://dummy1"</span><span class="o">);</span>

<span class="o">[...]</span>

<span class="nc">SchemaRegistryClient</span> <span class="n">srClient</span> <span class="o">=</span> <span class="nc">MockSchemaRegistry</span><span class="o">.</span><span class="na">getClientForScope</span><span class="o">(</span><span class="s">"dummy1"</span><span class="o">);</span>
<span class="n">srClient</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="s">"input-value"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AvroSchema</span><span class="o">(</span><span class="n">inputSchema</span><span class="o">));</span>
<span class="n">srClient</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="s">"join-value"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AvroSchema</span><span class="o">(</span><span class="n">inputSchema</span><span class="o">));</span>
<span class="n">srClient</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="s">"output-value"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AvroSchema</span><span class="o">(</span><span class="n">joinedSchema</span><span class="o">));</span>

<span class="o">[...]</span>

<span class="nc">MockSchemaRegistry</span><span class="o">.</span><span class="na">dropScope</span><span class="o">(</span><span class="s">"dummy1"</span><span class="o">);</span>
</code></pre></div></div>

<h2 id="conclus√£o">Conclus√£o</h2>

<p>Apesar do Stream do Apache Kafka parecer muito limitado para testes, √© poss√≠vel construir boas suites se separarmos a Topologia. Todo c√≥digo deve ser testado de forma r√°pida e eficiente, por isso eu sempre recomendo a cria√ß√£o de testes unit√°rios para que tenhamos uma resposta r√°pida.</p>

<p>O Schema Registry tamb√©m permite o mock apesar de n√£o ter uma documenta√ß√£o de f√°cil acesso sobre o assunto.</p>]]></content><author><name>{&quot;twitter&quot;=&gt;&quot;vepo&quot;, &quot;linkedin&quot;=&gt;&quot;https://www.linkedin.com/in/victorosorio/&quot;, &quot;picture&quot;=&gt;&quot;/assets/images/me.avif&quot;}</name></author><category term="Apache Kafka" /><category term="Unit Test" /><category term="Java" /><summary type="html"><![CDATA[Qual √© a maneira mais f√°cil de se testar um consumer/producer/stream Kafka usando Schema Registry?]]></summary></entry><entry><title type="html">Mem√≥ria</title><link href="https://blog.vepo.dev/posts/java-101-memoria" rel="alternate" type="text/html" title="Mem√≥ria" /><published>2022-11-11T00:00:00+00:00</published><updated>2022-11-11T00:00:00+00:00</updated><id>https://blog.vepo.dev/posts/15-55-00-java-101-memoria</id><content type="html" xml:base="https://blog.vepo.dev/posts/java-101-memoria"><![CDATA[<div class="paragraph">
<p>Esse post faz parte de uma s√©rie introdut√≥ria sobre Java, se voc√™ n√£o conhece a linguagem e n√£o leu os posts anteriores, recomendo os ler para ter uma vis√£o melhor da plataforma. Nessa s√©rie, j√° falamos sobre o que √© o ecossistema Java, o que √© a biblioteca Collections, como Java faz Orienta√ß√£o a Objetos, o que √© a biblioteca I/O e como Java implementa paralelismo e concorr√™ncia, esses t√≥picos s√£o necess√°rios para o que vamos falar agora: <strong>Gerenciamento de Mem√≥ria</strong></p>
</div>
<div class="sect1">
<h2 id="cap-07-o-que-e-memoria">O que √© Mem√≥ria</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Antes de falar de Mem√≥ria em programas Java, precisamos definir o que √© Mem√≥ria. Mem√≥ria √© o principal recurso de um computador junto com a CPU. A fun√ß√£o da CPU √© executar opera√ß√µes que alteram a mem√≥ria e a mem√≥ria √© respons√°vel por quase todas as opera√ß√µes de um computador. Tudo se comunica atrav√©s da mem√≥ria. Mas como Java √© uma linguagem de alto n√≠vel, n√£o temos acesso a mem√≥ria completa, ela √© gerenciada pelo Sistema Operacional e pela JVM.</p>
</div>
<div class="paragraph">
<p>Programas Java rodam dentro de uma M√°quina Virtual, logo n√£o precisamos nos preocupar com a aloca√ß√£o de mem√≥ria. Toda vez que nosso programa precisar de mais mem√≥ria ela ser√° fornecida automaticamente. Esse t√≥pico √© muito importante quando formos falar sobre o <em>tuning</em> de aplica√ß√µes Java, uma forma de garantir a performance. Precisamos entender que cada objeto e cada linha de comando ocupa um posi√ß√£o da mem√≥ria. A mem√≥ria √© como um caderno de papel que pegamos pra fazer conta, cada opera√ß√£o realizada ocupa um espa√ßo e quando n√£o h√° mais espa√ßo na folha temos a op√ß√£o de pegar uma nova folha ou apagar uma conta j√° finalizada.</p>
</div>
<div id="cap-07-folha-de-caderno" class="imageblock text-center text-center">
<div class="content">
<img src="/assets/images/java-101/cap-07/pexels-david-bares-204511.jpg" alt="pexels david bares 204511">
</div>
<div class="title">Figura 1. Mem√≥ria √© como uma folha de caderno que usamos como rascunho.</div>
</div>
<div class="paragraph">
<p>A mem√≥ria √© vol√°til. Isso significa que toda vez que precisamos salvar uma informa√ß√£o que √© relevante ou escrevemos ela em um banco de dados ou escrevemos em um arquivo. O "caderno" √© apagado toda vez que o computador reinicia.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cap-07-topologia-da-memoria">Topologia da Mem√≥ria</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Talvez voc√™ j√° tenha ouvido falar de <em>heap</em> ou <em>stack</em>, essa s√£o dois tidos de mem√≥ria distintas que existem em todos os programas. Vamos tentar entender elas sem falar de Java?</p>
</div>
<div class="paragraph">
<p><em>Stack</em> significa pilha que √© um conceito fundamental em computa√ß√£o. Toda pilha √© uma estrutura que voc√™ pode apenas remover o elemento superior e quando voc√™ adiciona elementos voc√™ adiciona em cima do √∫ltimo elemento. Voc√™ n√£o pode pegar o terceiro item de uma pilha, voc√™ tem que remover os 3 itens superiores. Essa √© a mem√≥ria respons√°vel pela execu√ß√£o do seu programa, cada vez que voc√™ entra em um bloco de execu√ß√£o, voc√™ adiciona elementos a pilha, quando voc√™ sai de um bloco de execu√ß√£o voc√™ remove. Para cada execu√ß√£o existe uma <em>stack</em> especifica, isso significa que um programa single thread vai existir apenas uma <em>stack</em>, j√° um multi-thread ter√° v√°rias <em>stacks</em>.</p>
</div>
<div class="paragraph">
<p>J√° <em>heap</em> significa amontoado, ou seja, √© uma mem√≥ria sem organiza√ß√£o, sem hierarquia. A mem√≥ria <em>heap</em> √© usada conforme a necessidade do programa e pode ser compartilhada entre as v√°rias pilhas de execu√ß√£o. Cada programa deve alocar e desalocar espa√ßos na mem√≥ria <em>heap</em>, a aloca√ß√£o √© feita por uma chamada de sistema (<em>system call</em>) <a href="https://man7.org/linux/man-pages/man3/free.3.html"><em>malloc</em></a> (ou <em>calloc</em>) e deve ser liberada pelo programa usando <em>free</em>.</p>
</div>
<div id="cap-05-c-close" class="imageblock text-center text-center">
<div class="content">
<a class="image" href="https://man7.org/linux/man-pages/man3/free.3.html"><img src="/assets/images/java-101/cap-07/malloc.png" alt="malloc"></a>
</div>
<div class="title">Figura 2. Documenta√ß√£o das fun√ß√µes de gerenciamento de mem√≥ria oferecidas pelo Sistema Operacional.</div>
</div>
<div class="paragraph">
<p>Quando uma por√ß√£o da mem√≥ria √© alocada, tudo que o sistema operacional precisa saber √© o tamanho da mem√≥ria que o programa necessita, assim o sistema operacional retorna o endere√ßo de mem√≥ria onde essa por√ß√£o de mem√≥ria foi alocada. Quando o programa n√£o precisa mais dessa posi√ß√£o de mem√≥ria ela deve ser liberada, para liberar o sistema operacional precisa do endere√ßo de mem√≥ria que deve ser desalocada. Quando falamos "endere√ßo de mem√≥ria" estamos falando de um endere√ßo f√≠sico mesmo, √© a posi√ß√£o da mem√≥ria que o sistema operacional achou conveniente oferecer ao programa. Com a posse desse endere√ßo o programa pode manipular a mem√≥ria, por exemplo se estamos falando de um array, o programa pode fazer opera√ß√µes matem√°tica para acessar as posi√ß√µes. Esse √© o conceito de ponteiro, ele aponta para uma posi√ß√£o de mem√≥ria, mas √© apenas um n√∫mero que representa um endere√ßo f√≠sico.</p>
</div>
<div class="paragraph">
<p><em>‚Äî E se eu n√£o desalocar a posi√ß√£o de mem√≥ria?</em></p>
</div>
<div class="paragraph">
<p>Todo programa tem que ter muito cuidado ao usar a mem√≥ria por dois motivos. Primeiro mem√≥ria √© um recurso finito, compartilhado e escasso. Isso significa que se seu servidor tem 10GiB de mem√≥ria RAM, todos os processos s√≥ podem usar 10GiB de mem√≥ria RAM. Caso seja necess√°rio mais mem√≥ria, o sistema operacional vai criar um arquivo de pagina√ß√£o que podem degradar a efici√™ncia dos programas em execu√ß√£o. Depois cada programa deve operar com o m√≠nimo de mem√≥ria poss√≠vel, logo a aloca√ß√£o e libera√ß√£o de mem√≥ria deve ser feita de maneira consciente, se seu programa come√ßa a alocar mem√≥ria a efici√™ncia dele vai degradar at√© que o sistema operacional simplesmente, e sem cerim√¥nia, vai finalizar a execu√ß√£o. Ent√£o quando um programa simplesmente para de funcionar sem nenhum motivo aparente, a primeira coisa que um desenvolvedor observar √© o consumo de mem√≥ria, se ele est√° crescendo at√© o programa ser finalizado isso pode ser um sintoma de um problema chamado <em>Memory Leak</em> (vazamento de mem√≥ria em tradu√ß√£o livre).</p>
</div>
<div class="paragraph">
<p><em>Memory Leak</em> acontece quando por√ß√µes de mem√≥ria s√£o alocados mas n√£o s√£o desalocados criando por√ß√µes da mem√≥ria n√£o utilizadas at√© n√£o haver mais mem√≥ria dispon√≠vel. Um programa com <em>memory leak</em> pode comprometer a eficiente de um servidor ou at√© de um cluster.</p>
</div>
<div id="cap-07-memoria-c" class="imageblock text-center text-center">
<div class="content">
<img src="/assets/images/java-101/cap-07/memoria-c.png" alt="memoria c">
</div>
<div class="title">Figura 3. Topologia de uma mem√≥ria de um programa C. Todo gerenciamento das aloca√ß√µes √© feita manualmente.</div>
</div>
<div class="paragraph">
<p><em>‚Äî E porque eu preciso saber disso se vou programar em Java?</em></p>
</div>
<div class="paragraph">
<p>Porque esses conceitos s√£o importantes para voc√™ fazer um uso consciente da mem√≥ria. Voc√™ j√° parou para pensar que ao declara um objeto voc√™ ocupa um espa√ßo f√≠sico? Mas agora vamos rever todos esses conceitos em Java.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cap-07-topologia-da-memoria-na-jvm">Topologia da Mem√≥ria na JVM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Na JVM tamb√©m existe a mem√≥ria <em>heap</em> e a <em>stack</em>. A <em>stack</em> ir√° conter todas as informa√ß√µes de execu√ß√£o e os valores das vari√°veis primitivas, quando uma vari√°vel √© um objeto a <em>stack</em> cont√©m uma <a href="https://docs.oracle.com/javase/specs/jvms/se19/html/jvms-2.html#jvms-2.4"><strong>refer√™ncia</strong></a> para a <em>heap</em>. Todo objeto √© alocado na <em>heap</em>, mas ele n√£o ocupa uma posi√ß√£o fixa pois a <em>heap</em> √© gerenciada pela JVM. Diferentemente das linguagens de baixo n√≠vel, em Java um novo objeto j√° cria uma nova aloca√ß√£o de mem√≥ria sem precisar interagir diretamente com o sistema operacional, mas quando o objeto n√£o √© mais necess√°rio ele n√£o precisa ser liberado, pois a JVM tem um processo chamado Garbage Collector que remove da <em>heap</em> todo objeto que n√£o √© mais referenciado.</p>
</div>
<div class="paragraph">
<p>J√° a <em>heap</em> ser√° dividida entre v√°rias regi√µes. As primeiras regi√µes s√£o a <em>Young Generation</em> e a <em>Old Generation</em>, como o nome j√° demonstra na <em>Young Generation</em> est√£o localizados os objetos gerados recentemente e na <em>Old Generation</em> est√£o os objetos mais antigos. Da mesma forma a <em>Young Generation</em> √© dividida entre <em>Eden</em>, <em>S1</em> e <em>S2</em> (S de <em>Suvivor</em> 1 e 2, que significa sobrevivente) onde <em>Eden</em> √© a regi√£o onde os objetos nascem e depois migram pra <em>S1</em> e depois pra <em>S2</em>.</p>
</div>
<div id="cap-07-memoria-java" class="imageblock text-center text-center">
<div class="content">
<img src="/assets/images/java-101/cap-07/memoria-java.png" alt="memoria java">
</div>
<div class="title">Figura 4. Topologia de uma mem√≥ria de um processo Java. Todo gerenciamento das aloca√ß√µes √© automaticamente pela JVM.</div>
</div>
<div class="paragraph">
<p><em>‚Äî Mas como acontecem essas migra√ß√µes? Porque eu preciso saber disso?!?</em></p>
</div>
<div class="paragraph">
<p>Essa informa√ß√£o √© importante por dois motivos. O primeiro deles √© que o ciclo de vida de um objeto impacta na performance pois a opera√ß√£o feita pelo <em>Garbage Collector</em> √© uma opera√ß√£o custosa, j√° vi processos que 30% do tempo de execu√ß√£o era gasto para liberar mem√≥ria. O segundo motivo √© que, conhecendo o ciclo de vida de um objeto, podemos ajudar o Garbage Collector a eliminar objetos descart√°veis.</p>
</div>
<div class="paragraph">
<p><em>‚Äî Mas qual √© o ciclo de vida de um objeto?</em></p>
</div>
<div class="paragraph">
<p>Quando a JVM encontra um <code>new ObjetoX()</code>, ela vai alocar o espa√ßo necess√°rio na <em>Eden</em>. Se h√° espa√ßo suficiente, tudo bem. Se n√£o h√° espa√ßo suficiente o <em>Garbage Collector</em> vai fazer uma limpeza na <em>Eden</em> descartando todos objetos que n√£o s√£o referenciados na <em>stack</em> e movendo todos os objetos restante para a <em>S1</em>. Se h√° espa√ßo suficiente na <em>S1</em>, tudo bem. Se n√£o h√° espa√ßo suficiente o <em>Garbage Collector</em> vai fazer uma limpeza na <em>S1</em> descartando todos objetos que n√£o s√£o referenciados na <em>stack</em> e movendo todos os objetos restante para a <em>S2</em>. Se h√° espa√ßo suficiente na <em>S2</em>, tudo bem. Se n√£o h√° espa√ßo suficiente o <em>Garbage Collector</em> vai fazer uma limpeza na <em>S2</em> descartando todos objetos que n√£o s√£o referenciados na <em>stack</em> e movendo todos os objetos restante para a <em>Old Generation</em>. Se h√° espa√ßo suficiente na <em>Old Generation</em>, tudo bem. Se n√£o h√° espa√ßo suficiente o <em>Garbage Collector</em> vai fazer uma limpeza na <em>Old Generation</em> descartando todos objetos que n√£o s√£o referenciados na <em>stack</em>. Quando essa opera√ß√£o for executada e a JVM n√£o conseguir alocar espa√ßo, a JVM vai lan√ßar uma exce√ß√£o: <strong>Exception in thread thread_name: java.lang.OutOfMemoryError: Java heap space</strong>.</p>
</div>
<div class="paragraph">
<p>As informa√ß√µes sobre a classe <code>ObjetoX</code> ficam armazenadas no <em>Metaspace</em> que fica respons√°vel por armazenar as informa√ß√µes de classes e <em>ClassLoaders</em>. O <em>Metaspace</em> pode tamb√©m ser alvo de uma limpeza do <em>Garbage Collector</em>, mas ele s√≥ ir√° atuar se n√£o houver mais espa√ßo no <em>Metaspace</em>. O <em>Metaspace</em> pode, tamb√©m, conter refer√™ncias a objetos que est√£o na <em>heap</em>, qualquer campo <em>est√°tico</em> (que usa <em>static</em>) faz parte da classe e n√£o do objeto e criar√° uma refer√™ncia do <em>Metaspace</em> para a <em>heap</em>.</p>
</div>
<div class="paragraph">
<p><em>‚Äî Mas na descri√ß√£o do Garbage Collector s√≥ se falou de refer√™ncia da heap?</em></p>
</div>
<div class="paragraph">
<p>SIM! Por precisamos entender que uma classe pertence a um <em>ClassLoader</em> e se o <em>ClassLoader</em> n√£o for mais usado na heap, ele pode ser eliminado. Um campo est√°tico s√≥ ser√° liberado se o <em>ClassLoader</em> for descartado pelo <em>Garbage Collector</em> ou se o valor dele for alterado para <em>null</em>. O <em>ClassLoader</em> √© um objeto que tem como responsabilidade ler as informa√ß√µes da classe, ele pode ser definido dinamicamente e sempre tem uma estrutura em √°rvore, ou seja, se a classe n√£o for encontrada nele ser√° procurada no <em>ClassLoader</em> pai, se n√£o houver <em>ClassLoader</em> pai a JVM lan√ßa uma <code>ClassNotFoundException</code>.</p>
</div>
<div class="sect2">
<h3 id="cap-referencias-e-ponteiros">Refer√™ncias e Ponteiros</h3>
<div class="paragraph">
<p>Agora quero levantar uma provoca√ß√£o:</p>
</div>
<div class="paragraph">
<p><strong>Seriam as refer√™ncias a objetos estruturas similares aos ponteiros?</strong></p>
</div>
<div class="paragraph">
<p>A primeira resposta pode parecer sim, mas √© n√£o. Primeiro porque ponteiros apontam diretamente para posi√ß√µes de mem√≥ria, j√° nossas refer√™ncias apontam para um objeto que pode ser realocado fisicamente na mem√≥ria. Depois o gerenciamento dos ponteiros √© de total responsabilidade do desenvolvedor, j√° as refer√™ncias s√£o parte do design do c√≥digo, uma vez que a refer√™ncia n√£o existe na <em>stack</em> a JVM est√° ciente e pode remover a posi√ß√£o porque ela √© gerenciada pela JVM.</p>
</div>
<div class="paragraph">
<p>Mas refer√™ncias podem ser declaras em c√≥digo tamb√©m, por isso existe a interface <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/ref/Reference.html">java.lang.ref.Reference</a> que √© implementada por <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/ref/PhantomReference.html">PhantomReference</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/ref/SoftReference.html">SoftReference</a> e <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/ref/WeakReference.html">WeakReference</a>. Essas classes recebem um tratamento especial do <em>Garbage Collector</em> e podem ser usadas para tornar mais eficiente o uso da mem√≥ria. Elas devem ser usadas com muita parcim√¥nia pois n√£o s√£o de f√°cil compreens√£o.</p>
</div>
<div class="paragraph">
<p>Uma <code>PhantomReference</code> √© usada para verificar se um objeto √© eleg√≠vel para o <em>Garbage Collector</em>. Quando n√£o h√° nenhuma refer√™ncia ao objeto, ele √© removido do PhantomReference e adicionado ao <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/ref/ReferenceQueue.html">ReferenceQueue</a> que √© uma pilha especial. Se o objeto est√° dentro da pilha ou o m√©todo <code>get</code> retorna <code>null</code>, significa que ele pode ser eliminado pela JVM. A <code>PhantomReference</code> pode ser usada para verificar se um objeto foi descartado ou n√£o. Se o objeto n√£o for removido da pilha, pode gerar uma <em>memory leak</em>.</p>
</div>
<div class="paragraph">
<p>A classe <code>SoftReference</code> tem um comportamento similar, mas apresenta a possibilidade de n√£o se usar a pilha. Ela pode ser usada para construir cache sens√≠vel ao uso da mem√≥ria. Se um objeto √© apenas armazenado dentro de um <code>SoftReference</code> pode ser descartado pelo <code>Garbage Collector</code> quando n√£o h√° espa√ßo dispon√≠vel na <em>heap</em> sendo necess√°rio criar uma nova inst√¢ncia.</p>
</div>
<div class="paragraph">
<p>A classe <code>WeakReference</code> √© muito similar a classe <code>SoftReference</code>, exceto que o <em>Garbage Collector</em> ir√° eliminar o objeto na primeira oportunidade ao inv√©s de esperar a necessidade de aloca√ß√£o de espa√ßo.</p>
</div>
<div class="paragraph">
<p>Essas classes podem ser usadas para constru√ß√£o de Caches inteligentes que otimizam o uso da mem√≥ria. Imagina se voc√™ tem um requisito que √© manter um valor at√© que ele n√£o seja mais necess√°rio, basta criar uma <code>HashMap</code> que armazena <code>PhantomReference</code>. Existe tamb√©m uma mapa chamado <a href="https://docs.oracle.com/javase/8/docs/api/java/util/WeakHashMap.html">WeakHashMap</a> que traz um comportamento semelhante, mas a refer√™ncia fraca √© a chave e n√£o o valor.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cap-07-ferramentas-de-diagnostico">Ferramentas de Diagn√≥stico</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Como falamos, o principal problema que o mau uso da mem√≥ria pode nos trazer √© lentid√£o ou vazamento de mem√≥ria, mas como podemos analisar se nosso programa tem esses problemas?</p>
</div>
<div class="paragraph">
<p>Podemos usar ferramentas que a pr√≥pria JVM nos d√° para ver o que est√° acontecendo na mem√≥ria.</p>
</div>
<div class="sect2">
<h3 id="_visualvm">VisualVM</h3>
<div class="paragraph">
<p>Uma das mais importantes ferramentas √© a <a href="https://visualvm.github.io/">VisualVM</a>. Com ela √© poss√≠vel monitorar a mem√≥ria para ver como a aloca√ß√£o da mem√≥ria est√° evoluindo. Para os testes usei um c√≥digo simples que consumia uma API e envia para um Apache Kafka, e podemos ver abaixo que o uso da mem√≥ria √© bem est√°vel. Um programa em uso est√°vel de mem√≥ria vai sempre apresentar um uso de mem√≥ria serrilhado, esse padr√£o acontece porque objetos s√£o criados at√© que sejam finalizados pelo <em>Garbage Collector</em>, ent√£o podemos afirmar que cada vez que o uso de mem√≥ria cai houve uma execu√ß√£o do <em>Garbage Collector</em>.</p>
</div>
<div id="cap-07-visualvm" class="imageblock text-center text-center">
<div class="content">
<img src="/assets/images/java-101/cap-07/visualvm.png" alt="visualvm">
</div>
<div class="title">Figura 5. Interface do VisualVM mostrando o uso de mem√≥ria de um programa simples.</div>
</div>
<div class="paragraph">
<p>Ao executar o VisualVM voc√™ consegue atrelar a qualquer JVM em execu√ß√£o na m√°quina local ou a uma JVM que exponha o gerenciamento atrav√©s de uma porta JMX. A linha de comando abaixo mostra como executar um processo Java que seja acess√≠vel pela porta 8080 sem nenhuma seguran√ßa.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>java <span class="nt">-Dcom</span>.sun.management.jmxremote.port<span class="o">=</span>8080 <span class="se">\</span>
       <span class="nt">-Dcom</span>.sun.management.jmxremote.ssl<span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
       <span class="nt">-Dcom</span>.sun.management.jmxremote.authenticate<span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
       <span class="nt">-jar</span> target/produtor.jar <span class="nt">--appId</span> <span class="nv">$APP_ID</span> <span class="nt">--timeout</span> 1</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>‚Äî Ser√° que eu consigo saber quando o Garbage Collector foi chamado? Ou chamar ele manualmente?</em></p>
</div>
<div class="paragraph">
<p>A resposta simples √© n√£o! De dentro do seu c√≥digo Java n√£o d√° pra escutar o funcionamento do <em>Garbage Collector</em> e nem √© recomend√°vel chamar ele atrav√©s da biblioteca. A VisualVM possibilita que ele seja chamada manualmente atrav√©s da interface gr√°fica (e n√£o da biblioteca padr√£o). Mas existe a possibilidade de que salvar o log do <em>Garbage Collector</em> para futura analise. Por exemplo, no comando bash abaixo estamos ordenando a JVM a salvar as informa√ß√µes no arquivo <code>gc.log</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>java <span class="nt">-XX</span>:+PrintGCDetails <span class="nt">-Xloggc</span>:gc.log <span class="nt">-jar</span> target/produtor.jar <span class="nt">--appId</span> <span class="nv">$APP_ID</span> <span class="nt">--timeout</span> 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos observar o que temos o cabe√ßalho desse arquivo de log?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>[0.009s][info][gc,init] CardTable entry size: 512
[0.009s][info][gc     ] Using G1
[0.011s][info][gc,init] Version: 18+36-2087 (release)
[0.011s][info][gc,init] CPUs: 8 total, 8 available
[0.011s][info][gc,init] Memory: 16099M
[0.011s][info][gc,init] Large Page Support: Disabled
[0.011s][info][gc,init] NUMA Support: Disabled
[0.011s][info][gc,init] Compressed Oops: Enabled (Zero based)
[0.011s][info][gc,init] Heap Region Size: 2M
[0.011s][info][gc,init] Heap Min Capacity: 8M
[0.011s][info][gc,init] Heap Initial Capacity: 252M
[0.011s][info][gc,init] Heap Max Capacity: 4026M
[0.012s][info][gc,init] Pre-touch: Disabled
[0.012s][info][gc,init] Parallel Workers: 8
[0.012s][info][gc,init] Concurrent Workers: 2
[0.012s][info][gc,init] Concurrent Refinement Workers: 8
[0.012s][info][gc,init] Periodic GC: Disabled
[0.012s][info][gc,metaspace] CDS archive(s) mapped at: [0x0000000800000000-0x0000000800b90000-0x0000000800b90000), size 12124160, SharedBaseAddress: 0x0000000800000000, ArchiveRelocationMode: 0.
[0.012s][info][gc,metaspace] Compressed class space mapped at: 0x0000000800c00000-0x0000000840c00000, reserved size: 1073741824
[0.012s][info][gc,metaspace] Narrow klass base: 0x0000000800000000, Narrow klass shift: 0, Narrow klass range: 0x100000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Observe que temos v√°rias informa√ß√µes sobre a m√°quina e a configura√ß√£o da JVM. Temos o total de CPU (<em>CPUs: 8 total, 8 available</em>), mem√≥ria (<em>Memory: 16099M</em>), vers√£o da JVM, <em>Garbage Collector</em> selecionado (<em>Using G1</em>) e configura√ß√µes do <em>Garbage Collector (_Parallel Workers: 8</em>, <em>Concurrent Workers: 2</em>, <em>Concurrent Refinement Workers: 8</em> e <em>Periodic GC: Disabled</em>). Os valores espec√≠ficos da JVM podem ser configurados atrav√©s de par√¢metros.</p>
</div>
<div class="paragraph">
<p>Com o log habilitado toda atividade do <em>Garbage Collector</em> estar√° registrada, vamos analisar uma delas?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>[48.661s][info][gc,start    ] GC(7) Pause Young (Normal) (G1 Evacuation Pause)
[48.662s][info][gc,task     ] GC(7) Using 2 workers of 8 for evacuation
[48.671s][info][gc,phases   ] GC(7)   Pre Evacuate Collection Set: 0.1ms
[48.671s][info][gc,phases   ] GC(7)   Merge Heap Roots: 0.1ms
[48.672s][info][gc,phases   ] GC(7)   Evacuate Collection Set: 8.8ms
[48.672s][info][gc,phases   ] GC(7)   Post Evacuate Collection Set: 0.7ms
[48.672s][info][gc,phases   ] GC(7)   Other: 0.2ms
[48.672s][info][gc,heap     ] GC(7) Eden regions: 6-&gt;0(6)
[48.672s][info][gc,heap     ] GC(7) Survivor regions: 1-&gt;1(1)
[48.672s][info][gc,heap     ] GC(7) Old regions: 5-&gt;5
[48.672s][info][gc,heap     ] GC(7) Archive regions: 0-&gt;0
[48.672s][info][gc,heap     ] GC(7) Humongous regions: 0-&gt;0
[48.672s][info][gc,metaspace] GC(7) Metaspace: 30289K(31040K)-&gt;30289K(31040K) NonClass: 27043K(27392K)-&gt;27043K(27392K) Class: 3245K(3648K)-&gt;3245K(3648K)
[48.672s][info][gc          ] GC(7) Pause Young (Normal) (G1 Evacuation Pause) 21M-&gt;10M(34M) 10.497ms
[48.672s][info][gc,cpu      ] GC(7) User=0.00s Sys=0.00s Real=0.01s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Primeiro vamos observar a topologia dessa mensagem de log. O primeiro par√¢metro √© de suma import√¢ncia, ele vai registrar o momento em que a mensagem foi gerada, podemos dizer por exemplo eu que essa execu√ß√£o come√ßou exatamente em <code>48.661s</code> e terminou <code>48.672s</code>. Por fim temos a mensagem de log, e veja que na pen√∫ltima linha temos o tempo total da execu√ß√£o <code>10.497ms</code>. Temos os registros de como as regi√µes foram impactadas, no caso acima os 6 objetos residentes no Eden foram removidos deixando as outras regi√µes intactas.</p>
</div>
<div class="paragraph">
<p>Qual outra informa√ß√£o esse log tr√°s? Talvez voc√™ n√£o tenha percebido, mas se voc√™ somar todas as linhas que cont√©m a string <code>[info][gc          ]</code> voc√™ tem o tempo total gasto em <em>Garbage Collector</em> que pode ser usado com o tempo de execu√ß√£o que est√° na primeira coluna e temos a porcentagem de tempo de execu√ß√£o que o <em>Garbage Collector</em> usa. Essa informa√ß√£o √© importante porque a maioria das implementa√ß√µes de <em>Garbage Collector</em> para as threads para n√£o criar inconsist√™ncias.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cap-07-solucoes-comuns">Solu√ß√µes Comuns</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Se seu processo est√° gastando muito tempo com o <em>Garbage Collector</em> pode ser que algumas a√ß√µes devam ser tomadas. N√£o existe uma regra padr√£o sobre como se otimiza a mem√≥ria pois cada programa tem um comportamento diferente.</p>
</div>
<div class="paragraph">
<p>O ideal √© construir um modelo de otimiza√ß√£o, voc√™ precisa de dados para isso. Primeiro coloque seu programa em execu√ß√£o com determinada configura√ß√£o, depois registre o n√∫mero m√°ximo de requisi√ß√µes por segundo, o tempo usado com <em>Garbage Collector</em> e a lat√™ncia de resposta de uma requisi√ß√£o. Depois v√° alterando as configura√ß√µes e veja como esses valores se comportam.</p>
</div>
<div class="paragraph">
<p>Eu j√° trabalhei em um sistema que era poss√≠vel configurar o n√∫mero de threads de execu√ß√£o e a performance estava degradada porque a pessoa que dava suporte configurou um elevado n√∫mero de threads. A solu√ß√£o nesse caso foi reduzir o n√∫mero de threads e rodar outra inst√¢ncia em paralelo.</p>
</div>
<div class="paragraph">
<p>Com esse experimento, voc√™ ser√° capaz de dizer o que acontece com o sistema se voc√™ reduzir o tamanho da <em>heap</em> ou se voc√™ aumentar o tamanho do <em>Eden</em>, etc.</p>
</div>
</div>
</div>]]></content><author><name>{&quot;twitter&quot;=&gt;&quot;vepo&quot;, &quot;linkedin&quot;=&gt;&quot;https://www.linkedin.com/in/victorosorio/&quot;, &quot;picture&quot;=&gt;&quot;/assets/images/me.avif&quot;}</name></author><category term="Java" /><category term="Gerenciamento de Mem√≥ria" /><category term="Tuning" /><summary type="html"><![CDATA[Como funciona o gerenciamento de mem√≥ria com Java? Nesse post vou descrever como funciona a mem√≥ria de um programa Java e comparar ele com de outros programas. Depois vou mostrar quais os principais desafios do gerenciamento de mem√≥ria em programas Java. A ideia desta s√©rie √© criar um tutorial Java onde mostrarei todos os segredos da linguagem e do ecossistema.]]></summary></entry><entry><title type="html">Concorr√™ncia e Paralelismo</title><link href="https://blog.vepo.dev/posts/java-101-threads" rel="alternate" type="text/html" title="Concorr√™ncia e Paralelismo" /><published>2022-09-03T00:00:00+00:00</published><updated>2022-09-03T00:00:00+00:00</updated><id>https://blog.vepo.dev/posts/18-00-00-java-101-threads</id><content type="html" xml:base="https://blog.vepo.dev/posts/java-101-threads"><![CDATA[<div class="paragraph">
<p>Esse post faz parte de uma s√©rie introdut√≥ria sobre Java, se voc√™ n√£o conhece a linguagem e n√£o leu os posts anteriores, recomendo os ler para ter uma vis√£o melhor da plataforma. Nessa s√©rie, j√° falamos sobre o que √© o ecossistema Java, o que √© a biblioteca Collections, como Java faz Orienta√ß√£o a Objetos e o que √© a biblioteca I/O, esses t√≥picos s√£o necess√°rios para o que vamos falar agora: <strong>Concorr√™ncia e Paralelismo</strong>.</p>
</div>
<div class="sect1">
<h2 id="cap-06-o-que-e-concorrencia-e-paralelismo">O que √© Concorr√™ncia e Paralelismo?!?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nos frameworks modernos √© muito raro lidarmos com paralelismo, apesar que podemos lidar com concorr√™ncia o tempo inteiro. Para entender isso precisamos primeiro compreender a diferen√ßa entre esses dois conceitos. Para isso vamos imaginar que estamos em uma biblioteca, nessa biblioteca tem dois tipos de livros: os comuns e os raros. Os livros comuns est√£o acess√≠veis na estantes para que todos possam ler e pegar emprestado, mas os livros raros est√£o dispon√≠veis em uma sala especifica em que voc√™ precisa pedir para um bibliotec√°rio pegar ele e deve ler somente na sala.</p>
</div>
<div class="paragraph">
<p>Vamos imaginar que surgiu um estranho interesse por se ler livros raros na cidade e isso gerou uma procura inesperada que surpreendeu at√© mesmo a dire√ß√£o da biblioteca.</p>
</div>
<div class="paragraph">
<p><em>‚Äî Todos est√£o dispon√≠veis na internet! S√≥ acessar o <a href="https://www.gutenberg.org/browse/languages/pt">Projeto Gutenberg</a>!!!</em></p>
</div>
<div class="paragraph">
<p>Isso gerou uma fila enorme na sess√£o de livros raros pois s√≥ tinha um bibliotec√°rio para encontrar o livro, registrar a sa√≠da e ele ainda precisava observar se o livro estava sendo manipulado corretamente. Logo surgiram v√°rias op√ß√µes de como melhorar o atendimento da biblioteca, mas s√≥ poderiam ser consideradas as op√ß√µes que mantivessem o cuidado para com as obras.</p>
</div>
<div id="cap-06-biblioteca-antiga" class="imageblock text-center text-center">
<div class="content">
<img src="/assets/images/java-101/cap-06/biblioteca-antiga.jpg" alt="biblioteca antiga">
</div>
<div class="title">Figura 1. Biblioteca da Escola S√° de Miranda</div>
</div>
<div class="paragraph">
<p>A primeira op√ß√£o foi contratar mais um bibliotec√°rio. Feita a contrata√ß√£o ele come√ßou a dividir as tarefas com o mais antigo. Enquanto o primeiro cuidava de encontrar as obras e registrar as sa√≠das, o segundo fiscalizava se todos os usu√°rios da biblioteca estavam manuseando corretamente o livro.</p>
</div>
<div class="paragraph">
<p>A dire√ß√£o da biblioteca achou a op√ß√£o boa, mas eles perceberam que o aumento da efici√™ncia foi de apenas 30% enquanto se esperava 100% de efici√™ncia com a contrata√ß√£o de um novo funcion√°rio. Isso aconteceu porque as atividades foram distribu√≠das, mas nenhuma atividade era feita em paralelo. A atividade que mais demandava tempo era encontrar a obra e registrar a sua sa√≠da com cerca de 90% do tempo, logo essa atividade deveria ser feita em paralelo. <strong>Paralelismo</strong> acontece quando a mesma tarefa √© realizada simultaneamente por mais de um bibliotec√°rio. Assim os dois bibliotec√°rios decidiram que iriam trabalhar em todo o conjunto de atividades aumentando a efici√™ncia de 30% para 50%.</p>
</div>
<div class="paragraph">
<p>Mas eles encontraram um pequeno problema, s√≥ havia um computador na bancada e por isso eles precisavam se revesar para usar o computador. No come√ßo eles replicavam a atividade que faziam quando havia apenas 1 bibliotec√°rio: atendiam o cliente, encontravam o livro e registravam a sa√≠da. Mas perceberam que o tempo de registrar o livro tamb√©m era demorado, ele demorava cerca de 3 vezes o tempo de pegar o livro, pois o software era bem lento e implementado em Javascript. Logo eles foram procurar solu√ß√£o para o problema deles e descobriram que estavam enfrentando um problema de concorr√™ncia. <strong>Concorr√™ncia</strong> acontece quando dois ou mais bibliotec√°rios desejam acessar recursos limitados.</p>
</div>
<div class="paragraph">
<p>Eles perceberam que o mais demorado era entrar no sistema, logo resolveram atender 3 clientes por vez. Assim cada bibliotec√°rio pegava o pedido de 3 clientes e depois registravam no sistema. Essa abordagem fez com que o atendimento se tornasse 70% mais eficiente do que era quando se tinha apenas um funcion√°rio.</p>
</div>
<div class="paragraph">
<p>Por fim a biblioteca decidiu contratar uma bibliotec√°ria para fiscalizar o manuseio dos livros porque percebeu que s√≥ tinha homens nessa hist√≥ria. E o aumento de efici√™ncia passou para 150% pois ela conseguia fiscalizar e atender na bancada quando poss√≠vel.</p>
</div>
<div class="paragraph">
<p>Eu espero que com essa hist√≥ria voc√™ tenha compreendido que esse processo acontece com qualquer servidor web. √â EXATAMENTE ASSIM! Pense que a biblioteca √© o servidor, os bibliotec√°rios s√£o <em>threads</em>, os livros s√£o os recursos que o servidor usa e os clientes s√£o os clientes que est√£o acessando a API do servidor. Eu n√£o sei se os conceitos de concorr√™ncia e paralelismo s√£o usado na bibliotecas, eles s√£o conceitos da computa√ß√£o que foram usado nesse texto para descrever e diferenciar eles. Logo podemos redefinir <strong>Paralelismo</strong> quando a mesma tarefa √© realizada simultaneamente por mais de uma <em>thread</em> ou processo e <strong>Concorr√™ncia</strong> quando acontece duas ou mais <em>threads</em>, ou processos desejam acessar recursos limitados.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cap-06-thread-e-processo">O que √© Thread e Processo?!?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Falar de Paralelismo e Concorr√™ncia n√£o √© uma tarefa f√°cil porque envolve v√°rios conceitos de v√°rios n√≠veis. At√© agora n√≥s falamos de conceitos abstratos, mas agora vamos falar de algo bem mais concreto. Eu citei Thread e Processo e esses s√£o conceitos sobre o sistema operacional.</p>
</div>
<div class="paragraph">
<p>Um processo √© um programa rodando na mem√≥ria. Ele √© instanciado pelo sistema operacional e ter√° seu ciclo de vida at√© ser encerrado por si mesmo ou pelo pr√≥prio sistema operacional. Cada processo tem um identificador √∫nico e compartilha os recursos da m√°quina com outros processo. No trecho abaixo vemos a listagem dos 9 primeiros processos iniciados pelo Linux que ainda est√£o em execu√ß√£o, observe que o <code>PID</code> √© o identificado √∫nico de cada processo, se eu quiser finalizar um processo preciso enviar um comando <code>kill -15 &lt;PID&gt;</code> onde <strong>-15</strong> √© o sinal que o programa deve ser encerrado, se eu usar <strong>-9</strong> ele ser√° encerrado imediatamente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>ps <span class="nt">-aux</span> | <span class="nb">head
</span>USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.0  0.0 202552  5172 ?        Ss   Jul01  70:40 /usr/lib/systemd/systemd <span class="nt">--switched-root</span> <span class="nt">--system</span> <span class="nt">--deserialize</span> 22
root           2  0.0  0.0      0     0 ?        S    Jul01   0:05 <span class="o">[</span>kthreadd]
root           4  0.0  0.0      0     0 ?        S&lt;   Jul01   0:00 <span class="o">[</span>kworker/0:0H]
root           6  0.0  0.0      0     0 ?        S    Jul01   0:35 <span class="o">[</span>ksoftirqd/0]
root           7  0.0  0.0      0     0 ?        S    Jul01   0:07 <span class="o">[</span>migration/0]
root           8  0.0  0.0      0     0 ?        S    Jul01   0:00 <span class="o">[</span>rcu_bh]
root           9  0.0  0.0      0     0 ?        S    Jul01  37:47 <span class="o">[</span>rcu_sched]
root          10  0.0  0.0      0     0 ?        S&lt;   Jul01   0:00 <span class="o">[</span>lru-add-drain]
root          11  0.0  0.0      0     0 ?        S    Jul01   0:22 <span class="o">[</span>watchdog/0]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Se fossemos falar em processos no nosso exemplo da biblioteca, ter√≠amos que criar uma biblioteca nova. Como eu disse, dois processo compartilham recursos mas isso n√£o significa que eles podem acessar o mesmo recurso ao mesmo tempo. Por exemplo, se eu tenho um servidor rodando na porta 80, n√£o posso iniciar outro processo na porta 80. Um processo n√£o tem acesso a mem√≥ria de outro processo, isso significa que para um mesmo objeto n√£o pode existir em dois processos diferentes. (<em>At√© pode, mas n√£o vamos falar de RMI porque √© complicado e j√° foi removido da biblioteca padr√£o do Java</em>.)</p>
</div>
<div class="paragraph">
<p><em>‚Äî  E se eu quiser que as requisi√ß√µes que cheguem na porta 80 sejam processadas em paralelo, como fa√ßo?!?!</em></p>
</div>
<div class="paragraph">
<p>Lembra da nossa biblioteca? Pois √©, cada biblioteca √© um processo, mas cada bibliotec√°rio √© uma <em>Thread</em>. <em>Thread</em> s√£o dois fluxos que compartilham o mesmo espa√ßo de mem√≥ria, ou seja, √© quando um processo tem dois fluxos de execu√ß√£o em paralelo compartilhando recursos. Threads podem acessar a mesma porta, assim como podem acessar os mesmo objetos. Mas ele n√£o podem ser feitas ao mesmo momento. Lembra do computador do balc√£o da biblioteca? A met√°fora da biblioteca foi constru√≠da para similar exatamente o que acontece em um computador.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cap-06-thread-e-processo-em-java">Thread e Processo em Java</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vamos agora mostrar algumas classes que podemos usar para manipular processos e threads usando Java. Uma das preocupa√ß√µes da plataforma Java foi criar uma abstra√ß√£o para que o mesmo c√≥digo possa ser usado em qualquer sistema operacional, logo todo o c√≥digo demonstrado pode ser executando tando em Linux quando Windows e sistemas derivados do Unix como o MacOS.</p>
</div>
<div class="sect2">
<h3 id="_processos">Processos</h3>
<div class="paragraph">
<p>Para que possamos acessar as informa√ß√µes de todos os processos em execu√ß√£o podemos usar a classe <a href="https://docs.oracle.com/javase/9/docs/api/java/lang/ProcessHandle.html">ProcessHandle</a> (<em>adicionada no Java 9</em>). Navegue pela documenta√ß√£o dela para perceber que processos podem ter uma rela√ß√£o de parentescos como podemos perceber atrav√©s dos m√©todos <code>children()</code>, <code>descendants‚Äã()</code> e <code>parent‚Äã()</code>. Na execu√ß√£o abaixo vemos as informa√ß√µes do processo atual e a listagem de todos os processos em execu√ß√£o.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="err">$</span> <span class="n">jshell</span>
<span class="o">|</span>  <span class="nc">Welcome</span> <span class="n">to</span> <span class="nc">JShell</span> <span class="o">--</span> <span class="nc">Version</span> <span class="mi">18</span>
<span class="o">|</span>  <span class="nc">For</span> <span class="n">an</span> <span class="n">introduction</span> <span class="nl">type:</span> <span class="o">/</span><span class="n">help</span> <span class="n">intro</span>

<span class="n">jshell</span><span class="o">&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ProcessHandle</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">pid</span><span class="o">());</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ProcessHandle</span><span class="o">.</span><span class="na">current</span>  <span class="o">.</span><span class="na">pid</span><span class="o">()</span>  <span class="o">);</span>
<span class="mi">20092</span>

<span class="n">jshell</span><span class="o">&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ProcessHandle</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">info</span><span class="o">());</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ProcessHandle</span><span class="o">.</span><span class="na">current</span>  <span class="o">.</span><span class="na">info</span>  <span class="o">);</span>
<span class="o">[</span><span class="nl">user:</span> <span class="nc">Optional</span><span class="o">[</span><span class="no">VEPO</span><span class="o">],</span> <span class="nl">cmd:</span> <span class="nl">C:</span><span class="err">\</span><span class="nc">Users</span><span class="err">\</span><span class="n">vepo</span><span class="err">\</span><span class="o">.</span><span class="na">sdkman</span><span class="err">\</span><span class="n">candidates</span><span class="err">\</span><span class="n">java</span><span class="err">\</span><span class="mi">18</span><span class="o">-</span><span class="n">open</span><span class="err">\</span><span class="n">bin</span><span class="err">\</span><span class="n">java</span><span class="o">.</span><span class="na">exe</span><span class="o">,</span> <span class="nl">startTime:</span> <span class="nc">Optional</span><span class="o">[</span><span class="mi">2022</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mo">02</span><span class="nl">T18:</span><span class="mi">49</span><span class="o">:</span><span class="mf">28.093</span><span class="no">Z</span><span class="o">],</span> <span class="nl">totalTime:</span> <span class="nc">Optional</span><span class="o">[</span><span class="no">PT0</span><span class="o">.</span><span class="mi">328125</span><span class="no">S</span><span class="o">]]</span>

<span class="n">jshell</span><span class="o">&gt;</span> <span class="nc">ProcessHandle</span><span class="o">.</span><span class="na">allProcesses</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="nc">ProcessHandle</span><span class="o">.</span><span class="na">allProcesses</span>  <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="mi">0</span>
<span class="mi">4</span>
<span class="mi">72</span>
<span class="o">[...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Caso voc√™ deseje criar um novo processo, √© preciso fazer uma chamada de sistema usando a classe <a href="https://docs.oracle.com/javase/9/docs/api/java/lang/Runtime.html">Runtime</a>. No trecho de c√≥digo abaixo usamos o m√©todo <code>exec</code> para criar um novo processo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">jshell</span><span class="o">&gt;</span> <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"pwd"</span><span class="o">)</span>
<span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span>  <span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="s">"pwd"</span><span class="o">)</span>
<span class="err">$</span><span class="mi">4</span> <span class="o">==&gt;</span> <span class="nc">Process</span><span class="o">[</span><span class="n">pid</span><span class="o">=</span><span class="mi">19628</span><span class="o">,</span> <span class="n">exitValue</span><span class="o">=</span><span class="s">"not exited"</span><span class="o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Na resposta da execu√ß√£o podemos ver que o m√©todo <code>exec</code> retorna o novo processo, mas n√£o espera por ele terminar, retornando apenas um objeto <a href="https://docs.oracle.com/javase/9/docs/api/java/lang/Process.html">Process</a> para poder ser manipulado. Em posse desse objeto, podemos esperar por ele terminar e ver se a execu√ß√£o foi um sucesso.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">jshell</span><span class="o">&gt;</span> <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"pwd"</span><span class="o">).</span><span class="na">waitFor</span><span class="o">()</span>
<span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span>  <span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="s">"pwd"</span><span class="o">).</span><span class="na">waitFor</span>
<span class="err">$</span><span class="mi">5</span> <span class="o">==&gt;</span> <span class="mi">0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Percebeu que o m√©todo <code>waitFor</code> retornou <strong>0</strong>? Todo processo precisa finalizar com um n√∫mero e zero significa sucesso. Qualquer n√∫mero diferente de zero significa que o programa foi finalizado com erro. O programa que eu executei acima √© o <code>pwd</code> que retorna o diret√≥rio corrente em Linux, apesar de usar Windows uso o Git Bash que √© um porte do MinGW que simula um bash Linux.</p>
</div>
</div>
<div class="sect2">
<h3 id="_threads">Threads</h3>
<div class="paragraph">
<p><em>Threads</em> tamb√©m s√£o criadas pelo sistemas operacional, mas o Java d√° suporte a duas bibliotecas bem interessantes que precisamos demonstrar. A primeira √© a classe <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/lang/Thread.html">Threads</a> que deve ser usada com muita parcim√¥nia essa classe, o livro <a href="https://www.amazon.com.br/Java-Efetivo-Melhores-Pr%C3%A1ticas-Plataforma/dp/8550804622?crid=6C287ENLSDOW&amp;keywords=java+efetivo&amp;qid=1662253615&amp;sprefix=java+ef%2Caps%2C363&amp;sr=8-1&amp;linkCode=ll1&amp;tag=vepo0f-20&amp;linkId=092f42dffa52d29c336aacab87c58558&amp;language=pt_BR&amp;ref_=as_li_ss_tl">Java Efetivo</a> nos diz no <strong>Item 80: D√™ prefer√™ncia aos executores, √†s tarefas e √†s streams em vez de threads</strong>. Os <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/Executors.html">Executors</a> s√£o a proxima classe que vamos ver que podem entregar as mesmas funcionalidades.</p>
</div>
<div class="paragraph">
<p><em>‚Äî Ent√£o porque entender Threads?!?!</em></p>
</div>
<div class="paragraph">
<p><em>Threads</em> s√£o importantes porque s√£o um conceito do sistema operacional. Um executor n√£o elimina uma thread, ele apenas facilita a implementa√ß√£o delas e otimiza o seu uso. Threads s√£o gerenciadas pelo Sistema Operacional. O tempo de CPU ser√° dividido entre os processos e as threads. Isso significa que se seu computador tem 4 CPUs e seu programa tem ao menos 2 threads, √© prov√°vel que em algum momento seu programa esteja rodando em 2 CPUs ao mesmo tempo, mas quem define isso √© o sistema operacional.</p>
</div>
<div class="paragraph">
<p>Threads s√£o um recurso do sistema operacional limitado e caro. No Windows isso n√£o √© transparente, mas no Linux √© poss√≠vel acessar essas informa√ß√µes facilmente atrav√©s do arquivo <code>/proc/sys/kernel/threads-max</code>. Na execu√ß√£o abaixo vemos que essa inst√¢ncia do Linux s√≥ pode rodar 32.768 processos concorrentes e 100.435 threads concorrentes, o que d√° em m√©dia 3 threads por processo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cat</span> /proc/sys/kernel/threads-max
100435

<span class="nv">$ </span><span class="nb">cat</span> /proc/sys/kernel/pid_max
32768</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>‚Äî Mas 3 threads por processo n√£o √© muito pouco?!?!</em></p>
</div>
<div class="paragraph">
<p>N√£o! Porque √© praticamente imposs√≠vel rodar 32.768 processos concorrentes e a grande maioria dos processos tem apenas uma thread rodando.</p>
</div>
<div class="paragraph">
<p><em>‚Äî Mas o que acontece quando o Java pede uma thread nova?</em></p>
</div>
<div class="paragraph">
<p>Para entender isso, precisamos compreender outro conceito importante de Sistemas Operacionais o espa√ßo do usu√°rio e o espa√ßo do kernel (<a href="https://pt.wikipedia.org/wiki/Espa%C3%A7o_de_usu%C3%A1rio"><em>user space</em> e <em>kernel space</em></a>). Espa√ßo do usu√°rio √© todo o c√≥digo dos nossos programas, j√° o espa√ßo do kernel √© o c√≥digo do sistema operacional que nossos programas usam para realizar algumas opera√ß√µes. Toda opera√ß√£o que sai do espa√ßo do usu√°rio e vai para o espa√ßo do kernel √© custosa porque pode envolver recursos compartilhados como sockets, arquivos ou threads. Logo, criar uma nova thread √© custoso porque tem que criar uma nova thread no sistema operacional que n√£o √© apenas alocar um espa√ßo na mem√≥ria.</p>
</div>
<div class="paragraph">
<p>No c√≥digo abaixo uma thread √© criada que sua √∫nica fun√ß√£o √© pegar o instante em que √© iniciada, dormir por 500ms e armazenar o instante em que ela √© finalizada. Os tempos deve ser armazenados no array tempos porque nenhuma vari√°vel pode ser alterada diretamente entre duas threads que n√£o seja uma vari√°vel <code>final</code>, pois estamos falando de duas pilhas de execu√ß√£o diferentes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">long</span><span class="o">[]</span> <span class="n">tempos</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">long</span><span class="o">[</span><span class="mi">4</span><span class="o">];</span>
<span class="n">tempos</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
<span class="nc">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">tempos</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">tempos</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">};</span>
<span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">t</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
<span class="o">}</span>
<span class="n">tempos</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Tempo de inicializa√ß√£o: %d¬µs"</span><span class="o">,</span> <span class="o">(</span><span class="n">tempos</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">-</span> <span class="n">tempos</span><span class="o">[</span><span class="mi">0</span><span class="o">])</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">));</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Tempo de execu√ß√£o     : %d¬µs"</span><span class="o">,</span> <span class="o">(</span><span class="n">tempos</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">-</span> <span class="n">tempos</span><span class="o">[</span><span class="mi">1</span><span class="o">])</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">));</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Tempo total           : %d¬µs"</span><span class="o">,</span> <span class="o">(</span><span class="n">tempos</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="o">-</span> <span class="n">tempos</span><span class="o">[</span><span class="mi">0</span><span class="o">])</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>O resultado da execu√ß√£o √© o visto abaixo, observe que demora quase meio milissegundo para que a thread seja iniciada. Esse tempo pode parecer pouco, mas se houver um uso abusivo dessa classe pode impactar a performance, pois esse tempo √© lat√™ncia adicionada ao processamento.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>Tempo de inicializa√ß√£o: 436¬µs
Tempo de execu√ß√£o     : 510061¬µs
Tempo total           : 510643¬µs</code></pre>
</div>
</div>
<div class="paragraph">
<p>Observe tamb√©m que usamos os m√©todos <code>start</code> e <code>join</code>, eles servem para controlar a thread. Uma thread n√£o inicia sua execu√ß√£o imediatamente, √© preciso que o c√≥digo que a instanciou dispare a execu√ß√£o. Mas quando a execu√ß√£o se inicia os dois c√≥digos come√ßam a ser executados em paralelo, para que se aguarde a finaliza√ß√£o da thread √© preciso usar o m√©todo <code>join</code> que far√° com que a thread corrente seja bloqueada at√© que a outra seja finalizada.</p>
</div>
<div class="paragraph">
<p>Outro ponto importante √© o uso da exce√ß√£o <code>InterruptedException</code>, ela √© lan√ßada pela JVM toda vez que a thread √© interrompida pelo sistema operacional.</p>
</div>
<div class="paragraph">
<p><em>‚Äî Mas o que significa a thread ser interrompida pelo sistema operacional?</em></p>
</div>
<div class="paragraph">
<p>Ora, j√° teve vezes em que uma janelinha do Windows ficou n√£o responsiva e voc√™ foi l√° for√ßou ela a ser fechada? Ou voc√™ executou um comando no bash e n√£o quis esperar a resposta e pressionou <strong>CRTL + C</strong>. Nessa hora o sistema operacional envia um sinal ao programa que ele deve finalizar, o <a href="https://pt.wikipedia.org/wiki/SIGTERM">SIGTERM</a>. Quando esse sinal √© recebido pela thread, ela deve liberar todos os recursos e se finalizar, por isso quanto tempos uma <code>InterruptedException</code> √© hora de limpar a casa e fechar tudo.</p>
</div>
<div class="paragraph">
<p>Se voc√™ ignorar essa exception, o seu processo pode virar um <a href="https://pt.wikipedia.org/wiki/Processo_zombie">processo zumbi</a>, pois outras threads podem ter obedecido o sinal e j√° ter finalizada criando instabilidade para a execu√ß√£o. Ent√£o, recebeu um <code>InterruptedException</code>, fecha tudo e chama <code>Thread.currentThread().interrupt()</code>.</p>
</div>
<div class="paragraph">
<p>H√° um outro sinal que n√£o fornece essa informa√ß√£o, o <a href="https://pt.wikipedia.org/wiki/SIGKILL">SIGKILL</a>, o sistema operacional simplesmente mata a execu√ß√£o sem nenhuma educa√ß√£o e protocolo.</p>
</div>
<div class="paragraph">
<p>Por fim, voc√™ deve ter reparado que implementamos o m√©todo <code>run</code> na thread. Esse m√©todo √© definido na classe <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/lang/Runnable.html">Runnable</a>, essa classe √© muito importante porque nem sempre precisamos definir uma thread nova, podemos estender essa classe e criar quantas threads forem necess√°ria com o mesmo c√≥digo.</p>
</div>
<div class="paragraph">
<p>Existe a possibilidade de se criar grupos de threads com a classe <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/ThreadGroup.html">ThreadGroup</a>, mas n√£o vamos abordar ela porque todas as funcionalidades delas podem ser endere√ßadas com Executors.</p>
</div>
</div>
<div class="sect2">
<h3 id="_executors">Executors</h3>
<div class="paragraph">
<p>Executors s√£o a nova, <em>em rela√ß√£o a Thread</em>, biblioteca adicionada no Java 5 que permite um controle melhor sobre Threads e grupos de threads. A vantagem do uso da classe Executors √© que temos uma interface bem mais interessante, como veremos a diante. Primeiro vamos focar em performance.</p>
</div>
<div class="paragraph">
<p>Como falamos, criar thread pode ser uma opera√ß√£o cara, com executors podemos criar pool de threads ou reutilizar threads j√° existentes sem a necessidade de se criar novas threads. Se compararmos a execu√ß√£o vemos que o uso de pools de thread diminuem o tempo gasto com a inicializa√ß√£o dessas threads. Nos teste que executamos, vemos que o tempo de inicializa√ß√£o e o tempo m√©dio total s√£o menores, somente o tempo m√©dio de execu√ß√£o √© maior, mas isso √© devido a fatores externos ao c√≥digo j√° que executamos o mesmo c√≥digo em ambos o caso.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>Usando Threads
Tempo de inicializa√ß√£o: 402¬µs
Tempo de execu√ß√£o     : 511415¬µs
Tempo total           : 511939¬µs

Tempo m√©dio de inicializa√ß√£o: 77370¬µs
Tempo m√©dio de execu√ß√£o     : 50792817¬µs
Tempo m√©dio total           : 50880048¬µs

Usando Executors
Tempo de inicializa√ß√£o: 2829¬µs    (+2.427¬µs)
Tempo de execu√ß√£o     : 509877¬µs  (-1.538¬µs)
Tempo total           : 513237¬µs  (+1.298¬µs)

Tempo m√©dio de inicializa√ß√£o: 19708¬µs    (-57.662¬µs)
Tempo m√©dio de execu√ß√£o     : 50806122¬µs (+13.305¬µs)
Tempo m√©dio total           : 50839674¬µs (-40.374¬µs)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para se criar um <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/ExecutorService.html"><code>ExecutorService</code></a> deve se usar a classe <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/Executors.html"><code>Executors</code></a>. Nessa classe tempos v√°rios tipos de ExecutorServices, mas os mais importantes s√£o os <strong>FixedThreadPool</strong>, <strong>CachedThreadPool</strong> e <strong>ScheduledThreadPool</strong>. Cada um desses tem suas peculiaridades que n√£o vamos abordar aqui, apenas vamos ressaltar que <strong>ScheduledThreadPool</strong> deve ser usado quando precisamos criar threads que executam em intervalos pr√© definidos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">long</span><span class="o">[]</span> <span class="n">tempos</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">long</span><span class="o">[</span><span class="mi">4</span><span class="o">];</span>
<span class="n">tempos</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
<span class="nc">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newSingleThreadExecutor</span><span class="o">();</span>
<span class="nc">Future</span><span class="o">&lt;?&gt;</span> <span class="n">ft</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">tempos</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">tempos</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
    <span class="o">});</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">ft</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
<span class="o">}</span>
<span class="n">tempos</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Tempo de inicializa√ß√£o: %d¬µs"</span><span class="o">,</span> <span class="o">(</span><span class="n">tempos</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">-</span> <span class="n">tempos</span><span class="o">[</span><span class="mi">0</span><span class="o">])</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">));</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Tempo de execu√ß√£o     : %d¬µs"</span><span class="o">,</span> <span class="o">(</span><span class="n">tempos</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">-</span> <span class="n">tempos</span><span class="o">[</span><span class="mi">1</span><span class="o">])</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">));</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Tempo total           : %d¬µs"</span><span class="o">,</span> <span class="o">(</span><span class="n">tempos</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="o">-</span> <span class="n">tempos</span><span class="o">[</span><span class="mi">0</span><span class="o">])</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">));</span>
<span class="n">executor</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A grande diferen√ßa √© que quando criamos uma nova execu√ß√£o o ExecutorService retorna um <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/Future.html"><code>Future</code></a> que ir√° prover informa√ß√µes sobre a execu√ß√£o e o retorno da execu√ß√£o. Um executor n√£o aceita apenas um <code>Runnable</code>, mas tamb√©m <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/Callable.html"><code>Callable</code></a> que retorna valores. A op√ß√£o por usar <code>Callable</code> ir√° tornar seu c√≥digo mais leg√≠vel.</p>
</div>
<div class="paragraph">
<p>Outro ponto importante do uso de <code>ExecutorService</code> √© que assim que uma nova atividade √© submetida, ela entrar√° na fila de execu√ß√£o. √â preciso ressaltar que ela s√≥ ser√° executada quando houver thread dispon√≠vel. Isso significa que um <code>ExecutorService</code> deve ser usado para atividades r√°pidas e n√£o com longa dura√ß√£o. Se voc√™ precisar executar algo que dure toda execu√ß√£o crie um ExecutorService de tamanho pr√©-definido, usando <code>newFixedThreadPool</code> ou cria a thread manualmente.</p>
</div>
<div class="paragraph">
<p>Por fim um ExecutorService n√£o finaliza automaticamente, ele deve ser finalizado atrav√©s do m√©todo <code>shutdown</code>. Caso voc√™ n√£o chame esse m√©todo o seu programa vai virar um processo zumbi.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cap-06-controle-concorrencia">Controle de Concorr√™ncia</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Como vimos concorr√™ncia √© um problema diferente de paralelismo, ela √© a solu√ß√£o para garantir que apenas uma thread est√° executando um trecho de c√≥digo. As solu√ß√µes de concorr√™ncia da JVM s√£o propostas para que seja usadas dentro de uma mesma inst√¢ncia da JVM, ou seja, n√£o √© poss√≠vel pela biblioteca padr√£o garantir concorr√™ncia entre dois processos distintos.</p>
</div>
<div class="paragraph">
<p>Vamos come√ßar a ver pelos modos mais antigos, mesmo que eles j√° n√£o sejam os mais utilizados. O primeiro dele √© o mais simples de todos, usar o modificado <code>synchronized</code>. No trecho de c√≥digo abaixo, o <code>synchronized</code> permite que o de counter seja impresso na linha de comando sequencialmente, caso seja removido valores repetidos e fora de ordem aparecer√£o. O <code>synchronized</code> vai garantir que quando uma thread est√° executando o m√©todo <code>printAndIncrement</code> as outras ser√£o bloqueadas at√© que a execu√ß√£o seja finalizada. Quando usamos o <code>synchronized</code> em um m√©todo de inst√¢ncia, o efeito do bloqueio s√≥ acontece quando m√©todo de um mesmo objeto s√£o executados concorrentemente, caso o controle de concorr√™ncia deva ser feito globalmente o <code>synchronized</code> pode ser usado em m√©todos est√°ticos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Sync</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">counter</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Sync</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">printAndIncrement</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">counter</span><span class="o">++;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Thread [%s] valor:%d"</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">counter</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Usar o modificador <code>synchronized</code> ainda √© uma pr√°tica bem comum apesar que existem solu√ß√µes melhores. Ele deve ser usado quando √© realmente necess√°rio bloquear todo o bloco de execu√ß√£o. Se voc√™ precisa usar em uma das classes da biblioteca Collection (vista na sess√£o 3) a melhor solu√ß√£o √© usar uma das classes da biblioteca padr√£o do Java. A classe <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/Collections.html"><code>Collections</code></a> tem alguns m√©todos que criam um envolucro para objetos, por exemplo, se eu tenho uma lista e desejo usar ela em v√°rias threads, eu posso usar <code>Collections.synchronizedList(minhaLista)</code>.</p>
</div>
<div class="paragraph">
<p>Observe no trecho de c√≥digo abaixo que temos duas listas mas apenas a segunda pode ser usada em v√°rias threads. Qualquer opera√ß√£o na segunda lista reflete na primeira. Usar uma lista n√£o sincronizada pode ser que n√£o fa√ßa o programa apresentar uma exce√ß√£o, mas com certeza vai criar estados inconsistentes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="err">$</span> <span class="n">jshell</span>
<span class="o">|</span>  <span class="nc">Welcome</span> <span class="n">to</span> <span class="nc">JShell</span> <span class="o">--</span> <span class="nc">Version</span> <span class="mi">18</span>
<span class="o">|</span>  <span class="nc">For</span> <span class="n">an</span> <span class="n">introduction</span> <span class="nl">type:</span> <span class="o">/</span><span class="n">help</span> <span class="n">intro</span>

<span class="n">jshell</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">minhaLista</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">minhaLista</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;</span>  <span class="o">;</span>
<span class="n">minhaLista</span> <span class="o">==&gt;</span> <span class="o">[]</span>

<span class="n">jshell</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">minhaListaSync</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span><span class="n">minhaLista</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">minhaListaSync</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span><span class="n">minhaLista</span><span class="o">);</span>
<span class="n">minhaListaSync</span> <span class="o">==&gt;</span> <span class="o">[]</span>

<span class="n">jshell</span><span class="o">&gt;</span> <span class="n">minhaLista</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"String 1"</span><span class="o">)</span>
<span class="n">minhaLista</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"String 1"</span><span class="o">)</span>
<span class="err">$</span><span class="mi">3</span> <span class="o">==&gt;</span> <span class="kc">true</span>

<span class="n">jshell</span><span class="o">&gt;</span> <span class="n">minhaListaSync</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"String 2"</span><span class="o">)</span>
<span class="n">minhaListaSync</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"String 2"</span><span class="o">)</span>
<span class="err">$</span><span class="mi">4</span> <span class="o">==&gt;</span> <span class="kc">true</span>

<span class="n">jshell</span><span class="o">&gt;</span> <span class="n">minhaLista</span>
<span class="n">minhaLista</span>
<span class="n">minhaLista</span> <span class="o">==&gt;</span> <span class="o">[</span><span class="nc">String</span> <span class="mi">1</span><span class="o">,</span> <span class="nc">String</span> <span class="mi">2</span><span class="o">]</span>

<span class="n">jshell</span><span class="o">&gt;</span> <span class="n">minhaListaSync</span>
<span class="n">minhaListaSync</span>
<span class="n">minhaListaSync</span> <span class="o">==&gt;</span> <span class="o">[</span><span class="nc">String</span> <span class="mi">1</span><span class="o">,</span> <span class="nc">String</span> <span class="mi">2</span><span class="o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>O <code>synchronized</code> tamb√©m pode ser usado como bloco de c√≥digo, mas essa √© uma forma um pouco arcaica como veremos. Vamos imagina que temos duas threads, uma produzindo valores e a outra consumindo. A thread que consome valores deve sempre retornar um valor, n√£o importa se n√£o existe valores no momento. Normalmente isso √© o que acontece quando temos um buffer em quem uma thread est√° produzindo e outra consumindo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Buffer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">[]&gt;</span> <span class="n">_buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">valores</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span><span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">_buffer</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">valores</span><span class="o">);</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span><span class="o">[]</span> <span class="nf">consume</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">nextValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kd">synchronized</span><span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">while</span><span class="o">(</span><span class="n">_buffer</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">nextValue</span> <span class="o">=</span> <span class="n">_buffer</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">nextValue</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A classe acima est√° implementada usando t√©cnicas que n√£o devem mais ser usadas. O primeiro problema √© que toda chamada ao bloco sincronizado ser√° feita por apenas uma thread por vez, existe t√©cnicas mais recentes que permitem que mais de uma thread acessem um bloco sincronizado que veremos a seguir. O bloco sincronizado deve ser feito usando um objeto em comum, no caso esse objeto pode ser compartilhado em mais de um objeto, caso a thread deseje esperar por alguma condi√ß√£o, deve se usar o m√©todo <code>wait</code> que ser√° despertado por uma chamada ao m√©todo <code>notify</code> ou <code>notifyAll</code>. No exemplo acima, se n√£o h√° valores a serem consumidos, eles devem esperar por um valor.</p>
</div>
<div class="paragraph">
<p>Uma alternativa ao bloco sincronizado √© o uso da classe <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/locks/ReadWriteLock.html">ReadWriteLock</a>. A necessidade dessa classe surgem quando se percebe que apenas as threads que escrevem devem ter acesso exclusivo, as threads de leitura podem acessar os m√©todos livremente. No exemplo acima n√£o √© poss√≠vel usar ela porque ambos os m√©todos escrevem ao adicionar e remover valores na lista por isso ser√£o necess√°rias algumas altera√ß√µes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Buffer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ReadWriteLock</span> <span class="n">readWriteLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Lock</span> <span class="n">readLock</span> <span class="o">=</span> <span class="n">readWriteLock</span><span class="o">.</span><span class="na">readLock</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Lock</span> <span class="n">writeLock</span> <span class="o">=</span> <span class="n">readWriteLock</span><span class="o">.</span><span class="na">writeLock</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Condition</span> <span class="n">newItem</span> <span class="o">=</span> <span class="n">writeLock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">[]&gt;</span> <span class="n">_buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">valores</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">writeLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">_buffer</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">valores</span><span class="o">);</span>
            <span class="n">newItem</span><span class="o">.</span><span class="na">signalAll</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">writeLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">available</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">readLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">_buffer</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">readLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span><span class="o">[]</span> <span class="nf">consume</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">readLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">_buffer</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">newItem</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">_buffer</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">readLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Na nossa nova classe <code>Buffer</code>, quem √© respons√°vel por saber a posi√ß√£o no buffer √© a thread que consome que pode ser mais de uma. Cada chamada ao m√©todo <code>consome</code> e <code>available</code> poder√£o ser feitas sem nenhum bloqueio. Mas se uma chamada ao m√©todo <code>add</code> for feita, ela dever√° esperar pela finaliza√ß√£o de todas as chamadas aos locks de leitura e todos os locks de leitura dever√£o esperar pela finaliza√ß√£o do lock de escrita. Os locks de leitura podem ser executados concorrentemente, mas o lock de escrita s√≥ pode acontecer quando nenhum outro lock estiver ativo.</p>
</div>
<div class="paragraph">
<p>No c√≥digo acima podemos ver tamb√©m o uso da classe <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/locks/Condition.html"><code>Condition</code></a>. Essa classe deve ser usada quando esperamos alguma condi√ß√£o especifica, no nosso caso √© a lista ter o item desejado ou n√£o. O uso dessa classe √© bem similar ao dos m√©todos <code>wait</code>, <code>notify</code> e <code>notifyAll</code>, mas √© adicionada uma melhor sem√¢ntica pode podemos criar mais que uma condi√ß√£o e usar elas para dar uma boa legibilidade ao c√≥digo.</p>
</div>
<div class="paragraph">
<p>Por fim a biblioteca padr√£o do Java tem uma s√©rie de classes at√¥micas que s√£o extremamente √∫teis. Elas est√£o no pacote <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/concurrent/atomic/package-summary.html"><code>java.util.concurrent.atomic</code></a> e todas elas tem comportamento similar, v√£o permitir voc√™ realizar opera√ß√µes at√¥micas sem se preocupar com a concorr√™ncia. Para demonstrar o uso delas vou mostrar o caso mais comum que √© criar um contador sincronizado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">15</span><span class="o">);</span>
<span class="nc">AtomicInteger</span> <span class="n">counter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Future</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">allFuture</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1_000</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">allFuture</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Contador: "</span> <span class="o">+</span> <span class="n">counter</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">())));</span>
<span class="o">}</span>
<span class="n">executor</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">executor</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>No c√≥digo acima n√£o podemos garantir que os valores impressos estar√£o em ordem, mas podemos garantir que todos os valores de 1 a 1000 ser√£o impressos. A classe <code>AtomicInteger</code> garante que a opera√ß√£o <code>incrementAndGet</code> seja feita atomicamente, isso significa que ela n√£o ser√° interrompida por outra chamada a outro m√©todo desse mesmo objeto. Todas as classes desse pacote merecem nossa aten√ß√£o pois elas s√£o bem importantes, principalmente se voc√™ est√° desenvolvendo um aplicativo Desktop que ir√° lidar com v√°rias threads.</p>
</div>
</div>
</div>]]></content><author><name>{&quot;twitter&quot;=&gt;&quot;vepo&quot;, &quot;linkedin&quot;=&gt;&quot;https://www.linkedin.com/in/victorosorio/&quot;, &quot;picture&quot;=&gt;&quot;/assets/images/me.avif&quot;}</name></author><category term="Java" /><category term="Tutorial" /><category term="Threads" /><category term="Concorr√™ncia" /><category term="Paralelismo" /><summary type="html"><![CDATA[O que eu preciso saber de concorr√™ncia e paralelismo para desenvolver usando Java? A ideia desta s√©rie √© criar um tutorial Java onde mostrarei todos os segredos da linguagem e do ecossistema.]]></summary></entry><entry><title type="html">Java I/O</title><link href="https://blog.vepo.dev/posts/java-101-io" rel="alternate" type="text/html" title="Java I/O" /><published>2022-07-04T00:00:00+00:00</published><updated>2022-07-04T00:00:00+00:00</updated><id>https://blog.vepo.dev/posts/23-53-00-java101-io</id><content type="html" xml:base="https://blog.vepo.dev/posts/java-101-io"><![CDATA[<div class="paragraph">
<p>Esse post faz parte de uma s√©rie introdut√≥ria sobre Java, se voc√™ n√£o conhece a linguagem e n√£o leu os posts anteriores, recomendo os ler para ter uma vis√£o melhor da plataforma. Nessa s√©rie, j√° falamos sobre o que √© o ecossistema Java, o que √© a biblioteca Collections e como Java faz Orienta√ß√£o a Objetos, esses t√≥picos s√£o necess√°rios para o que vamos falar agora: <strong>I/O</strong>.</p>
</div>
<div class="sect1">
<h2 id="cap-05-o-que-e-io">O que √© I/O?!?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quando pensamos em um computador a primeira coisa que pensamos √© no que fazemos online: enviar um tweet, responder email, ver um v√≠deo ou mesmo ler esse post. Mas um computador n√£o entende essas atividades, para ele tudo s√£o bits, ou seja, todas essa s√£o atividades podem ser traduzidas em outras atividades de baixo n√≠vel. Quando eu uso o termo "baixo n√≠vel" entenda como algo de menor abstra√ß√£o, por exemplo, para voc√™ ler esse post, o seu navegador teve que renderizar uma p√°gina HTML, que foi requisitada de um servidor HTTP usando uma conex√£o Socket, que na verdade √© apenas uma troca de bits entre v√°rios computadores. Essas atividades sempre envolvem trocas de informa√ß√µes que s√≥ s√£o poss√≠vel atrav√©s de algo chamado <strong>serializa√ß√£o</strong>.</p>
</div>
<div class="paragraph">
<p><strong>Serializa√ß√£o</strong> seria a transforma√ß√£o de uma informa√ß√£o em um formato intermedi√°rio para que ela possa transitar entre dois processos. Ou seja, a informa√ß√£o que voc√™ est√° lendo agora √© composta de alguns arquivos HTML, Javascript, CSS, PNG e JPEG que s√£o enviadas atrav√©s da web usando o protocolo HTTP sobre TLS.</p>
</div>
<div class="paragraph">
<p><em>‚Äî  Voc√™ n√£o ia falar de I/O? Que papo √© esse de <strong>serializa√ß√£o</strong> e internet?!?</em></p>
</div>
<div class="paragraph">
<p>Sim, I/O √© outra forma de falar sobre serializa√ß√£o. Toda informa√ß√£o para ser enviada ela passa pelos passos de (1) serializa√ß√£o, (2) escrita, (3) transmiss√£o, (4) leitura e (5) desserializa√ß√£o. O processo de transmiss√£o pode ser o envio dessa informa√ß√£o atrav√©s de uma API, ou o armazenamento dela em um banco de dados ou mesmo a escrita no disco para que possa ser lida no futuro. Os formatos de serializa√ß√£o de dados s√£o bem interessantes de se analisar, mas n√£o √© o foco desse post, aqui focaremos em conhecer as bibliotecas que a JVM nos oferece para que possamos ler e escrever objetos onde bem desejarmos.</p>
</div>
<div class="paragraph">
<p>Na JVM existem dois pacotes que lidam com serializa√ß√£o em Java. O mais conhecido deles √© o <a href="https://docs.oracle.com/javase/8/docs/api/java/io/package-summary.html"><code>java.io</code></a> onde est√£o definidas as classes para leitura s√≠ncrona. J√° no <a href="https://docs.oracle.com/javase/8/docs/api/java/nio/package-summary.html"><code>java.nio</code></a> est√£o definidas as classes para leitura ass√≠ncrona (Non-blocking I/O).</p>
</div>
<div class="paragraph">
<p>Seria hipocrisia da minha parte dizer que voc√™ deve conhecer esses pacotes por completo, eu n√£o os conhe√ßo. S√≥ quem trabalha especificamente com I/O deve conhecer bem essas classes. N√£o se surpreenda se um desenvolvedor com anos de experi√™ncia em Java procurar no Google <em>"how to read a text file in Java"</em>. Isso acontece porque esses pacotes s√£o complexos e por isso dif√≠ceis de serem internalizados. Mas voc√™ deve saber algumas informa√ß√µes importantes e n√≥s vamos trabalhar elas aqui.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Porque a interface <code>Serializable</code>? Devo usar?</p>
</li>
<li>
<p>O que √© um <code>InputStream</code> e um <code>OutputStream</code>?</p>
</li>
<li>
<p>Qual Stream devo usar?</p>
</li>
<li>
<p>Qual a diferen√ßa entre um Stream e os Readers/Writers?</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>N√≥s n√£o vamos falar de NIO, esse ser√° o assunto de um post mais a frente. N√£o estranhe se voc√™ perceber que um S√™nior n√£o sabe como usar as classes desse pacote, em muitos casos elas s√£o usadas apenas pelos frameworks o que implica que muitos desenvolvedores nunca tiveram contato com ela.</p>
</div>
<div class="sect2">
<h3 id="_a-diferen√ßa-entre-io-e-nio">A diferen√ßa entre IO e NIO</h3>
<div class="paragraph">
<p>Talvez voc√™ tenha ficado curioso do motivo de existirem dois pacotes para I/O. N√£o ficou? Bom, existem dois pacotes diferentes porque NIO √© um conceito muito mais novo do que IO. IO existe desde que os computadores existem e sempre foi um problema para qualquer software. Se voc√™ n√£o fez faculdade de Ci√™ncia da Computa√ß√£o, saiba que existe at√© uma mat√©ria s√≥ pensando em como se criar estrutura de dados para arquivos, isso porque ao se ler um arquivos nos deparamos com alguns problemas que deveriam ser √≥bvios: (1) o tempo de leitura √© muito inferior ao tempo de acesso a mem√≥ria, (2) os dados s√£o armazenados em blocos que n√£o s√£o facilmente rearranj√°veis e (3) a leitura de blocos pr√≥ximos √© mais r√°pida que a leitura de blocos distantes. Os discos mais novos n√£o possuem o problema (3), mas mesmo assim ler e escrever de arquivo n√£o pode ser feito da mesma forma que ler e escrever na mem√≥ria.</p>
</div>
<div class="paragraph">
<p><em>‚Äî  Escrever na mem√≥ria?!?! Eu nunca escrevi na mem√≥ria!!!</em></p>
</div>
<div class="paragraph">
<p>Todo programa, ao ser executado, est√° armazenado na mem√≥ria. Essa √© uma opera√ß√£o t√£o comum que √© transparente para linguagens alto n√≠vel. Se estiv√©ssemos escrevendo em C seria preciso alocar e desalocar mem√≥ria. Mas em Java a aloca√ß√£o √© feita com um <code>new</code> e a mem√≥ria √© desalocada automaticamente. Mas n√£o √© poss√≠vel alocar espa√ßa em disco.</p>
</div>
<div class="paragraph">
<p>Se compararmos a escrita e mem√≥ria com a escrita em disco, ou interface de redes, vemos que a primeira √© t√£o r√°pida que pode ser considerada imediata. J√° os outros tipos de escrita n√£o podem ser consideradas imediatas, por isso surgiram uma s√©rie de interfaces capazes de avisar ao software quando o dado est√° pronto para ser lido. √â nesse ponto que diferenciamos IO de NIO! O pacote <code>java.io</code> s√£o classes usadas para leitura/escrita bloqueante, enquanto o pacote <code>java.nio</code> s√£o classes de leitura/escrita n√£o bloqueante. E como NIO √© mais recente que o IO tradicional, seu pacote foi inserido em uma vers√£o do Java bem mais recente (JDK 1.4).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cap-05-arquivos-sockets-linux">Arquivos, Sockets e Linux üêß</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Uma das grandes vantagens do Sistema Operacional Linux √© que tudo s√£o arquivos. Quase todas as funcionalidades do sistema operacional s√£o expostas atrav√©s de arquivos mapeados no sistema de arquivos. Assim ao inv√©s de fazer uma chamada de sistema complexa para, por exemplo, obter o tempo que a m√°quina est√° em opera√ß√£o, basta ler o arquivo <code>/proc/uptime</code>. Ou ler o arquivo <code>/proc/cpuinfo</code> para obter uma s√©rie de informa√ß√µes sobre a CPU.</p>
</div>
<div class="paragraph">
<p>Essa foi uma escolha arquitetural do sistema que se tornou bastante eficaz porque cria uma interface comum entre diversas opera√ß√µes. Por exemplo, se voc√™ for procurar no Windows a maneira de se ver todos os processo em execu√ß√£o, ver√° que tem uma <a href="https://docs.microsoft.com/pt-br/windows/win32/psapi/enumerating-all-processes">API (<em>lembre-se que API n√£o se refere s√≥ a API REST</em>) complexa</a>, mas em um Linux basta executar <code>ls /proc</code> e todos os diret√≥rios com n√∫meros s√£o processos. Para saber mais informa√ß√µes dos processos, basta acessar alguns arquivos dentro dessas pastas.</p>
</div>
<div class="paragraph">
<p>Essa informa√ß√£o pode parecer perdida, mas ela tem uma rela√ß√£o profunda com o que veremos a seguir. Quando o Linux escolhe mapear tudo como arquivo, a escolha feita √© por se tratar diversas formas de dados por uma mesma interface. Arquivos s√£o f√°ceis de serem lidos, ent√£o ao expor tudo como arquivo √© f√°cil conseguir acessar essas informa√ß√µes. A JVM tamb√©m traz a mesma abordagem! Tudo em serializa√ß√£o vai se resumir a poucas classes. A opera√ß√£o de leitura de um arquivo ou leitura de um socket s√£o t√£o semelhantes que podem ser executadas pelo mesmo c√≥digo.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cap-05-apresentacao-pacote">Apresenta√ß√£o do pacote <code>java.io</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para entendermos o pacote <code>java.io</code> primeiro precisamos entender o que √© um Stream (ou fluxo em tradu√ß√£o livre). N√£o confunda Stream de I/O com Stream de Collections, eles tem um conceito parecido, mas s√£o aplicados em locais diferentes. Stream significa fluxo e quando falamos de Stream estamos falando de uma informa√ß√£o que flui em sentido √∫nico.</p>
</div>
<div class="paragraph">
<p>Para entender melhor √© preciso pensar em como era feito antes&#8230;&#8203; As bibliotecas do C para leitura de arquivo/socket n√£o fazem diferencia√ß√£o entre as interfaces de leitura e escrita, ao se criar um canal de comunica√ß√£o temos um inteiro que identifica o canal e esse inteiro pode ser usado tanto para leitura como para escrita. Observe a documenta√ß√£o das fun√ß√µes <a href="https://man7.org/linux/man-pages/man2/read.2.html"><code>read</code></a> e <a href="https://man7.org/linux/man-pages/man2/write.2.html"><code>write</code></a> e veja que elas recebem os mesmo argumentos.</p>
</div>
<div id="cap-05-c-read" class="imageblock text-center text-center">
<div class="content">
<a class="image" href="https://man7.org/linux/man-pages/man2/read.2.html"><img src="/assets/images/java-101/cap-05/read.PNG" alt="read"></a>
</div>
<div class="title">Figura 1. Documenta√ß√£o da fun√ß√£o read</div>
</div>
<div id="cap-05-c-write" class="imageblock text-center text-center">
<div class="content">
<a class="image" href="https://man7.org/linux/man-pages/man2/write.2.html"><img src="/assets/images/java-101/cap-05/write.PNG" alt="write"></a>
</div>
<div class="title">Figura 2. Documenta√ß√£o da fun√ß√£o write</div>
</div>
<div class="paragraph">
<p>Em Java foi decidido que haveria uma diferencia√ß√£o l√≥gica entre leitura e escrita. Ao se ler um arquivo poder√≠amos ter o fluxo de leitura (InputStream ou Reader) e o fluxo de escrita (<code>OutputStream</code> ou <code>Writer</code>). Cada um desses fluxos teria uma orienta√ß√£o √∫nica, isso significa que um InputStream apenas l√™ e o <code>OutputStream</code> apenas escreve. √â por isso que se usa o nome Stream.</p>
</div>
<div class="paragraph">
<p>Essa √© a primeira informa√ß√£o importante do pacote <code>java.io</code>: <strong>As interfaces de leitura s√£o separadas das interfaces de escrita!</strong> Para apresentar o pacote em um diagrama de classes foi at√© preciso criar essa separa√ß√£o para possibilitar que melhor visualiza√ß√£o.</p>
</div>
<div class="paragraph">
<p>Outro ponto da biblioteca C que explica o funcionamento do pacote <code>java.io</code> s√£o as fun√ß√µes <a href="https://man7.org/linux/man-pages/man2/open.2.html"><code>open</code></a> e <a href="https://man7.org/linux/man-pages/man2/close.2.html"><code>close</code></a>. Em qualquer sistema operacional para se realizar a leitura em arquivo, ou em um socket, s√≥ √© poss√≠vel com a aloca√ß√£o de recurso. Isso √© feito para evitar que processos diferentes criem estados inconsistentes. Quando um processo chama a fun√ß√£o <code>open</code> para um determinado arquivo, ele n√£o poder√° ser aberto por outro processo enquanto n√£o for liberado atrav√©s da fun√ß√£o <code>close</code>. Se a fun√ß√£o <code>close</code> n√£o for chamada, o arquivo s√≥ ser√° liberado quando o processo morrer o que pode tamb√©m gerar um estado inconsistente. Por isso era importante garantir na escrita do c√≥digo que a fun√ß√£o close sempre fosse chamada e que o arquivo sempre estivesse em um estado consistente. Lembre-se que leitura e escrita n√£o s√£o processos imediatos, se o programa finalizar ou o arquivo for fechado antes da escrita terminar, o arquivo fica em um estado inconsistente.</p>
</div>
<div id="cap-05-c-open" class="imageblock text-center text-center">
<div class="content">
<a class="image" href="https://man7.org/linux/man-pages/man2/open.2.html"><img src="/assets/images/java-101/cap-05/open.PNG" alt="open"></a>
</div>
<div class="title">Figura 3. Documenta√ß√£o da fun√ß√£o open</div>
</div>
<div id="cap-05-c-close" class="imageblock text-center text-center">
<div class="content">
<a class="image" href="https://man7.org/linux/man-pages/man2/close.2.html"><img src="/assets/images/java-101/cap-05/close.PNG" alt="close"></a>
</div>
<div class="title">Figura 4. Documenta√ß√£o da fun√ß√£o close</div>
</div>
<div class="paragraph">
<p>Agora volta ao Java&#8230;&#8203; Em C era preciso criar mecanismos de garantir que o arquivo estava fechado antes que o programa finalizasse. Em Java isso foi internalizado na linguagem atrav√©s de alguns mecanismos. Por isso temos as interfaces <code>Closeable</code> e <code>AutoCloseable</code>. Se um objeto precisa liberar recursos depois de usado, ele deve implementar a interface <code>Closeable</code> e o m√©todo <code>close</code> deve ser chamado. At√© a vers√£o 6 do Java era comum ver o <code>close</code> sendo chamado dentro do bloco <code>finally</code> de um <code>try {} catch {} finally {}</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Reader</span> <span class="n">reader</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="c1">// inicia reader</span>
    <span class="c1">// l√™ dados</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// trata exce√ß√£o</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">reader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// trata exce√ß√£o</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como esse c√≥digo tem muito <em>boilerplate</em> (c√≥digo sem significado √∫nico, repetido), o Java 7 trouxe um recurso na sintaxe chamado <em>try-with-resources</em>. Agora todo inicio de um <em>try-catch</em> √© poss√≠vel declarar um ou mais objetos que devem implementar a nova interface chamada <code>AutoCloseable</code>. Como esse √© um recurso da linguagem, a interface <code>AutoCloseable</code> n√£o faz parte do pacote <code>java.io</code>, ao contr√°rio da interface <code>Closeable</code>, mas do package <code>java.lang</code>. Assim o bloco finally poderia ser removido sem preju√≠zo nenhum a l√≥gica do programa.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="k">try</span> <span class="o">(</span><span class="nc">Reader</span> <span class="n">reader</span> <span class="o">=</span> <span class="cm">/* inicia reader */</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// l√™ dados</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// trata exce√ß√£o</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Agora que sabemos que (1) objetos de I/O devem liberar recursos e que as classes de I/O s√£o do tipo <code>Closeable</code>, observe as principais classes do pacote. Vamos explorar um pouco delas.</p>
</div>
<div id="cap-05-io-read" class="imageblock text-center text-center">
<div class="content">
<img src="/assets/images/java-101/cap-05/IO-Read.png" alt="IO Read">
</div>
<div class="title">Figura 5. Java I/O classes de leitura</div>
</div>
<div id="cap-05-io-write" class="imageblock text-center text-center">
<div class="content">
<img src="/assets/images/java-101/cap-05/IO-Write.png" alt="IO Write">
</div>
<div class="title">Figura 6. Java I/O classes de escrita</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_casos-de-uso">Casos de Uso</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para explorar melhor essas classes, vamos dividir o pacote em 5 casos de usos bem comuns para biblioteca I/O.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Como ler um arquivo?</p>
</li>
<li>
<p>Como escrever um arquivo?</p>
</li>
<li>
<p>Como ler dados do console?</p>
</li>
<li>
<p>Como ler/escrever em Socket?</p>
</li>
<li>
<p>Lidando objetos complexos</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_1-como-ler-um-arquivo">1. Como ler um arquivo?</h3>
<div class="paragraph">
<p>Falamos anteriormente que a diferen√ßa entre um InputStream e um Reader √© que o InputStream trabalha com bytes enquanto o Reader com caracteres. Agora vamos mostrar um exemplo pr√°tico? Imagina que voc√™ tem um arquivo texto em formato JSON, como fazer pra o ler? Se pensou em ler usando um Reader&#8230;&#8203; v√° com calma! A primeira coisa a fazer √© decidir qual biblioteca vai ser usada para ler o JSON. A escolha deve come√ßar pelo elemento mais complexo.</p>
</div>
<div class="paragraph">
<p>Para se ler um JSON, temos uma biblioteca praticamente onipresente: <a href="https://github.com/FasterXML/jackson-databind/">Jackson Databind</a>! O cora√ß√£o dessa biblioteca √© a classe <a href="https://fasterxml.github.io/jackson-databind/javadoc/2.13/com/fasterxml/jackson/databind/ObjectMapper.html">ObjectMapper</a> e ela define v√°rias formas de se escrever em arquivo, a forma mais f√°cil nem chega a usar Stream ou Readers. O c√≥digo abaixo foi retirado a pr√≥pria documenta√ß√£o do ObjectMapper, observe que n√£o se usa nem InputStream/OutputStream ou Readers/Writers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">final</span> <span class="nc">ObjectMapper</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">();</span> <span class="c1">// can use static singleton, inject: just make sure to reuse!</span>
<span class="nc">MyValue</span> <span class="n">value</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyValue</span><span class="o">();</span>
<span class="c1">// ... and configure</span>
<span class="nc">File</span> <span class="n">newState</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"my-stuff.json"</span><span class="o">);</span>
<span class="n">mapper</span><span class="o">.</span><span class="na">writeValue</span><span class="o">(</span><span class="n">newState</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span> <span class="c1">// writes JSON serialization of MyValue instance</span>
<span class="c1">// or, read</span>
<span class="nc">MyValue</span> <span class="n">older</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="na">readValue</span><span class="o">(</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"my-older-stuff.json"</span><span class="o">),</span> <span class="nc">MyValue</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// Or if you prefer JSON Tree representation:</span>
<span class="nc">JsonNode</span> <span class="n">root</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="na">readTree</span><span class="o">(</span><span class="n">newState</span><span class="o">);</span>
<span class="c1">// and find values by, for example, using a JsonPointer expression:</span>
<span class="kt">int</span> <span class="n">age</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">at</span><span class="o">(</span><span class="s">"/personal/age"</span><span class="o">).</span><span class="na">getValueAsInt</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Mas isso n√£o impede que se use eles para ler dados de um arquivo. A primeira miss√£o que temos √© mapear o objeto que devemos ler como um POJO. Em um projeto pessoal eu criei uma interface para inspecionar Cluster Kafka, o <a href="https://blog.vepo.dev/projects/kafka-tool">Kafka Tool</a>. Nesse projeto, todas as configura√ß√µes s√£o salvas em arquivos JSON no diret√≥rio <code>~/.kafka-tool</code> (arquivos come√ßados com <code>.</code> s√£o considerados ocultos no Linux), assim para armazenar as informa√ß√µes de Brokers √© preciso primeiro mapear um broker. Depois de mapeador o broker √© preciso carregar a lista de brokers do arquivo, para isso basta usar o c√≥digo abaixo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Path</span> <span class="n">kafkaToolConfigPath</span> <span class="o">=</span> <span class="nc">PAths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"user.home"</span><span class="o">),</span> <span class="s">".kafka-tool"</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">kafkaToolConfigPath</span><span class="o">.</span><span class="na">toFile</span><span class="o">().</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>

    <span class="nc">Path</span> <span class="n">propertiesPath</span> <span class="o">=</span> <span class="n">kafkaToolConfigPath</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="s">"kafka-properties.json"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">propertiesPath</span><span class="o">.</span><span class="na">toFile</span><span class="o">().</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">newBufferedReader</span><span class="o">(</span><span class="n">propertiesPath</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">lines</span><span class="o">()</span>
                                     <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">()))</span>
                           <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="nc">Predicate</span><span class="o">.</span><span class="na">not</span><span class="o">(</span><span class="nl">String:</span><span class="o">:</span><span class="n">isBlank</span><span class="o">))</span>
                           <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">value</span> <span class="o">-&gt;</span> <span class="n">handleIoException</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">mapper</span><span class="o">.</span><span class="na">readValue</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="nc">KafkaBroker</span><span class="o">[].</span><span class="na">class</span><span class="o">)));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error reading file!"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para ler usamos um <a href="https://docs.oracle.com/javase/8/docs/api/java/io/BufferedReader.html"><code>BufferedReader</code></a> porque ele permite ler todo o arquivo em texto facilmente, para isso usamos a o m√©todo <a href="https://docs.oracle.com/javase/8/docs/api/java/nio/file/Files.html#newBufferedReader-java.nio.file.Path-"><code>Files.newBufferedReader</code></a>, que pode ser lido atrav√©s do m√©todo <a href="https://fasterxml.github.io/jackson-databind/javadoc/2.13/com/fasterxml/jackson/databind/ObjectMapper.html#readValue-java.lang.String-java.lang.Class-"><code>ObjectMapper.readValue</code></a> que aceita <code>String</code>. Mas tamb√©m pod√≠amos abrir um <code>InputStream</code> usando <a href="https://docs.oracle.com/javase/8/docs/api/java/nio/file/Files.html#newInputStream-java.nio.file.Path-java.nio.file.OpenOption&#8230;&#8203;-"><code>Files.newInputStream</code></a> e usar ele diretamente como par√¢metro <a href="https://fasterxml.github.io/jackson-databind/javadoc/2.13/com/fasterxml/jackson/databind/ObjectMapper.html#readValue-java.io.InputStream-java.lang.Class-"><code>ObjectMapper.readValue</code></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_2-como-escrever-um-arquivo">2. Como escrever um arquivo?</h3>
<div class="paragraph">
<p>De forma bem similar podemos escreve em arquivos usando as mesmas APIs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Path</span> <span class="n">kafkaToolConfigPath</span> <span class="o">=</span> <span class="nc">PAths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"user.home"</span><span class="o">),</span> <span class="s">".kafka-tool"</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">kafkaToolConfigPath</span><span class="o">.</span><span class="na">toFile</span><span class="o">().</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">kafkaToolConfigPath</span><span class="o">.</span><span class="na">toFile</span><span class="o">().</span><span class="na">mkdir</span><span class="o">();</span>
<span class="o">}</span>

<span class="nc">Path</span> <span class="n">propertiesPath</span> <span class="o">=</span> <span class="n">kafkaToolConfigPath</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="s">"kafka-properties.json"</span><span class="o">);</span>
<span class="nc">ObjectMapper</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">().</span><span class="na">enable</span><span class="o">(</span><span class="nc">SerializationFeature</span><span class="o">.</span><span class="na">INDENT_OUTPUT</span><span class="o">)</span>
<span class="k">try</span> <span class="o">(</span><span class="nc">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">newBufferedWriter</span><span class="o">(</span><span class="n">propertiesPath</span><span class="o">,</span> <span class="nc">StandardOpenOption</span><span class="o">.</span><span class="na">CREATE</span><span class="o">,</span> <span class="nc">StandardOpenOption</span><span class="o">.</span><span class="na">TRUNCATE_EXISTING</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">mapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">brokers</span><span class="o">));</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error saving file!"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para escrever usamos um <a href="https://docs.oracle.com/javase/8/docs/api/java/io/BufferedWriter.html"><code>BufferedWriter</code></a>, atrav√©s do <a href="https://docs.oracle.com/javase/8/docs/api/java/nio/file/Files.html#newBufferedWriter-java.nio.file.Path-java.nio.file.OpenOption&#8230;&#8203;-"><code>Files.newBufferedWriter</code></a>, porque √© uma op√ß√£o vi√°vel para se usar com <a href="https://fasterxml.github.io/jackson-databind/javadoc/2.13/com/fasterxml/jackson/databind/ObjectMapper.html#writeValueAsString-java.lang.Object-"><code>ObjectMapper.writeValueAsString</code></a>. Mas da mesma forma pod√≠amos usar <a href="https://docs.oracle.com/javase/8/docs/api/java/io/OutputStream.html"><code>OutputStream</code></a>, atrav√©s do <a href="https://docs.oracle.com/javase/8/docs/api/java/nio/file/Files.html#newOutputStream-java.nio.file.Path-java.nio.file.OpenOption&#8230;&#8203;-"><code>Files.newOutputStream</code></a>, porque tamb√©m √© uma op√ß√£o vi√°vel para se usar com <a href="https://fasterxml.github.io/jackson-databind/javadoc/2.13/com/fasterxml/jackson/databind/ObjectMapper.html#writeValueAsBytes-java.lang.Object-"><code>ObjectMapper.writeValueAsBytes</code></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_3-como-ler-dados-do-console">3. Como ler dados do console?</h3>
<div class="paragraph">
<p>Toda aplica√ß√£o pode rodar em modo de linha de comando. Linha de comando √© bastante √∫til porque possibilita que as aplica√ß√µes sejam integradas a scripts de execu√ß√£o seguindo a Filosofia Unix: <strong><em>Escreva programas para lidar com fluxos de texto, porque essa √© uma interface universal</em></strong>.</p>
</div>
<div class="paragraph">
<p>A primeira informa√ß√£o importante √© saber que os streams de entrada, sa√≠da e erro est√£o expostos como vari√°veis globais na classe <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/System.html"><code>System</code></a>. Assim podemos facilmente escrever um programa que l√™ da linha de comando com algumas linhas.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="k">try</span><span class="o">(</span><span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">)))</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esse c√≥digo √© certo e funciona, mas existe uma outra classe que facilita em muito o tratamento de dados que vem do console, √© a classe <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Scanner.html"><code>Scanner</code></a>. Com ela √© poss√≠vel tratar os dados de entrada de forma mais f√°cil. Por exemplo se eu quiser fazer um programa para l√™ n√∫meros do console, √© poss√≠vel fazer com poucas linhas.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="k">try</span><span class="o">(</span><span class="nc">Scanner</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">))</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Qual o seu nome? "</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">nome</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Quantos anos voc√™ tem? "</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">idade</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Oi "</span> <span class="o">+</span> <span class="n">nome</span> <span class="o">+</span> <span class="s">"! Voc√™ tem "</span> <span class="o">+</span> <span class="n">idade</span> <span class="o">+</span> <span class="s">" anos!"</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4-como-lerescrever-em-socket">4. Como ler/escrever em Socket?</h3>
<div class="paragraph">
<p>Sockets devem ser usados com parcim√¥nia! Sockets permitem que dois processos se comuniquem entre si atrav√©s de uma conex√£o TCP direta. O problema em usar Sockets √© que em muitos casos voc√™ pode estar reimplementando um protocolo j√° conhecido. Mas as vantagens de se usar socket √© que seu programa vai ter liberdade de se comunicar. Quando temos dois programas se comunicando por socket um deles ser√° o cliente e o outro ser√° o servidor, √© o que chamamos de Socket Server.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Caso de Uso</div>
Eu j√° implementei um caso de uso bastante complexo usando Socket, mas era porque t√≠nhamos um servidor de gera√ß√£o de voz. Os clientes enviavam texto e outros par√¢metros e recebiam de volta Stream de dados de acordo com o formato requerido (MP3, WAV, etc&#8230;&#8203;).
</div>
</div>
<div class="paragraph">
<p>N√£o vamos entrar aqui em detalhes sobre como a classe Socket funciona, mas ao abrir um socket, ela vai dispor de dois Stream para leitura e escrita de dados. Assim podemos ter o servidor abaixo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">AtomicBoolean</span> <span class="n">running</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicBoolean</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="nc">ExecutorService</span> <span class="n">threadPool</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span> <span class="c1">// thread para processar socket</span>
<span class="k">try</span><span class="o">(</span><span class="nc">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="mi">5555</span><span class="o">))</span> <span class="o">{</span>            <span class="c1">// abre socket na porta 5555</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">running</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>                       <span class="c1">// conex√£o aberta com cliente</span>
        <span class="n">threadPool</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>                              <span class="c1">// Se n√£o tratar dentro de uma thread n√£o √© poss√≠vel abrir outras conex√µes</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">process</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span>               <span class="c1">// encapsula toda comunica√ß√£o</span>
                        <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>                               <span class="c1">// S√≥ fecha o socket depois de finalizada a comunica√ß√£o</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>J√° o cliente √© um pouco mais simples porque n√£o se espera que ele se conecte com mais de um servidor.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="k">try</span> <span class="o">(</span><span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">5555</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">process</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span> <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Eu n√£o recomendo a voc√™ escrever um servidor socket em nenhuma hip√≥tese. Caso voc√™ tenha um protocolo complexo que deve ser feito atrav√©s de um servidor socket, eu recomendo usar o projeto <a href="https://netty.io/">Netty</a> para que voc√™ consiga focar nas regras de neg√≥cios deixando funcionalidades como serializa√ß√£o, controle de threads e seguran√ßa como responsabilidade da biblioteca.</p>
</div>
</div>
<div class="sect2">
<h3 id="_5-lidando-objetos-complexos">5. Lidando objetos complexos</h3>
<div class="paragraph">
<p>Se voc√™ foi atento deve ter reparado que no diagrama de classe tem duas classes que parecem bastante √∫teis: <a href="https://docs.oracle.com/javase/8/docs/api/java/io/ObjectInputStream.html"><code>ObjectInputStream</code></a> e <a href="https://docs.oracle.com/javase/8/docs/api/java/io/ObjectOutputStream.html"><code>ObjectOutputStream</code></a>. Essas duas classes permitem serializar qualquer objeto da JVM e enviar para outra JVM, √© por causa dessas classes que existe a interface <a href="https://docs.oracle.com/javase/8/docs/api/java/io/Serializable.html"><code>Serializable</code></a> a qual eu citei na minha primeira pergunta e at√© agora n√£o respondi. Pois vamos entender o motivo de deixar essa resposta por √∫ltimo?</p>
</div>
<div class="paragraph">
<p>Para serializar um objeto eu devo usar a interface <a href="https://docs.oracle.com/javase/8/docs/api/java/io/Serializable.html"><code>Serializable</code></a>? N√£o! Voc√™ pode usar qualquer biblioteca com formatos de serializa√ß√£o que s√£o compreendidos por v√°rias linguagens. A interface <code>Serializable</code> √© usada para serializar objetos que s√≥ podem ser carregados na JVM atrav√©s das classes <code>ObjectInputStream</code> e <code>ObjectOutputStream</code>. MAS essas classes n√£o deve ser usadas porque elas tem v√°rias falhas de seguran√ßa que podem ser exploradas. Ent√£o resposta curta: <strong>N√£o use essas classes!</strong></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cap-05-proximos-passos">Pr√≥ximos passos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Eu espero que voc√™ tenha compreendido que como ler dados de v√°rias fontes como arquivos ou sockets. Agora √© hora de voc√™ aprender a usar bibliotecas de leituras de arquivos. Recomendo que voc√™ explore a biblioteca Jackson, assim como outras bibliotecas para se escrever JSON. Um bom exerc√≠cio √© comparar a performance de escrita entre v√°rias bibliotecas e escolher a que voc√™ vai usar sempre.</p>
</div>
<div class="paragraph">
<p>Outros exerc√≠cios s√£o tentar conhecer a biblioteca de leitura e XML, <a href="https://yaml.org/">YAML</a>, <a href="https://toml.io/en/">TOML</a> ou qualquer outro formato que lhe interessar.</p>
</div>
</div>
</div>]]></content><author><name>{&quot;twitter&quot;=&gt;&quot;vepo&quot;, &quot;linkedin&quot;=&gt;&quot;https://www.linkedin.com/in/victorosorio/&quot;, &quot;picture&quot;=&gt;&quot;/assets/images/me.avif&quot;}</name></author><category term="Java" /><category term="Tutorial" /><category term="I/O" /><summary type="html"><![CDATA[Quais s√£o as bibliotecas para leitura de arquivos em Java? O que significa ler e escrever em um programa? A ideia desta s√©rie √© criar um tutorial Java onde mostrarei todos os segredos da linguagem e do ecossistema.]]></summary></entry><entry><title type="html">OO: Eu vejo objetos por todos os cantos!</title><link href="https://blog.vepo.dev/posts/java-101-objetos" rel="alternate" type="text/html" title="OO: Eu vejo objetos por todos os cantos!" /><published>2022-05-30T00:00:00+00:00</published><updated>2022-05-30T00:00:00+00:00</updated><id>https://blog.vepo.dev/posts/11-15-00-java101-objetos</id><content type="html" xml:base="https://blog.vepo.dev/posts/java-101-objetos"><![CDATA[<div class="paragraph">
<p>Java tem um f√£ clube enorme! S√£o pessoas que usam a linguagem no dia a dia e resolvem problemas importantes para a nossa sociedade. Quando Java completou 25 anos houve at√© a hashtag <a href="https://twitter.com/search?q=lang%3Apt%20%23MovedByJava&amp;src=typed_query&amp;f=top">#MovedByJava</a> para mostrar que o mundo √© movido por software desenvolvido em Java, s√£o bilh√µes de transa√ß√µes em Java em servi√ßos altamente escal√°veis.</p>
</div>
<div class="paragraph">
<p>MAS&#8230;&#8203; existe um pequeno grupo raivoso e ruidoso que <a href="https://twitter.com/search?q=java%20lento&amp;src=typed_query&amp;f=live">odeia Java</a>. Eu n√£o desejaria nem citar esse grupo, mas creio que isso tem que estar em qualquer tutorial de Java, n√£o para dar voz a esse povo, mas para desmentir. Java n√£o √© lento, talvez voc√™ que n√£o est√° sabendo usar e vamos mais a frente falar sobre <em>tuning</em>. Essas pessoas usam argumentos bem simples como "tudo tem que estar em objetos", "eu tenho que escrever um main dentro de um objeto", "nada disso faz sentido"&#8230;&#8203; Resolvi citar eles aqui, porque eles n√£o odeiam Java, eles odeiam Orienta√ß√£o a Objetos e com esse post eu vou te convencer que al√©m de ser uma √≥tima forma de pensar, Orienta√ß√£o a Objetos ajudou a pavimentar os outros paradigmas que est√£o por aqui no ano de 2022.</p>
</div>
<div class="sect1">
<h2 id="cap-04-um-pouco-de-historia">Um pouco de hist√≥ria</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Orienta√ß√£o a Objetos surgiu nos anos 60 e era usado para fazer simula√ß√µes no Simula 67. Esta linguagem, por sua vez, acabou por influenciar o C (1979), que na verdade √© uma tentativa de adicionar objetos a linguagem C. Por muitos anos o C foi uma das linguagens mais influentes do mercado, ela n√£o era, puramente, uma linguagem orientada a objetos, era at√© poss√≠vel intercalar c√≥digo C com c√≥digo C++. A primeira linguagem que surge como puramente orientada a objetos e ainda por cima compilada em <em>bytecode</em> para ser executado em uma M√°quina Virtual foi&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>PAUSA DRAM√ÅTICA&#8230;&#8203; ü•∂</p>
</div>
<div class="paragraph">
<p>O Smalltalk! O que foi? üßê Achou que era o Java? O Java s√≥ surge em 1991, e em seu lan√ßamento em 1995, e acaba herdando muitas caracter√≠sticas do Smalltalk, tanto que muitas pessoas da comunidade Java vieram do mundo Smalltalk. E uma das coisas que Java herda √© ser primariamente orientada a objetos.</p>
</div>
<div class="paragraph">
<p><em>‚Äî Mas porque essa preocupa√ß√£o em ser Orientada a Objetos?!</em></p>
</div>
<div class="paragraph">
<p>Porque na verdade a computa√ß√£o n√£o come√ßou com essas linguagens e nem com esses paradigmas, mas como Programa√ß√£o Funcional (ver <em><a href="https://dl.acm.org/doi/abs/10.1145/72551.72554">Conception, evolution, and application of functional programming languages</a></em>). Linguagens funcionais s√£o excelentes para modelarem problemas matem√°ticos e alguns problemas computacionais, pois elas s√£o declarativas. Podemos transpor a defini√ß√£o de um problema para a linguagem de programa√ß√£o facilmente, podendo at√© mesmo aplicar uma l√≥gica equacional, pois, se as fun√ß√µes s√£o puras, o valor de <code>f(x)</code> s√≥ precisa ser calculado uma vez. Logica equacional √© o mesmo que tratar uma fun√ß√£o como uma equa√ß√£o matem√°tica, isso implica que s√≠mbolos iguais ter√£o valores iguais.</p>
</div>
<div class="paragraph">
<p>MAS linguagens funcionais apresentam uma certa dificuldade de modelar alguns tipos de sistemas e, com a populariza√ß√£o da computa√ß√£o, foi necess√°rio outros paradigmas para os novos sistemas que foram sendo desenvolvidos. O primeiro desses paradigmas foi a Programa√ß√£o Procedural, popularizado pela linguagens como C. Nesse tipo de linguagem a l√≥gica de programa√ß√£o pode ser estruturada dentro de procedimentos que podem ser tanto fun√ß√µes quanto procedimentos, a diferen√ßa entre os dois √© que uma fun√ß√£o n√£o altera o valor dos par√¢metros e sempre retorna um valor, j√° os procedimentos alteram o valor dos par√¢metros e n√£o retornam nenhum valor. Em C, podemos escrever tanto fun√ß√µes quanto procedimentos.</p>
</div>
<div class="paragraph">
<p>Linguagens procedurais apresentam bastante dificuldade para encapsular complexidade porque √© dif√≠cil criar abstra√ß√µes com ela. Em C, os dados s√£o sempre modelados usando tipos primitivos ou estruturas, que nada mais s√£o que agrupamentos de tipos primitivos. Mesmo quem desenvolve C hoje em dia, n√£o consegue compreender o que era desenvolver nos anos 70, pois a linguagem continuou avan√ßando. Eu tenho uma leve ideia porque, na universidade, desenvolvi programas para um microcontrolador com o compilador bem limitado. O exemplo abaixo eu retirei de um <a href="https://github.com/vepo/csvi">visualizador de CSV</a> que eu desenvolvi por necessidade.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">matrix_config_t</span> <span class="o">*</span><span class="nf">matrix_config_initialize</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">width</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">matrix_config_t</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="p">(</span><span class="n">matrix_config_t</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">matrix_config_t</span><span class="p">));</span>
    <span class="n">config</span><span class="o">-&gt;</span><span class="n">columns</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
    <span class="n">config</span><span class="o">-&gt;</span><span class="n">heights</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
    <span class="n">config</span><span class="o">-&gt;</span><span class="n">column_width</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span> <span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">));</span>
    <span class="n">config</span><span class="o">-&gt;</span><span class="n">line_height</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span> <span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">config</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Observe que no c√≥digo h√° a preocupa√ß√£o de se alocar a posi√ß√£o de mem√≥ria necess√°ria para uma determinada estrutura chamada <code>matriz_config_t</code> e que essa aloca√ß√£o √© feita atrav√©s de duas fun√ß√µes diferentes <code>calloc</code> e <code>malloc</code>. Esse c√≥digo pode parecer simples, mas tem diversidades camadas de complexidades, como simplesmente diferenciar essas duas fun√ß√µes.</p>
</div>
<div class="paragraph">
<p><em>‚Äî Aonde voc√™ quer chegar?!?!</em></p>
</div>
<div class="paragraph">
<p>Ora! Qual √© o objetivo de um desenvolvedor?</p>
</div>
<div class="paragraph">
<p><em>‚Äî Escrever c√≥digo!</em></p>
</div>
<div class="paragraph">
<p>Errado! O objetivo de um desenvolvedor √© resolver problemas atrav√©s da escrita de c√≥digo. Por isso, desenvolvedores n√£o podem e n√£o devem ficar preocupado com complexidades desnecess√°ria. √â para remover essa complexidade que surgem linguagens Orientadas a Objetos. As linguagens procedurais s√£o simples e com poucas funcionalidades, por isso toda a informa√ß√£o √© armazenada de forma simpl√≥ria em estruturas. Isso gera complexidade e o objetivo principal de uma linguagem de programa√ß√£o √© encapsular complexidade.</p>
</div>
<div class="paragraph">
<p>Vamos tentar explicar de outra forma&#8230;&#8203;</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cap-04-o-que-e-poo">O que √© Programa√ß√£o Orientada a Objetos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vamos estabelecer algumas hip√≥teses&#8230;&#8203;.</p>
</div>
<div class="sect2">
<h3 id="_e-se-eu-puder-lidar-com-tipos-complexos">E se eu puder lidar com tipos complexos</h3>
<div class="paragraph">
<p>Uma linguagem OO ir√° sempre lidar com tipos de dados cada vez mais complexos pois n√£o estamos apenas falando de programa√ß√£o, mas de encapsulamento de complexidades.</p>
</div>
<div class="paragraph">
<p>Vamos supor que eu desejo desenvolver uma API para navega√ß√£o rob√≥tica e eu sei que meu rob√¥ tem 4 rodas e que posso definir a velocidade de cada roda. Ser√° que eu preciso saber qual √© a velocidade de cada roda? Ou eu posso apenas mandar comandos para o meu rob√¥? Um exemplo de comandos s√£o: "V√° para frente", "Fa√ßa uma curva de 30¬∫", "Pare".</p>
</div>
<div class="paragraph">
<p>Quando falamos de Orienta√ß√£o a Objetos, devemos pensar em design de c√≥digo. N√£o estamos falando de programa√ß√£o pura, mas de uma modelagem de dados e conceitos. Os detalhes internos devem ser escondidos para quem s√≥ sejam vis√≠veis para os pr√≥prios times de manuten√ß√£o.</p>
</div>
</div>
<div class="sect2">
<h3 id="_e-se-eu-puder-associar-comportamento-aos-meus-tipos-complexos">E se eu puder associar comportamento aos meus tipos complexos</h3>
<div class="paragraph">
<p>Todo c√≥digo tem um contexto para ser executado. Quando eu tenho um rob√¥ e eu desejo que ele v√° para uma posi√ß√£o, se essa ordem √© diferente para cada rob√¥ e produz diferentes resultados, mas ela sempre est√° associada a um rob√¥, ou seja, n√£o faz sentido um outro objeto que n√£o seja um rob√¥ se mover (<em>ainda falarei de heran√ßa</em>).</p>
</div>
<div class="paragraph">
<p>Mas podem existir outros objetos que se movem, certo? E como fica se a fun√ß√£o mover √© somente associada a rob√¥s?</p>
</div>
<div class="paragraph">
<p>Em uma linguagem orientada a objetos, n√£o temos fun√ß√µes e nem procedimentos, mas m√©todos. A diferen√ßa √© que uma fun√ß√£o transforma dados, procedimentos executa uma s√©rie de altera√ß√µes nos par√¢metros, mas um m√©todo envia uma mensagem (<em>essas defini√ß√µes n√£o tem car√°ter acad√™mico, se algu√©m tiver alguma refer√™ncia me manda no Twitter</em>). Logo um m√©todo vai pertencer a um objeto, assim se formos modelar um Avi√£o, podemos criar um outro m√©todo mover que existir√° somente para um Avi√£o e que ser√° diferente do m√©todo mover de um rob√¥.</p>
</div>
</div>
<div class="sect2">
<h3 id="_e-se-puder-compartilhar-o-comportamento-entre-tipos-diferentes">E se puder compartilhar o comportamento entre tipos diferentes</h3>
<div class="paragraph">
<p>Objetos tem um tipo especifico, por exemplo n√≥s estamos falando de um rob√¥. Mas eu posso assumir que um rob√¥ √© um tipo de objeto m√≥vel? Posso eu criar m√©todos nesse objeto m√≥vel? O que essa implementa√ß√£o desse m√©todo faz para um rob√¥ √© a mesma coisa que se faz para um avi√£o?</p>
</div>
<div class="paragraph">
<p>Para cada pergunta acima, existe uma resposta no mundo da Programa√ß√£o Orientada a Objetos e √© o que vamos ver na pr√≥xima sess√£o.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cap-04-orientacao-a-objetos">Orienta√ß√£o a Objetos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>N√≥s falamos um pouco sobre Programa√ß√£o Funcional e Programa√ß√£o Procedural, ent√£o vamos definir o que √© Programa√ß√£o Orientada a Objetos (POO) antes de ver como Java faz POO.</p>
</div>
<div class="paragraph">
<p>Programa√ß√£o Orientada a Objetos √© um modelo de design, analise e desenvolvimento de software que organiza todo o software ao redor dos dados e suas abstra√ß√µes. Para que isso seja poss√≠vel, √© criado o conceito de Objeto. Um objeto √© um componente de software composto de atributos e comportamento.</p>
</div>
<div class="paragraph">
<p>Quando falamos de orienta√ß√£o a objeto, focamos na defini√ß√£o do que √© um objeto e das opera√ß√µes que esse objeto pode realizar, ao contr√°rio da l√≥gica necess√°ria para realizar a opera√ß√£o. Os principais benef√≠cios da POO √© a reutiliza√ß√£o de c√≥digo, escalabilidade e efici√™ncia no desenvolvimento. Ent√£o podemos definir que POO vai ter alguns elementos.</p>
</div>
<div class="sect2">
<h3 id="_elementos">Elementos</h3>
<div class="paragraph">
<p>Abaixo vemos as descri√ß√µes de cada elemento da POO, elas n√£o se referem a linguagem Java, mas ao paradigma em si.</p>
</div>
<div class="sect3">
<h4 id="_classes">Classes</h4>
<div class="paragraph">
<p><strong>Classes</strong> s√£o tipos de dados definidos pelo usu√°rio que atuam como modelo para objetos, atributos e m√©todos.</p>
</div>
</div>
<div class="sect3">
<h4 id="_objetos">Objetos</h4>
<div class="paragraph">
<p><strong>Objetos</strong> s√£o inst√¢ncias de uma classe criada com dados espec√≠ficos.</p>
</div>
</div>
<div class="sect3">
<h4 id="cap-04-elementos-metodos">M√©todos</h4>
<div class="paragraph">
<p><strong>M√©todos</strong> s√£o fun√ß√µes definidas dentro de uma classe que descrevem o comportamento de um objeto. Cada m√©todo contido nas defini√ß√µes de classe come√ßa com uma refer√™ncia a um objeto de inst√¢ncia. Al√©m disso, as sub-rotinas contidas em um objeto s√£o chamadas de m√©todos de inst√¢ncia. Os programadores usam m√©todos para reutiliza√ß√£o ou para manter a funcionalidade encapsulada dentro de um objeto por vez.</p>
</div>
</div>
<div class="sect3">
<h4 id="_atributos">Atributos</h4>
<div class="paragraph">
<p><strong>Atributos</strong> s√£o definidos no modelo de classe e representam o estado de um objeto. Os objetos ter√£o dados armazenados no campo de atributos. Os atributos de classe pertencem √† pr√≥pria classe.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cap-04-principios">Princ√≠pios</h3>
<div class="paragraph">
<p>Quando falamos em Orienta√ß√£o a Objetos, temos em mente alguns princ√≠pios.</p>
</div>
<div class="sect3">
<h4 id="_encapsulamento">Encapsulamento</h4>
<div class="paragraph">
<p>Encapsulamento significa que um objeto n√£o √© obrigado a expor a sua implementa√ß√£o e nem os seus atributos. Cabe ao design do objeto escolher como ser√° feita essa exposi√ß√£o. Essa caracter√≠stica de oculta√ß√£o de dados fornece maior seguran√ßa ao programa e evita corrup√ß√£o de dados n√£o intencional.</p>
</div>
</div>
<div class="sect3">
<h4 id="_abstra√ß√£o">Abstra√ß√£o</h4>
<div class="paragraph">
<p>Objetos criam abstra√ß√µes que tornam poss√≠vel controlar a complexidade. Ao se criar uma classe, o restante do sistema dever√° interagir atrav√©s da interface que ela prop√µe n√£o tendo acesso a sua l√≥gica interna.</p>
</div>
</div>
<div class="sect3">
<h4 id="cap-04-principios-heranca">Heran√ßa</h4>
<div class="paragraph">
<p>As classes podem reutilizar o c√≥digo de outras classes. Relacionamentos e subclasses entre objetos podem ser atribu√≠dos, permitindo que os desenvolvedores reutilizem a l√≥gica comum enquanto ainda mant√™m uma hierarquia √∫nica. Essa propriedade da OOP for√ßa uma an√°lise de dados mais completa, reduz o tempo de desenvolvimento e garante um maior n√≠vel de precis√£o.</p>
</div>
</div>
<div class="sect3">
<h4 id="_polimorfismo">Polimorfismo</h4>
<div class="paragraph">
<p>Os objetos s√£o projetados para compartilhar comportamentos e podem assumir mais de uma forma. O sistema poder√° definir como v√™ um objeto e como interage por ele baseado na sua pr√≥pria classe ou em alguma classe pai, reduzindo a complexidade ou a necessidade de duplicar c√≥digo. Quando uma classe filha √© criada, que estende a funcionalidade da classe pai, ambas podem ser tratada pelo mesmo c√≥digo usando a classe pai como interface. O polimorfismo permite que diferentes tipos de objetos usem a mesma interface.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_como-java-faz-programa√ß√£o-orientada-a-objetos">Como Java faz Programa√ß√£o Orientada a Objetos</h3>
<div class="paragraph">
<p>Java √© uma linguagem primariamente orientada a objetos, logo voc√™ deve primeiro entender o que √© uma classe. Classe √© o arqu√©tipo de um objeto. Arqu√©tipo, resumidamente, √© o tipo comum de algo. Por exemplo, se eu falar que existe o tipo Gato, voc√™ vai imaginar o formato desse animal e algumas outras caracter√≠sticas, mas se eu falar que existe o Garfield voc√™ vai imaginar que ele √© um Gato laranja, gordo e pregui√ßoso. O Garfield √© um indiv√≠duo do arqu√©tipo Gato.</p>
</div>
<div id="significado-arquetipo" class="imageblock text-center text-center">
<div class="content">
<img src="/assets/images/java-101/cap-04/arquetipo.png" alt="arquetipo">
</div>
<div class="title">Figura 1. Significado de Arqu√©tipo da Wikipedia</div>
</div>
<div class="paragraph">
<p>Vamos transpor isso pra Java? Podemos ter uma classe Gato, mas o objeto ser√° um Garfield. Assim, podemos ter&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">org.animais.mamiferos</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.fisica.luz.Cor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.animais.psique.Temperamento</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Gato</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">float</span> <span class="n">pesoEmKg</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Cor</span> <span class="n">cor</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Temperamento</span> <span class="n">temperamento</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">Gato</span><span class="o">(</span><span class="kt">float</span> <span class="n">pesoEmKg</span><span class="o">,</span> <span class="nc">Cor</span> <span class="n">cor</span><span class="o">,</span> <span class="nc">Temperamento</span> <span class="n">temperamento</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pesoEmKg</span> <span class="o">=</span> <span class="n">pesoEmKg</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">cor</span> <span class="o">=</span> <span class="n">cor</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">temperamento</span> <span class="o">=</span> <span class="n">temperamento</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// M√âTODOS</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Isso significa que podemos modelar qualquer Gato por esse modelo, assim se quisermos ter um Garfield&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Gato</span> <span class="n">garfield</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Gato</span><span class="o">(</span><span class="mf">15.0</span><span class="o">,</span> <span class="nc">Cor</span><span class="o">.</span><span class="na">LARANJA</span><span class="o">,</span> <span class="nc">Temperamento</span><span class="o">.</span><span class="na">PREGUICOSO</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>No primeiro trecho de c√≥digo tempo a declara√ß√£o da classe <code>Gato</code> no pacote <code>org.animais.mamiferos</code>. Isso significa que s√≥ pode existir um tipo de <code>Gato</code> nesse pacote, mas isso n√£o implica que eu possa criar o tipo <code>Gato</code> para descrever, por exemplo, <em>instala√ß√µes el√©tricas n√£o-oficiais</em>, que obviamente n√£o fazem parte do pacote <code>org.animais.mamiferos</code>, mas <code>org.humanos.civilizacoes.brasil.infraestrutura</code>. Classe √© usada para definir o tipo do objeto, mas o pacote √© o contexto na qual ele existe. Classe e Pacote tem uma rela√ß√£o umbilical, uma Classe sempre deve estar ligada a um Pacote.</p>
</div>
<div class="paragraph">
<p>A segunda coisa que vamos detalhar nesse trecho de c√≥digo s√£o os modificadores de acesso. Como disse uma linguagem orientada a objetos √© usada para se encapsular detalhes, logo os modificadores de acesso servem para definir quem pode acessar o qu√™. Eles podem ser aplicados para Classes, M√©todos e Campos e existem os seguintes modificadores de acesso.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Tipo</th>
<th class="tableblock halign-center valign-top">Token</th>
<th class="tableblock halign-left valign-top">Descri√ß√£o</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Package Private</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define que o elemento ser√° acess√≠vel dentro do pacote. Esse √© o modificador padr√£o, isso significa que nesse caso pode ser omitido.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Privado</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>private</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define que o elemento s√≥ pode ser acessado dentro da pr√≥pria classe.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Protegido</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>protected</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define que o elemento √© acess√≠vel dentro do mesmo pacote ou atrav√©s de heran√ßa.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">P√∫blico</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>public</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define que o elemento √© acess√≠vel em qualquer contexto.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>final</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Se aplicada a classe, ela n√£o poder√° ser estendida. Se aplicada a um campo ele n√£o poder√° ter seu valor alterado. Se aplicado a um m√©todo, ele n√£o poder√° ser reimplementado em uma classe que herda ele.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Est√°tico</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>static</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pode ser usado tanto em campos como em classes internas. Se usado no campo, ele vai ter apenas um valor e est√° associado a classe. Campos n√£o est√°ticos s√£o associados a objetos. Se aplicado a classes internas, ela n√£o depender√° de um objeto.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Ainda existem dois mais dois modificadores (<code>volatile</code> e <code>transiente</code>), mas eles n√£o s√£o importantes quando falamos de OO. <code>transiente</code> ser√° importante quando falarmos de serializa√ß√£o e <code>volatile</code> quando falarmos de threads. Dos outros, podemos agrupar o <code>private</code>, <code>protected</code>, <code>public</code> e a aus√™ncia de um desses, pois eles s√£o mutualmente excludentes.</p>
</div>
<div class="paragraph">
<p>O pr√≥ximo ponto que podemos falar √© sobre m√©todos. Em Java n√£o √© comum termos fun√ß√µes puras, nem linguagem est√° preparada para isso. Temos basicamente dois tipos de m√©todos. Os m√©todos de inst√¢ncia s√£o aqueles que s√£o associados a um objeto. E os m√©todos est√°ticos s√£o aqueles associados a uma classe, sem depender de uma inst√¢ncia. Conseguimos criar m√©todos est√°ticos usando o modificador de acesso <code>static</code>. Quando um m√©todo n√£o √© est√°tico, podemos usar <code>this</code> para se referir a inst√¢ncia com a qual o m√©todo √© associado.</p>
</div>
<div class="paragraph">
<p>M√©todos sempre tem par√¢metros e valor de retorno (pode ser <code>void</code> que significa um vazio existencial, diferente do vazio de posi√ß√£o que √© a palavra <em>empty</em>). M√©todos de inst√¢ncia sempre v√£o te acesso a um objeto espec√≠fico (usando o <code>this</code>), enquanto m√©todos est√°ticos n√£o o s√£o.</p>
</div>
<div class="paragraph">
<p>Vamos ver melhor como os m√©todos funcionam? E se n√≥s cri√°ssemos 3 m√©todos na nossa classe gato. O primeiro seria um m√©todo para mesclar caracter√≠sticas de 2 gatos, o segundo seria o m√©todo <code>meow</code> e o terceiro o m√©todo de reprodu√ß√£o (<code>cruza</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Gato</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Gato</span> <span class="nf">mistura</span><span class="o">(</span><span class="nc">Gato</span> <span class="n">gatoA</span><span class="o">,</span> <span class="nc">Gato</span> <span class="n">gatoB</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// M√°gica acontece</span>
        <span class="k">return</span> <span class="n">gatoC</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Campos, construtores, getters e setters</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">meow</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Miau!"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Gato</span> <span class="nf">cruza</span><span class="o">(</span><span class="nc">Felino</span> <span class="n">outro</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">((!(</span><span class="n">outro</span> <span class="k">instanceof</span> <span class="nc">Gato</span><span class="o">))</span> <span class="o">||</span> <span class="n">sexo</span> <span class="o">==</span> <span class="n">outro</span><span class="o">.</span><span class="na">sexo</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">CruzamentoException</span><span class="o">(</span><span class="s">"N√£o √© poss√≠vel gerar filhote!"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">mistura</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">outro</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>O m√©todo <code>meow</code> √© o exemplo cl√°ssico que veremos em heran√ßa, ele n√£o retorna nada, s√≥ executa uma a√ß√£o. Aqui vamos focar nos m√©todos <code>cruza</code> e <code>mistura</code> (ok, focar na parte reprodutiva foi p√©ssimo&#8230;&#8203; mas estou falando de gatos!). <code>mistura</code> √© um m√©todo que aleatoriamente vai gerar um novo gato baseado nas caracter√≠sticas de dois gatos. Nele podemos ver que o m√©todo recebe dois par√¢metros e retorna um valor. No caso desse m√©todo, estamos retornando um novo objeto, mas nada impede de o retorno ser um dos par√¢metros. Outra caracter√≠stica √© que os par√¢metros s√£o uma passagem por refer√™ncia e n√£o por valor como vamos ver um pouco mais a frente. Sobre o m√©todo <code>cruza</code>, nele podemos acessar os campos do objeto local e campos da refer√™ncia. Quero ressaltar o uso do <code>this</code> que √© a forma de acessar a refer√™ncia ao objeto pela qual o m√©todo √© referenciado, o <code>this</code> n√£o pode ser usado para m√©todos est√°ticos.</p>
</div>
<div class="sect3">
<h4 id="cap-04-principios-heranca-implemenacao">Como Java implementa Heran√ßa</h4>
<div class="paragraph">
<p>Falamos sobre classes e alguns detalhes, mas agora precisamos falar de heran√ßa.</p>
</div>
<div class="paragraph">
<p>Temos 3 tipos de classe: a Classe, a Interface e a Classe Abstrata.</p>
</div>
<div class="paragraph">
<p><em>‚Äî Pera√™! Mas como uma classe pode ser tamb√©m Interface e Classe Abstrata?!?!? Tem algum erro l√≥gico nessa afirma√ß√£o!</em></p>
</div>
<div class="paragraph">
<p>N√£o! Segura essa informa√ß√£o que quando formos falar sobre Reflex√£o trataremos do conceito interno de Classe. Por enquanto aceite que existem tr√™s tipos de classe e um deles √© classe. ü§∑‚Äç‚ôÇÔ∏è</p>
</div>
<div class="paragraph">
<p>A Interface √© quando tempos um contrato de como uma classe deve ser implementada. Ela vai definir a assinatura de alguns m√©todos. Por assinatura entenda que √© a forma como a JVM usa para identificar um m√©todo, ela √© composta pelo nome do m√©todo e a lista de par√¢metros. O tipo de retorno n√£o faz parte de uma assinatura e isso vai ser importante mais a frente. Uma interface tamb√©m pode definir m√©todos <code>default</code> e m√©todos <code>static</code>. Uma interface normalmente √© usada para definir um tipo, ou comportamento, comum dentro de um sistema.</p>
</div>
<div class="paragraph">
<p>Uma classe abstrata √© uma classe que n√£o pode ser instanciada. Normalmente usamos quase abstrata quando desejamos compartilhar comportamento entre v√°rios tipos. Em uma classe abstrata podemos definir vari√°veis e m√©todos, mas tamb√©m podemos definir m√©todos abstratos (usando o modificador <code>abstract</code>). Ao se declara um m√©todo abstrato, estamos declarando apenas a assinatura, a implementa√ß√£o ficar√° a cargo de alguma classe que estende nossa classe abstrata.</p>
</div>
<div class="paragraph">
<p>E por fim uma classe √© uma implementa√ß√£o pela qual podemos instanciar objetos. Classes podem ser estendidas tamb√©m quando queremos modificar um comportamento espec√≠fico. Por exemplo, e se quisermos modificar a forma como o Garfield mia?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Gato</span> <span class="n">garfield</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Gato</span><span class="o">(</span><span class="mf">15.0</span><span class="o">,</span> <span class="nc">Cor</span><span class="o">.</span><span class="na">LARANJA</span><span class="o">,</span> <span class="nc">Temperamento</span><span class="o">.</span><span class="na">PREGUICOSO</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">meow</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Miaaaaaaau!"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Quando adicionamos um bloco de c√≥digo lodo ap√≥s a instancia√ß√£o da classe, estamos criando uma classe an√¥nima. Esse comportamento ser√° especifico dessa inst√¢ncia. N√≥s poder√≠amos evitar isso usando o modificador <code>final</code> no m√©todo ou na classe. Se usarmos no m√©todo, nenhuma subclasse poder√° estender esse m√©todo, mas se usarmos na classe, ela n√£o poder√° ser estendida.</p>
</div>
<div class="paragraph">
<p>Quando falamos de heran√ßa normalmente usamos as palavras estende e implementa. Estende √© quando temos uma classe abstrata sendo estendida, e isso √© feito usando a palavra reservada <code>extends</code>. J√° implementa √© quando temos uma interface sendo implementada pela classe, a palavra reservada <code>implements</code>.</p>
</div>
<div class="paragraph">
<p>O Java tem algumas limita√ß√µes em heran√ßas. Uma classe S√ì pode estender uma classe, mas pode implementar quantas interfaces forem necess√°rias. MAS interfaces com mesma assinatura e tipo de retorno diferentes n√£o s√£o poss√≠veis de serem implementas por uma mesma classe. No caso abaixo, temos que um <code>Gato</code> estende um <code>Felino</code> e implementa as interfaces <code>Miador</code> e <code>Ronronador</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Gato</span> <span class="kd">extends</span> <span class="nc">Felino</span> <span class="kd">implements</span> <span class="nc">Miador</span><span class="o">,</span> <span class="nc">Ronronador</span> <span class="o">{</span>
    <span class="c1">// Implementa√ß√£o</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cap-04-conceitos-oo">Conceitos da Orienta√ß√£o a Objetos</h3>
<div class="paragraph">
<p>Agora vamos discutir alguns conceitos comuns da orienta√ß√£o a objetos que podem nos auxiliar no dia a dia.</p>
</div>
<div class="sect3">
<h4 id="_heran√ßa">Heran√ßa</h4>
<div class="paragraph">
<p>Para entender heran√ßa, podemos pensar em heran√ßa gen√©tica. Todo objeto ele tem um arqu√©tipo e ele vai possuir uma hierarquia de tipos. Um <code>Gato</code> √© um <code>Felino</code> que √© um <code>Animal</code>. Cada uma dessas classes podem ter comportamentos associados ou apenas assinaturas de m√©todos. Se voltarmos no post anterior, sobre a biblioteca <code>Collections</code>, vamos ver o mais comum tipo de heran√ßa.</p>
</div>
<div id="jdk-lib-collections" class="imageblock text-center text-center">
<div class="content">
<img src="/assets/images/java-101/cap-03/Collections.png" alt="Collections">
</div>
<div class="title">Figura 2. Pacote Java Collections</div>
</div>
<div class="paragraph">
<p>Vamos ver o caso da <code>LinkedList</code> que estende uma <code>AbstractSequentialList</code> e implementa as interface <code>List</code>, <code>Deque</code>, <code>Cloneable</code> e <code>Serializable</code>.</p>
</div>
<div class="paragraph">
<p><code>LinkedList</code> √© uma classe, <code>AbstractSequentialList</code> √© uma classe abstrata e <code>List</code> uma interface. <code>AbstractSequentialList</code> cont√©m uma implementa√ß√£o de lista que por sua v√™z estende uma <code>AbstractList</code>. Podemos dizer que <code>LinkedList</code> herda implementa√ß√µes de <code>AbstractSequentialList</code> e <code>AbstractList</code>. Assim como podemos dizer que <code>LinkedList</code> e <code>ArrayList</code> herdam implementa√ß√µes de <code>AbstractList</code> mesmo tendo comportamentos completamente diferentes.</p>
</div>
<div class="paragraph">
<p>Da mesma forma <code>LinkedList</code> e <code>ArrayList</code> s√£o tipos de <code>List</code>, enquanto apenas <code>LinkedList</code> √© um tipo de <code>Deque</code>.</p>
</div>
<div class="paragraph">
<p>Quando temos uma classe que herda tipos de outras classe, podemos definir nossos objetos com o tipo que desejarmos. Eu recomendo sempre usar a interface que voc√™ deseja usar e n√£o a implementa√ß√£o final. Quer um exemplo? Vamos imaginar que eu quero definir um m√©todo que far√° uma busca especifica pelo Gato mais gordo. Ao inv√©s de declarar que desejo receber uma <code>LinkedList</code>, posso declarar que desejo receber apenas uma <code>List</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Gatos</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Gato</span> <span class="nf">maisGordo</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Gato</span><span class="o">&gt;</span> <span class="n">gatos</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// encontra o Garfield aqui que n√£o tem erro.</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Uma d√∫vida cl√°ssica √© se perguntar porque n√£o devo usar o tipo mais espec√≠fico. Nunca devemos usar as classes porque isso limita o uso do nosso c√≥digo. Ao usar um <code>List</code>, eu posso aceitar qualquer implementa√ß√£o de <code>List</code>, mesmo implementa√ß√µes que eu n√£o conhe√ßo. Essa preocupa√ß√£o ser√° muito mais real quando estivermos falando de frameworks em que a gera√ß√£o de c√≥digo ou classes do tipo proxy s√£o comuns.</p>
</div>
</div>
<div class="sect3">
<h4 id="_override">Override</h4>
<div class="paragraph">
<p>Chamamos de <em>Override</em> a pr√°tica de sobrescrever implementa√ß√µes de m√©todos em classes filhos. Vamos voltar ao nosso exemplo de Gatos, e se existe uma ra√ßa especifica de gatos que n√£o mia, s√£o gatos mudos. Como esse caracter√≠stica √© muito especifica mas ele definitivamente s√£o gatos, podemos criar essa nova classe de gatos e sobrescrever o m√©todo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GatoMudo</span> <span class="kd">extends</span> <span class="nc">Gato</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">meow</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"."</span><span class="o">);</span> <span class="c1">// . significa sil√™ncio</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Se tivermos um objeto da classe <code>GatoMudo</code>, mesmo que ele esteja definido como <code>Gato</code>, ser√° chamado o m√©todo da classe <code>GatoMudo</code>.</p>
</div>
<div class="paragraph">
<p>O uso da anota√ß√£o <code>@Override</code> n√£o √© obrigat√≥rio, mas √© altamente recomend√°vel.</p>
</div>
</div>
<div class="sect3">
<h4 id="_overload">Overload</h4>
<div class="paragraph">
<p>Chamamos de <em>Overload</em> quando criamos um novo m√©todo para um tipo diferente de par√¢metros. Essa t√©cnica √© excelente quando queremos criar m√©todos semelhantes para tipos diferentes. Vamos supor que nosso m√©todo de <code>mistura</code> vai ser migrado para a classe abstrata de animais e que queremos criar esse m√©todo para alguns tipos de animais, n√£o para todos, mas ele ser√° diferente para alguns grupos (tem animal que se divide e n√£o reproduz). Assim podemos criar um m√©todo mistura para os tipos <code>Mamifero</code>, <code>Ave</code>, <code>Reptil</code> e <code>Peixe</code>, cada m√©todo ter√° uma implementa√ß√£o completamente diferente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Gato</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Mamifero</span> <span class="nf">mistura</span><span class="o">(</span><span class="nc">Mamifero</span> <span class="n">mamiferoA</span><span class="o">,</span> <span class="nc">Mamifero</span> <span class="n">mamiferoB</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// M√°gica acontece</span>
        <span class="k">return</span> <span class="n">mamiferoC</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Ave</span> <span class="nf">mistura</span><span class="o">(</span><span class="nc">Ave</span> <span class="n">aveA</span><span class="o">,</span> <span class="nc">Ave</span> <span class="n">aveB</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// M√°gica acontece</span>
        <span class="k">return</span> <span class="n">aveC</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Reptil</span> <span class="nf">mistura</span><span class="o">(</span><span class="nc">Reptil</span> <span class="n">reptilA</span><span class="o">,</span> <span class="nc">Reptil</span> <span class="n">reptilB</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// M√°gica acontece</span>
        <span class="k">return</span> <span class="n">reptilC</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Peixe</span> <span class="nf">mistura</span><span class="o">(</span><span class="nc">Peixe</span> <span class="n">peixeA</span><span class="o">,</span> <span class="nc">Peixe</span> <span class="n">peixeB</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// M√°gica acontece</span>
        <span class="k">return</span> <span class="n">peixeC</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>N√≥s fizemos <em>overload</em> de um m√©todo est√°tico, mas poder√≠amos ter feito de um m√©todo de inst√¢ncia.</p>
</div>
</div>
<div class="sect3">
<h4 id="_hashcode-equals-e-tostring">HashCode, Equals e ToString</h4>
<div class="paragraph">
<p>Uma outra reclama√ß√£o constante de quem n√£o gosta de Java √© a necessidade de se implementar esses tr√™s m√©todos que as vezes parecem in√∫teis.</p>
</div>
<div class="paragraph">
<p>Primeiro devemos esclarecer que <code>hashCode</code>, <code>equals</code> e <code>toString</code> s√£o m√©todos extremamente √∫teis e usados constantemente pela JVM. √â sempre recomend√°vel a leitura da documenta√ß√£o da classe <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/lang/Object.html">Object</a> sobre esses tr√™s m√©todos.</p>
</div>
<div class="paragraph">
<p><code>hashCode</code> √© um m√©todo usado para o calculo do <em>Hash</em> do objeto. O hash √© um valor inteiro que ser√° usado para identificar cada objeto. Dois objetos iguais devem ter o mesmo hash, mas dois objetos com o mesmo hash n√£o s√£o iguais. Toda e qualquer classe usando o nome Hash usar esse m√©todo, assim se voc√™ tem um <code>HashMap</code> ou um <code>HashSet</code>, voc√™ tem o uso do m√©todo.</p>
</div>
<div class="paragraph">
<p><code>equals</code> √© um m√©todo usado para se verificar um objeto √© igual a outro. Ele √© usado por v√°rias algoritmos da JVM, as vezes associado com o hash ou sem associa√ß√£o. Quando temos um <code>HashMap</code> os dois m√©todos s√£o usados. O <code>equals</code> √© usando quando temos o que chamamos de <strong>Colis√£o de Hash</strong>, dois objetos diferentes que tem o mesmo hash.</p>
</div>
<div class="paragraph">
<p><code>toString</code> √© usado para se criar um valor String para a classe. Sempre implemente o toString para melhorar o rastreamento de erros em logs de execu√ß√£o.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cap-04-passagem-por-valor-e-referencia">Passagem por valor e Passagem por refer√™ncia</h3>
<div class="paragraph">
<p>Quando estudamos linguagem como C, estudar o tipo de passagem como argumento de uma fun√ß√£o √© muito importante, porque √© poss√≠vel controlar o que queremos fazer ao se escolher o tipo de par√¢metro. J√° em Java n√£o nos preocupamos muito, mas em ambas a linguagem temos a possibilidade de se passar um argumento como valor ou como refer√™ncia. Vamos primeiro definir para depois mostrar como pode ser feito?</p>
</div>
<div class="paragraph">
<p>Falamos de <strong>Passagem por valor</strong> de um argumento para uma fun√ß√£o quando ao se alterar o valor desse argumento dentro de um fun√ß√£o, essa altera√ß√£o n√£o √© refletida fora da fun√ß√£o. J√° quando falamos de <strong>Passagem por refer√™ncia</strong> de um argumento, ao se alterar o valor desse argumento dentro da fun√ß√£o ele √© refletido fora da fun√ß√£o. F√°cil de entender? N√£o?!?!</p>
</div>
<div class="paragraph">
<p>Em C, isso √© meio √≥bvio porque podemos passar o valor ou a refer√™ncia. Vou tentar mostrar aqui:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">incrementaValor</span><span class="p">(</span><span class="kt">int</span> <span class="n">valor</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">valor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">incrementaReferencia</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span> <span class="n">valor</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="o">*</span><span class="n">valor</span><span class="p">)</span><span class="o">++</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">valor</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">contador</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Valor: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">incrementaValor</span><span class="p">(</span><span class="n">contador</span><span class="p">));</span>  <span class="c1">// Imprime "Valor: 1"</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Valor: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">incrementaValor</span><span class="p">(</span><span class="n">contador</span><span class="p">));</span>  <span class="c1">// Imprime "Valor: 1"</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Valor: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">incrementaReferencia</span><span class="p">(</span><span class="o">&amp;</span><span class="n">contador</span><span class="p">));</span>  <span class="c1">// Imprime "Valor: 1"</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Valor: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">incrementaReferencia</span><span class="p">(</span><span class="o">&amp;</span><span class="n">contador</span><span class="p">));</span>  <span class="c1">// Imprime "Valor: 2"</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>O que acontece quando eu chamo a fun√ß√£o <code>incrementaValor</code> √© que uma c√≥pia do contador √© enviado para a fun√ß√£o, mas quando chamo <code>incrementaReferencia</code> o pr√≥prio contador √© enviado para a fun√ß√£o.</p>
</div>
<div class="paragraph">
<p>Em Java s√≥ temos passagem por valor quando usamos tipos primitivos (<code>byte</code>, <code>short</code>, <code>int</code>, <code>long</code>, <code>float</code>, <code>double</code> ou <code>char</code>). Quando definimos um objeto, sempre estamos passando a refer√™ncia do mesmo para fun√ß√µes. Por isso √© muito importante entender o que √© e como garantir imutabilidade. Quando formos falar de mem√≥ria, vou explicar o que √© o conceito de mem√≥ria e como isso funciona na pr√°tica, mas, resumidamente, tipos primitivos s√£o armazenados na stack do programa enquanto todas as classes s√£o armazenados na memoria heap do programa. Ao se criar um objeto, um ponteiro na stack √© criado para um novo espa√ßo de memoria alocado na Heap. <em>Calma, voc√™ n√£o tem obriga√ß√£o de entender isso facilmente</em>!!!</p>
</div>
</div>
<div class="sect2">
<h3 id="_imutabilidade-e-mutabilidade">Imutabilidade e Mutabilidade</h3>
<div class="paragraph">
<p>Chamamos de mutabilidade a capacidade de um objeto ter seu estado interno alterado. Em orienta√ß√£o a objetos mutabilidade √© um requisito desejado para quase todas as classes, por isso que s√≥ recentemente o Java incorporou o conceito de imutabilidade a linguagem atrav√©s dos Records. Antes dos Records era comum se usar POJOs em que existia para cada campo um respectivo <code>get</code> e um <code>set</code>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">POJO</div>
POJO √© um acr√¥nimo para <em>Plain Old Java Object</em>, que significa velho e simples objeto Java. √â um termo usado para referenciar um padr√£o de classes Java que n√£o dependem da heran√ßa de interfaces ou classes de frameworks externos.
</div>
</div>
<div class="paragraph">
<p>Records √© o tipo que adiciona o conceito de imutabilidade ao c√≥digo Java. Abaixo vou definir a classe <strong>Usuario</strong> tr√™s vezes. Na primeira vez ela √© mut√°vel, na segunda imut√°vel usando POJO e na terceira usando record.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Usuario</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Usuario</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUsername</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">username</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getEmail</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">email</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEmail</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Implementa hashCode, equals e toString</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para implementar um campo imut√°vel, devemos usar o modificador de acesso <code>final</code>. Um campo final ter√° seu valor definido no construtor e n√£o poder√° ser alterado em todo ciclo de vida do objeto.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Usuario</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Usuario</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUsername</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">username</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getEmail</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">email</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Implementa hashCode, equals e toString</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ao usar records, √© como se todos os campos j√° fossem definidos como final, mas a grande vantagem se d√° que n√£o precisamos implementar os m√©todos <code>hashCode</code>, <code>equals</code> e <code>toString</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="n">record</span> <span class="nf">Usuario</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cap-04-conclusao">Conclus√£o</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Orienta√ß√£o a Objeto √© uma √≥tima t√©cnica para fazer design de c√≥digo. Ela √© melhor utilizada quando tempos que modelar problemas do mundo real, mas haver√° dificuldade se o modelo for mais pr√≥ximo de um modelo matem√°tico.</p>
</div>
<div class="paragraph">
<p>O principal ganho com a modelagem a Orienta√ß√£o a Objetos √© a capacidade de se encapsular complexidades.</p>
</div>
</div>
</div>]]></content><author><name>{&quot;twitter&quot;=&gt;&quot;vepo&quot;, &quot;linkedin&quot;=&gt;&quot;https://www.linkedin.com/in/victorosorio/&quot;, &quot;picture&quot;=&gt;&quot;/assets/images/me.avif&quot;}</name></author><category term="Orienta√ß√£o a Objeto" /><category term="Tutorial" /><category term="Java" /><summary type="html"><![CDATA[Voc√™ sabe o que √© Orienta√ß√£o a Objetos? E voc√™ sabe porque OO √© o principal foco da linguagem Java? A ideia desta s√©rie √© criar um tutorial Java onde mostrarei todos os segredos da linguagem e do ecossistema.]]></summary></entry></feed>