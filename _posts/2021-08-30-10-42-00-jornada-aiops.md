---
title: Jornada AIOps
permalink: /posts/jornada-aiops
published: false
description: Um breve relato sobre a proposi√ß√£o de uma solu√ß√£o que decidimos n√£o apresentar uma solu√ß√£o, mas um modelo de maturidade. Era um desafio, o que apresentamos n√£o cobria o que era deseja, mas mesmo assim ganhamos.
tags: [AIOps, AI, O homem que sabia javan√™s]
cover_image: /assets/images/pexels-negative-space-169573.jpg
publish_date: 2021-08-30 10:45:00 +0300
---

No √∫ltimo s√°bado terminamos (eu e meu grupo) o MBA da FIAP de Arquitetura de Software como campe√µes do desafio principal. Preciso confersar que estavamos completamente c√©ticos em rela√ß√£o a qualquer pr√™mio por dois motivos. O primeiro √© que n√£o entregamos o que foi pedido e o segundo √© que a nossa proposi√ß√£o de arquitetura era o mais simples poss√≠vel. Mas vou descrever essa jornada.

# O Desafio

Na verdade era um _Chalenge_, mas como eu me recuso a usar termos extrangeiros se temos bons termos em pt-BR, mas vou chamar de desafio mesmo! üòÄ

Um banco que existe antes das FinTechs, mas que cresceu na era das FinTechs, apresentou uma proposta de melhoria da sua gest√£o de infraestrutura: **_"queremos AIOps"_**. A proposta parecia generica, e realmente era. Tudo que eles pediam era uma apresenta√ß√£o da arquitetura proposta com um demonstra√ß√£o. Eles focaram que era algo HandsOn! Queriam ver funcionando no dia da entrega. N√£o havia nada mais especificado.

Durante as mentorias, conseguimos levantar alguns pontos da infraestrutura do banco. Eles usavam um provedor de Cloud que j√° tinham escolhidos como principal fornecedor. E usavam duas ferramentas, uma para APM e outra para monitoramento de rede. N√£o conheciamos e nunca t√≠nhamos usado nenhuma dessas ferramentas, para ser sincero, durante minha carreira eu tive pouco contato com software em produ√ß√£o, ent√£o monitoramento √© uma fraqueza. S√≥ usei o NewRelic e fiz alguns deploys usando a plataforma ELK. Mas isso n√£o me d√° a vis√£o de uma infraestrutura completa para um banco.

# Desi√ß√µes iniciais e Defini√ß√µes

Na conversa com o grupo chegamos a primeira conclus√£o: _o desafio √© vago_. Se entregarmos algo HandsOn, √© bem prov√°vel que cubra todos os requisitos e podemos at√© ganhar, mas ao encarar o primeiro trade-off, pode ser completamente descartado. Ent√£o fizemos a primeira pergunta: _como entregar algo que com certeza n√£o vai ser jogado fora?_ Era hora de pesquisar.

A primeira defini√ß√£o que encontramos foi do [Gartner](https://www.gartner.com/en/information-technology/glossary/aiops-artificial-intelligence-operations), na verdade foi a √∫nica que fomos atr√°s. N√£o fomos atr√°s de outras defini√ß√£o por um motivo bem simples: **fugir do papo de vendedor**. Normalmente quem escreve sobre um assunto √© quem vende um produto relacionado, e muitos desses "white-papers" est√£o na verdade n√£o apaixonados pelo problema, mas vendendo uma solu√ß√£o.

> _AIOps combines big data and machine learning to automate IT operations processes, including event correlation, anomaly detection and causality determination._

Segundo o Gartner, AIOps envolve eventos. AIOps come√ßa quando eventos podem ser colocados dentro um algoritmos de Machine Learning. Nesse ponto informamos claramente para a equipe do banco: _pode tirar o cavalinho da chuva que n√£o vai ser f√°cil_. Pois √©, ao inv√©s de vendermos nossa solu√ß√£o, falamos a verdade. Para criar um solu√ß√£o robusta de AIOps era preciso catalogar dados, criar eventos e treinar uma rede neural.

# _"Conhece-te a ti mesmo"_

O segundo passo foi criar um meio de auto avalia√ß√£o. N√£o faz sentido apresentarmos uma solu√ß√£o para uma empresa e ela mesmo n√£o conseguir avaliar se a solu√ß√£o permitia AIOps ou n√£o. Logo procuramos se existe algum modelo de maturidade para AIOps.

Se voc√™ nunca parou para olhar o que √© um modelo de maturidade, recomendo fortemente que procure algum. Voc√™ pode encontrar facilmente para Metodologias √Ågil e DevOps. Na maioria dos casos come√ßar a fazer algo n√£o significa apenas usar ferramentas, mas entender o problema e saber como a ferramenta pode de ajudar a implementar uma politica.

Ao procurar um bom modelo de maturidade tivemos o mesmo problema com a defini√ß√£o: _papo de vendedor_. Normalmente quem produz um modelo de maturidade quer validar a pr√≥pria ferramenta e n√£o avaliar a adequa√ß√£o do problema com a solu√ß√£o. O problema √© que a solu√ß√£o proposta vai sempre levar ao n√≠vel mais alto, pois todas as defici√™ncias da solu√ß√£o ser√£o propositadamente omitidas. Ent√£o passamos a segunda, terceira, quarta, etc... p√°gina do google para encontrar um modelo que fosse realmente abrangente.

Assim pudemos propor o seguinte modelo:

* N√≠vel 0 - Caos
    * Sem dados
    * Sem an√°lises
    * Sem automa√ß√£o
* N√≠vel 1 - Coleta
    * Servi√ßos com suporte a coleta de informa√ß√µes de opera√ß√£o
* N√≠vel 2 - Consolida√ß√£o
    * Dados da opera√ß√£o centralizados
    * Identifica√ß√£o manual de erros
    * Constru√ß√£o manual de dashboards
* N√≠vel 3 - Contextualiza√ß√£o
    * Extra√ß√£o de informa√ß√µes dos dados
    * Identifica√ß√£o autom√°tica de erros
    * Estat√≠sticas n√£o supervisionadas
    * Automa√ß√£o bi-direcional (ITSM)
* N√≠vel 4 - Conselho
    * Recomenda√ß√£o de fontes de dados
    * Recomenda√ß√µes de an√°lises e correla√ß√µes
    * Automa√ß√£o de m√∫ltiplos passos
* N√≠vel 5 - Aut√¥mato
    * Otimiza√ß√£o proativa
    * Tuning de performance
    * Solu√ß√£o autom√°tica de problemas
    * Automa√ß√£o Closed-Loop

√â muito importante que o modelo de maturidade seja devidamente apresentado a empresa, porque muitos entendem que podem chegar ao n√≠vel m√°ximo apenas usando algumas ferramentas. ISSO √â UM MITO! Todo maturidade chega atrav√©s de muito esfor√ßo e mudan√ßas graduais. √â bem prov√°vel que a maioria das empresas esteja no n√≠vel 0, mas se simplesmente falarmos que elas vivem o Caos j√° perdemos o cliente. Porque na verdade nenhuma empresa s√©ria vive o Caos, eles podem at√© estar nessa fase, mas j√° criaram uma s√©rie de processos para garantir que o caos seja controlado. O que acontece √© que a empresa caminha para o lado no modelo de maturidade, ao inv√©s de andar para o n√≠vel 1, ela vai criar processos que engessem o caos tornando ele extremamente burocratico. 

Quer um exemplo dessa burocracia? Uns 5 anos atr√°s eu vi uma palestra de um IT Leader (termo generico, n√£o!?) contando como foi a migra√ß√£o de todos os servi√ßos da empresa para nuvem. A apresenta√ß√£o de cerca de 50 minutos n√£o contou com nenhuma defini√ß√£o, padr√£o estabelecido ou mesmo conceito. N√£o falaram de Cloud Native, Microservices, etc... Como a empresa fez? Replicou tudo na nuvem e foi verificando se o servi√ßo replicado na nuvem era igual ao executado on-premise. Ora, qual foi o custo disso?!!? Depois eles migraram pra nuvem e mantiveram o on-premise ainda em atividade para garantir um fallback. Eu n√£o quero saber quantas noites esses infelizes perderam por n√£o estudar o conceito de Cloud Native que j√° tem uns 10 anos, ou por n√£o ter estabelicido um padr√£o para toda a aplica√ß√£o.

Com o modelo de maturidade acima, a empresa poderia criar um planejamento para andar entre as fases.

# Escolhas de ferramentas

O pr√≥ximo passo era escolher ferramentas que pudessem possiblitar a implanta√ß√£o de cada n√≠vel do AIOps. Para isso fizemos um grande levantamento. Quem pode ajudar em cada linha do nosso modelo de maturidade? Fizemos a lista de todos os nomes e come√ßamos a jogar em um diagrama. Mas para fazer uma integra√ß√£o n√£o √© s√≥ criar uma seta num diagrama [ArchiMate](https://www.opengroup.org/archimate-forum/archimate-overview), √© muito f√°cil criar diagramas mas √© bastante complexo colocar eles em funcionamento.

Logo come√ßamos uma busca intensiva por toda a documenta√ß√£o de todas as ferramentas com a seguinte pergunta: _como eu integro a ferramenta A na ferramenta B?_ Com essa an√°lise simples, j√° pudemos dividir as ferramentas em conjuntos de poss√≠veis solu√ß√µes. Mas j√° no come√ßo sabiamos de algumas limita√ß√µes, pois o banco j√° usava duas ferramentas e escolhido o provedor Cloud. Assim todas as solu√ß√µes deveriam incluir essas duas ferramentas e esse provedor cloud.

# A decis√£o dif√≠cil

Entre as v√°rias op√ß√µes arquiteturais, tinhamos algumas plataformas Open Source e v√°rias empresas oferecendo servi√ßos. 

Escolher uma solu√ß√£o open source seria minha escolha de cora√ß√£o, mas isso requer bastante trabalho para implantar. Muitas vezes acreditamos que √© f√°cil montar uma equipe com bons desenvolvedores que entendem de plataformas open source e s√£o h√°beis em pesquisar solu√ß√µes na internet. Mas na verdade o mercado √© bem diferente da nossa bolha. A grande maioria dos desenvolvedores n√£o tem essa habilidade, n√£o conseguem entender os protocolos e muitos n√£o entendem nada em ingl√™s. Logo a solu√ß√£o precisava ser provida por uma empresa que daria um bom suporte.

E sobre ter v√°rias empresas, isso √© realmente bom... MAS... O que observamos no passo anterior foi que as pr√≥prias empresas que prov√™em servi√ßos de observabilidade est√£o se chefando em silos propositadamente. A empresa sabe que se ela os produtos A e B, se ela prover integra√ß√£o do produto A com o B da concorr√™ncia, ela vai perder mercador. Logo as empresas que tem produtos lideres de mercado est√£o removendo possiblidades de integra√ß√£o. N√≥s verificamos isso fazendo uma correla√ß√£o de datas de lan√ßamento de produtos, posts de blogs e documenta√ß√£o. Quando a empresa lan√ßa um produto, ela retira a possibilidade de integra√ß√£o da documenta√ß√£o e os posts de blogs anteriores a data de lan√ßamento do produto v√£o possuir links inv√°lidos. O que isso significa?

Se escolhessemos as melhores ferramentas para cada passo, teriamos uma grande dificuldade de evoluir pois cada integra√ß√£o seria custosa. Ent√£o era mais f√°cil acentar o Vendor Lock-In para podermos propor uma arquitetura f√°cil e r√°pida de se implantar. Depois de implantada a empresa poderia avaliar uma troca de servi√ßo. Assim decidimos que todas os servi√ßos deveriam ser do proprio provedor de Cloud, que nesse caso era a AWS.

Usando o mesmo provedor de servi√ßos evitamos silos de dados. Se a ferramenta de AIOps s√≥ precisar olhar para um local √© muito mais f√°cil de manter e evoluir a solu√ß√£o.

# Cria√ß√£o de um plano

Eu sempre digo que se temos um plano, temos tudo. Ter um plano √© como viajar para um lugar desconhecido com um mapa, mesmo se pegarmos o caminho errado, √© poss√≠vel reavaliar e propor uma nova rota. Todo plano pode ser reavaliado.

Dados os n√≠vels de maturidade come√ßamos a escolher ponto a ponto de como integrar. Primeiro era preciso ter dados! Por isso propusemos um escolha que todos os microsservi√ßos deveriam expor seus dados em formato [Prometheus](https://prometheus.io/docs/introduction/overview/). N√£o vamos usar o Prometheus, mesmo sendo uma das possibilidades, mas percebemos que todos os servi√ßos est√£o abertos a se integrar com solu√ß√µes open source. Todo servi√ßo deve ser Cloud Native, seguir os 12 Fatores e usar um framework moderno. Como exemplo criei um servi√ßo de registro de pagamento bem simples usando [Quarkus.io](http://quarkus.io/), [PostgreSQL](https://www.postgresql.org/) com JPA Panache, [Jakarta Bean Validation](https://vepo.github.io/posts/using-bean-Validation-on-quarkus), [Microprofile Metrics](https://quarkus.io/guides/smallrye-metrics), [Microprofile Health](https://quarkus.io/guides/smallrye-health) e [OpenAPI](https://www.openapis.org/). Usando o esqueleto de microsseri√ßo j√° atingimos o n√≠vel 1, habilitando a coleta de informa√ß√µes.

O pr√≥ximo passo √© consolidar todos esses dados em um s√≥ local. √â muito importante que seja um s√≥ local, pois isso facilitar√° a implementa√ß√£o. Para isso escolhemos o AWS CloudWatch, porque ele √© o servi√ßo que faz isso nativamente para Amazon. Se precisamos coletar dados de servidores on-premise, podemos usar o AWS CloudWatch Agente para coletar todos os dados e salvar no mesmo _"lake"_. 

Lembra que a empresa j√° possuia alguns servi√ßos de monitoramento? Esses servi√ßos n√£o poderiam ser facilmente integrados, n√£o h√° suporte. Por isso propusemos exportar os dados em formato Prometheus, que podemser coletado pelo AWS CloudWatch Agente e, al√©m disso, criar eventos e alarmes que podem ser enviados via API para o AWS CloudWatch. Esses servi√ßos podem ser usados, mas a integra√ß√£o n√£o vai ser nativa.

Usando apenas o AWS CloudWatch j√° √© poss√≠vel criar um dashboard com as informa√ß√µes principais do ecossistema. √â poss√≠vel tamb√©m identificar erros e criar eventos e alertas baseado em padr√µes de logs, correla√ß√£o de eventos, etc... A escolha do AWS CloudWatch por se s√≥ j√° leva ao n√≠vel 2, mas ser√° preciso uma fase de cria√ß√£o de dashboards, eventos e alertas para chegar a plenitude do n√≠vel 2 e depois chegar ao n√≠vel 3, contextualizando dados e logs.

Um ponto interessante que eu n√£o tinha nem ideia, √© que o sistema banc√°rio √© super regulamentado. Agrade√ßa a essa regulamenta√ß√£o por n√£o termos tido crise nos anos 2008/09. Essa regulamenta√ß√£o vem l√° dos anos 90, quando v√°rios bancos quebraram por pura picaretagem dos seus diretores. Quem tem mais de 35 vai se [lembrar](https://pt.wikipedia.org/wiki/Salvatore_Cacciola) de v√°rios homens branco classe AAA+++++ sendo presos, mans√µes sendo leiloadas, etc... Bom, dessa regulamenta√ß√£o vem um rigido processo de ITSM, isso significa que nenhuma opera√ß√£o na produ√ß√£o deve ser feita sem um rastreamento. Por isso precisamos escolher uma ferramenta de ITSM externa a AWS, mas que pode ser integrada vai API usando Lambda. Com alertas e fun√ß√µes lambdas √© poss√≠vel automatizar v√°rias opera√ß√µes tanto na n√∫vem quanto em on premise.

Para finalizar, propomos o uso do AWS DevOps Guru, um produto da propria AWS que promete magicamente habiltiar o AIOps. Mas fomos bem c√©tico nesse uso. Ao propor j√° avisamos que nenhuma solu√ß√£o de Machine Learning vem de gra√ßa, tem que ter uma base tageada e treinamento de modelos. N√£o fizemos nenhuma PoC usando o DevOps Guru, apenas propomos e ainda dissemos para s√≥ habilitar quando todo o dever de casa estiver feito.

![AWS DevOps Guru](/assets/images/aws-devops-guru.png)

Essa solu√ß√£o √© propositadamente simples.

# Outras solu√ß√µes

N√£o tinhamos nenhuma esperan√ßa de ganhar e quando come√ßaram as apresenta√ß√µes percebemos claramente que n√£o iriamos ganhar. Todas as solu√ß√µes eram extremamente complexas, usavam ao menos 10 produtos diferentes. Teve um grupo que chegou a propor uma integra√ß√£o plugando um Apache Kafka no AWS CloudWatch, nessa hora eu peguei minha garrafa de √°gua pra ver se algu√©m tinha colocado drogas ou se o grupo realmente n√£o tinha parado para avaliar o n√≠vel de dificuldade da solu√ß√£o proposta.

Muitos quando era questionados das escolhas gagejavam ou dava desculpas esfarrapadas. Nossa solu√ß√£o n√£o era a cereja do bolo, no documento que entregamos ela ocupava poucos paragr√°fos (algo como uns dois a mais que a sess√£o anterior) com alguns links de documenta√ß√£o. O ponto principal era o modelo de maturidade.

# Conclus√£o

Complexidade e papo de vendedor vende. Mas verdade e simplicidade convencem muito melhor. Muitos arquitetos gostam de complexidade porque eles acreditam que ela vai dar eleg√¢ncia a solu√ß√£o. Mas o conceito de eleg√¢ncia vem da simplicidade, fazer o b√°sico bem feito.

Ao propor uma arquitetura leia toda a documenta√ß√£o, evite passar vergonha de propor a solu√ß√£o errada. Pode ser que quando voc√™ for apresentar ningu√©m realmente saiba do que voc√™ est√° falando, mas pode ser que exista um especialista no assunto. Existe at√© um conto centen√°rio chamado [O homem que sabia javan√™s](https://www.amazon.com.br/Homem-Sabia-Javan%C3%AAs-Outros-Contos/dp/8534235929) que mostra como uma pessoa pode parecer inteligente apenas sendo cara de pau. N√£o seja essa pessoa, isso √© leviano e injusto. Creio que n√≥s s√≥ ganhamos esse pr√™mio porque ao vender as dificuldades de implementa√ß√£o e fazer uma pesquisa s√©ria no tema implodimos todas as solu√ß√µes imposs√≠veis e colocamos uma bomba rel√≥gio na complexidade desnecess√°ria.