<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" type="image/png" href="/icon.png" />
  <meta name="google-site-verification" content="xw_kgncLhv22qVjTIPi7adALZre8FIHY02-DGCuYuZ4" />

   <!-- SEO stuff -->
  
  <title>Testes de Kafka Stream e Schema Registry</title>
  <meta property="og:title" content="Testes de Kafka Stream e Schema Registry" />
  

  
  <meta name="description" content="Qual é a maneira mais fácil de se testar um consumer/producer/stream Kafka usando Schema Registry?" />
  <meta property="og:description" content="Qual é a maneira mais fácil de se testar um consumer/producer/stream Kafka usando Schema Registry?" />
  

  
  <meta name="keywords" content="Apache Kafka, Unit Test, Java">
  

  <link rel="canonical" href="https://blog.vepo.dev/posts/mock-schema-registry" />
  <meta property="og:url" content="https://blog.vepo.dev/posts/mock-schema-registry" />
  <meta property="og:site_name" content="Notas do dia a dia de um engenheiro de software" />

  
  <meta property="og:image" content="https://blog.vepo.dev/assets/images/capas/chaplin-modern-times.webp" />
  

  
  <!-- if it's an article -->
  <meta property="og:type" content="article" />
  
  <meta property="article:published_time" content="2023-01-27T07:21:00+00:00" />
  <meta property="article:modified_time" content="2023-01-27T07:21:00+00:00" />
  

  <meta content="https://www.linkedin.com/in/victorosorio/" property="article:author">

  
  
  

  
  
  <meta content="Apache Kafka" property="article:tag">
  
  <meta content="Unit Test" property="article:tag">
  
  <meta content="Java" property="article:tag">
  
  

  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "BlogPosting",
      "headline": "Testes de Kafka Stream e Schema Registry",
      "datePublished": "2023-01-27T07:21:00+00:00",
      
      "description": "Qual é a maneira mais fácil de se testar um consumer/producer/stream Kafka usando Schema Registry?",
      
      
      "url": "https://blog.vepo.dev/posts/mock-schema-registry"
    }
  </script>

  

  <link rel="author" href="https://www.linkedin.com/in/victorosorio/" />
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
  <link href="https://db.onlinewebfonts.com/c/1e44faec07b8b81f60a3215d76bd0086?family=Irvin-Heading" rel="stylesheet">
  <link href="https://db.onlinewebfonts.com/c/68e94a17c3e618dbe0936fcbf25b26c6?family=TNY+Adobe+Caslon+Pro+Regular" rel="stylesheet"> 
  <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/assets/css/main.css" />
  <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/assets/css/syntax.css">
  <script src="/assets/js/jquery.min.js"></script>
  <script src="/assets/js/adjustments.js" async></script>
  <!--script src="https://stats.vepo.dev/load-stats.js" async></script-->
  <script src="https://kit.fontawesome.com/9b30a05807.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="/assets/js/pdf.js"></script>
  <script>
      window.MathJax = {
      tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
      };
  </script>
</head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YXWDKRN6ZR"></script>
<script async>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-YXWDKRN6ZR');
</script>


<body>
    <main class="container">
        <div class="row g-5">
            <div class="col-md-2">
                <div class="position-sticky" style="top: 2rem;">
                    <header class="site-header">
                        <h3 class="site-title"><a href="/">Victor Osório</a></h3>
                        <nav class="menu-list">
	
	<a href="/tags" class="menu-link">Tags</a>
	
	<a href="/series" class="menu-link">Séries</a>
	
	<a href="/palestras" class="menu-link">Palestras</a>
	
	<a href="/en" class="menu-link">English</a>
	
	<a href="/tutorial" class="menu-link">Tutoriais</a>
	
	<a href="/livros" class="menu-link">Livros</a>
	
	<a href="/about" class="menu-link">Sobre</a>
	
</nav>
                    </header>
                </div>
            </div>
            <div class="col-md-10 main-content">
                <div class="article cover-image">
                    
                    <img alt="Testes de Kafka Stream e Schema Registry" src="/assets/images/capas/chaplin-modern-times.webp" class="img-fluid" />
                    
                </div>
                <div class="title">
                    
                    <h1 class="serie-title">
                        Testes de Kafka Stream e Schema Registry
                    </h1>
                    
                </div>
                
                
                <div class="publish_date">
                    <strong>
                        <time datetime="2023-01-27T07:21:00+00:00">
                            27/janeiro/2023
                        </time>
                    </strong>
                </div>
                
                <div class="tag-container">
                    
                    <a class="label label-default apache-kafka" href="/tags/#apache-kafka">
                        <i class="fas fa-tags"></i>
                        Apache Kafka
                    </a>
                    
                    <a class="label label-default unit-test" href="/tags/#unit-test">
                        <i class="fas fa-tags"></i>
                        Unit Test
                    </a>
                    
                    <a class="label label-default java" href="/tags/#java">
                        <i class="fas fa-tags"></i>
                        Java
                    </a>
                    
                </div>
                
                
                <hr>
                
                
                <article>
                    <p>Testes unitários são algo bem complexos usando Kafka Stream. É muito difícil separar o que é middleware do que é seu código próprio porque todo código vai depender de alguma dependência do Kafka que será muito difícil de criar mocks. Aqui vou mostrar de forma superficial como é possível criar testes unitários para Kafka Streams.</p>

<p>Antes de continuar precisamos trazer um pequeno esclarecimento sobre testes. Quando falamos de Unit Testing estamos separando uma parte de código para testar isoladamente. Já os testes de integração serão feitos usando os componentes externos. Essa é uma explicação superficial, seja benevolente pois minha intenção aqui não é falar sobre testes em geral.</p>

<h1 id="1-como-testar-um-kafka-stream">1. Como testar um Kafka Stream</h1>

<p>Antes de testar um Kafka Stream você precisa diferenciar dois conceitos do Stream. Todo Stream é um fluxo de dados e esse fluxo é representado pela classe <a href="https://kafka.apache.org/34/javadoc/org/apache/kafka/streams/Topology.html"><code class="language-plaintext highlighter-rouge">Topology</code></a>. A topologia é a implementação da sua lógica de negócios e com ela dá para criar um Stream. Vamos ver isso no código abaixo?</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CountDownLatch</span> <span class="n">latch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>    <span class="o">(</span><span class="mi">1</span><span class="o">)</span>

<span class="nc">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">APPLICATION_ID_CONFIG</span><span class="o">,</span> <span class="n">applicationId</span><span class="o">);</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">BOOTSTRAP_SERVERS_CONFIG</span><span class="o">,</span> <span class="n">bootstrapServers</span><span class="o">);</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">DEFAULT_KEY_SERDE_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">().</span><span class="na">getClass</span><span class="o">());</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">DEFAULT_VALUE_SERDE_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">().</span><span class="na">getClass</span><span class="o">());</span>

<span class="nc">StreamsBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StreamsBuilder</span><span class="o">();</span>    <span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="nc">KStream</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">textLines</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">inputTopic</span><span class="o">);</span>    <span class="o">(</span><span class="mi">3</span><span class="o">)</span>
<span class="nc">KTable</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">wordCounts</span> <span class="o">=</span> <span class="n">textLines</span><span class="o">.</span><span class="na">flatMapValues</span><span class="o">(</span><span class="n">textLine</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Flat Map: "</span> <span class="o">+</span> <span class="n">textLine</span><span class="o">);</span>
                                                            <span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">textLine</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">"\\W+"</span><span class="o">));</span>
                                                          <span class="o">}).</span><span class="na">groupBy</span><span class="o">((</span><span class="n">key</span><span class="o">,</span> <span class="n">word</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                                                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Grouping: key="</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">" work="</span> <span class="o">+</span> <span class="n">word</span><span class="o">);</span>
                                                                        <span class="k">return</span> <span class="n">word</span><span class="o">;</span>
                                                          <span class="o">}).</span><span class="na">count</span><span class="o">(</span><span class="nc">Materialized</span><span class="o">.&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">,</span> <span class="nc">KeyValueStore</span><span class="o">&lt;</span><span class="nc">Bytes</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;&gt;</span><span class="n">as</span><span class="o">(</span><span class="s">"counts-store"</span><span class="o">));</span>
<span class="n">wordCounts</span><span class="o">.</span><span class="na">toStream</span><span class="o">().</span><span class="na">to</span><span class="o">(</span><span class="n">outputTopic</span><span class="o">,</span> <span class="nc">Produced</span><span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">(),</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">Long</span><span class="o">()));</span>
<span class="nc">Topology</span> <span class="n">topology</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>    <span class="o">(</span><span class="mi">4</span><span class="o">)</span>
<span class="nc">KafkaStreams</span> <span class="n">streams</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">KafkaStreams</span><span class="o">(</span><span class="n">topology</span><span class="o">,</span> <span class="n">props</span><span class="o">);</span>   <span class="o">(</span><span class="mi">5</span><span class="o">)</span>

<span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">addShutdownHook</span><span class="o">(</span><span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="s">"streams-shutdown-hook"</span><span class="o">)</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">streams</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">});</span>
<span class="n">streams</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="n">latch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</code></pre></div></div>

<p>Para explicar esse código vou levantar 5 pontos sobre ele. O primeiro <strong>(1)</strong> é que como o Stream funciona assincronamente quando usamos ele sem o auxilio de um framework precisamos garantir que o thread principal não seja finalizada, por isso eu uso o <code class="language-plaintext highlighter-rouge">CountDownLatch</code>. Depois <strong>(2)</strong> temos a classe <code class="language-plaintext highlighter-rouge">StreamsBuilder</code> que deve ser usada para se construir o Stream, como podemos ver no trecho iniciado em <strong>(3)</strong> deve existir um inicio e um fim do fluxo de dados, isso é feito usando uma DSL, mas depois o builder é usado para se gerar a topologia <strong>(4)</strong>. E por fim usamos a topologia gerada e as propriedades para criar o <code class="language-plaintext highlighter-rouge">KafkaStreams</code>.</p>

<p>A classe gerada pelo <code class="language-plaintext highlighter-rouge">KafkaStreams</code> vai se conectar diretamente com o Kafka, qualquer teste usando ela será um teste de integração, caso você queira fazer um teste de integração, recomendo o uso do <a href="https://www.testcontainers.org/modules/kafka/">TestContainers</a> eu fiz um exemplo uma vez, mas <a href="https://github.com/vepo/kafka-stream-with-testcontainers/blob/main/src/test/java/io/vepo/kafka/stream/delay/KafkaStreamTest.java">o teste</a> fica um pouco lento e limitado.</p>

<p>Mas o Kafka provê uma forma de testarmos a nossa topologia sem criar um Stream, para isso devemos usar a classe <a href="https://kafka.apache.org/34/javadoc/org/apache/kafka/streams/TopologyTestDriver.html"><code class="language-plaintext highlighter-rouge">TopologyTestDriver</code></a>. Ela é instanciada da mesma forma do <code class="language-plaintext highlighter-rouge">KafkaStream</code>. Logo o código acima poderia ser refatorada para que a criação da topologia e o controle do stream fossem feito por trechos de código diferentes (<em>não vou propor nada</em>).</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">APPLICATION_ID_CONFIG</span><span class="o">,</span> <span class="n">applicationId</span><span class="o">);</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">BOOTSTRAP_SERVERS_CONFIG</span><span class="o">,</span> <span class="s">"dummy:1234"</span><span class="o">);</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">DEFAULT_KEY_SERDE_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">().</span><span class="na">getClass</span><span class="o">());</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">DEFAULT_VALUE_SERDE_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">().</span><span class="na">getClass</span><span class="o">());</span>

<span class="nc">StreamsBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StreamsBuilder</span><span class="o">();</span>

<span class="nc">KStream</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">textLines</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">inputTopic</span><span class="o">);</span>
<span class="nc">KTable</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">wordCounts</span> <span class="o">=</span> <span class="n">textLines</span><span class="o">.</span><span class="na">flatMapValues</span><span class="o">(</span><span class="n">textLine</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Flat Map: "</span> <span class="o">+</span> <span class="n">textLine</span><span class="o">);</span>
                                                            <span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">textLine</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">"\\W+"</span><span class="o">));</span>
                                                          <span class="o">}).</span><span class="na">groupBy</span><span class="o">((</span><span class="n">key</span><span class="o">,</span> <span class="n">word</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                                                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Grouping: key="</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">" work="</span> <span class="o">+</span> <span class="n">word</span><span class="o">);</span>
                                                                        <span class="k">return</span> <span class="n">word</span><span class="o">;</span>
                                                          <span class="o">}).</span><span class="na">count</span><span class="o">(</span><span class="nc">Materialized</span><span class="o">.&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">,</span> <span class="nc">KeyValueStore</span><span class="o">&lt;</span><span class="nc">Bytes</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;&gt;</span><span class="n">as</span><span class="o">(</span><span class="s">"counts-store"</span><span class="o">));</span>
<span class="n">wordCounts</span><span class="o">.</span><span class="na">toStream</span><span class="o">().</span><span class="na">to</span><span class="o">(</span><span class="n">outputTopic</span><span class="o">,</span> <span class="nc">Produced</span><span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">(),</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">Long</span><span class="o">()));</span>
<span class="nc">Topology</span> <span class="n">topology</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="k">try</span> <span class="o">(</span><span class="nc">TopologyTestDriver</span> <span class="n">testDriver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TopologyTestDriver</span><span class="o">(</span><span class="n">topology</span><span class="o">,</span> <span class="n">topologyProps</span><span class="o">))</span> <span class="o">{</span>    <span class="o">(</span><span class="mi">1</span><span class="o">)</span>
    <span class="nc">TestInputTopic</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">input</span> <span class="o">=</span> <span class="n">testDriver</span><span class="o">.</span><span class="na">createInputTopic</span><span class="o">(</span><span class="n">inputTopic</span><span class="o">,</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">().</span><span class="na">serializer</span><span class="o">(),</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">().</span><span class="na">serializer</span><span class="o">());</span>    <span class="o">(</span><span class="mi">2</span><span class="o">)</span>
    <span class="nc">TestOutputTopic</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">testDriver</span><span class="o">.</span><span class="na">createOutputTopic</span><span class="o">(</span><span class="n">outputTopic</span><span class="o">,</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">().</span><span class="na">deserializer</span><span class="o">(),</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">Long</span><span class="o">().</span><span class="na">deserializer</span><span class="o">());</span>
    <span class="n">input</span><span class="o">.</span><span class="na">pipeInput</span><span class="o">(</span><span class="s">"record-001"</span><span class="o">,</span> <span class="s">"word-1"</span><span class="o">);</span>    <span class="o">(</span><span class="mi">3</span><span class="o">)</span>
    <span class="n">input</span><span class="o">.</span><span class="na">pipeInput</span><span class="o">(</span><span class="s">"record-002"</span><span class="o">,</span> <span class="s">"word-2"</span><span class="o">);</span>
    <span class="n">input</span><span class="o">.</span><span class="na">pipeInput</span><span class="o">(</span><span class="s">"record-003"</span><span class="o">,</span> <span class="s">"word-1"</span><span class="o">);</span>
    <span class="nc">TestRecord</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">outputRecord</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="na">readRecord</span><span class="o">();</span>    <span class="o">(</span><span class="mi">4</span><span class="o">)</span>
    <span class="o">[...]</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Como podemos ver o mock do Stream é criado em <strong>(1)</strong>, depois devemos definir quais tópicos estão envolvidos no Stream <strong>(2)</strong>, enviamos os dados <strong>(3)</strong> e por fim consumimos as saídas do stream <strong>(4)</strong>. Existe uma série de vantagens ao se usar o <code class="language-plaintext highlighter-rouge">TopologyTestDriver</code> e a principal delas é que podemos controlar o avanço do tempo usando <a href="https://kafka.apache.org/34/javadoc/org/apache/kafka/streams/TopologyTestDriver.html#advanceWallClockTime(java.time.Duration)">testDriver.advanceWallClockTime(Duration.ofMinutes(60))</a>. Sem essa funcionalidade se torna impossível fazermos testes de streams que efetuam agregação no tempo.</p>

<p>Usando esse trecho de código é possível injetar e consultar dados no stream e através da biblioteca de assertions do <a href="https://junit.org/junit5/docs/5.8.2/api/org.junit.jupiter.api/org/junit/jupiter/api/Assertions.html">JUnit 5</a> ou do <a href="https://www.javadoc.io/doc/org.assertj/assertj-core/latest/org/assertj/core/api/Assertions.html">AssertJ</a> podemos criar testes unitários consistentes.</p>

<h1 id="2-como-testar-um-kafka-stream-usando-schema-registry">2. Como testar um Kafka Stream usando Schema Registry</h1>

<p>Quando temos um ambiente de microsserviços um pouco mais complexos, precisamos garantir a evolução dos Schemas das mensagens no Kafka. Existe <a href="https://www.sciencedirect.com/science/article/pii/S0164121221000674#b26">alguma literatura</a> sobre o assunto mas temos apenas alguns produtos no mercado. Os mais comuns são o <a href="https://docs.confluent.io/platform/current/schema-registry/index.html">Schema Registry da Confluent</a> e o <a href="https://www.apicur.io/registry/">Apicurio registry</a>, que segundo a documentação é compatível com o produto da Confluent.</p>

<p>Um Schema Registry vai funcionar como registro de todos os schemas que são usados tanto para se produzir quanto consumir mensagens. Quando um producer vai enviar uma mensagem, ele irá gerá um Schema, que pode ser JSON, AVRO ou Protobuf, depois irá enviar para o registry afim de se garantir que ele já está registrado. Na mensagem enviada os primeiros bytes são reservados ao armazenamento do identificado do Schema. Sendo bem simplista, o schema registry é um CRUD de schema que associa cada tópico a um schema e suas versões. Se eu enviar uma mensagem com um schema diferente, ela será adicionada ao tópico como uma nova versão e eu posso consultar todas as versões existente, assim como alterar a validação de compatibilidade dos schemas.</p>

<p>A grande dificuldade de se testar o Schema Registry é que o cliente é implementado dentro do Serializar/Deserializer do Apache Kafka. Como vimos na primeira parte, os serializers podem ser alterados pois as propriedades usadas para criar o <code class="language-plaintext highlighter-rouge">TopologyTestDriver</code> são diferentes das usadas no <code class="language-plaintext highlighter-rouge">KafkaStreams</code>. Mas algumas vezes não é possível fazer essa diferenciação, pois aquele é o serializer padrão e em alguns casos o serializer é definido pela topologia.</p>

<p>A documentação da Confluent não ajuda muito quando falamos de testes, essa é a maior insatisfação ao se usar qualquer produtos deles, mas descobrimos olhando o <a href="https://github.com/confluentinc/schema-registry/blob/master/avro-serializer/src/main/java/io/confluent/kafka/serializers/AbstractKafkaAvroSerDeConfig.java#L41">código fonte</a> que existe uma maneira de se fazer o teste. Depois quem encontramos isso foi possível ver que essa solução é bem conhecida, mas não há menções dela na documentação.</p>

<p>No trecho de código abaixo conseguimos criar um mock do cliente do Schema Registry, mesmo usando o <a href="https://kafka.apache.org/34/javadoc/org/apache/kafka/common/serialization/Serde.html"><code class="language-plaintext highlighter-rouge">Serde</code></a> padrão para AVRO e foi possível registrar os schemas desejados. Repare que os nomes do tópicos são <code class="language-plaintext highlighter-rouge">input</code>, <code class="language-plaintext highlighter-rouge">join</code> e <code class="language-plaintext highlighter-rouge">output</code>, mas internamente o Schema Registry adiciona os sufixos <code class="language-plaintext highlighter-rouge">-value</code> para o schema da mensagem e <code class="language-plaintext highlighter-rouge">-key</code> para a chave (<em>nós usamos String da massa</em>). Cada schema desejado deve ser configurado se usando a classe <code class="language-plaintext highlighter-rouge">MockSchemaRegistry</code> que criará um cliente local sem usar nenhum servidor web.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[...]</span>

<span class="n">topologyProps</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">StreamsConfig</span><span class="o">.</span><span class="na">DEFAULT_VALUE_SERDE_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">GenericAvroSerde</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
<span class="n">topologyProps</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">AbstractKafkaSchemaSerDeConfig</span><span class="o">.</span><span class="na">SCHEMA_REGISTRY_URL_CONFIG</span><span class="o">,</span> <span class="s">"mock://dummy1"</span><span class="o">);</span>

<span class="o">[...]</span>

<span class="nc">SchemaRegistryClient</span> <span class="n">srClient</span> <span class="o">=</span> <span class="nc">MockSchemaRegistry</span><span class="o">.</span><span class="na">getClientForScope</span><span class="o">(</span><span class="s">"dummy1"</span><span class="o">);</span>
<span class="n">srClient</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="s">"input-value"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AvroSchema</span><span class="o">(</span><span class="n">inputSchema</span><span class="o">));</span>
<span class="n">srClient</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="s">"join-value"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AvroSchema</span><span class="o">(</span><span class="n">inputSchema</span><span class="o">));</span>
<span class="n">srClient</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="s">"output-value"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AvroSchema</span><span class="o">(</span><span class="n">joinedSchema</span><span class="o">));</span>

<span class="o">[...]</span>

<span class="nc">MockSchemaRegistry</span><span class="o">.</span><span class="na">dropScope</span><span class="o">(</span><span class="s">"dummy1"</span><span class="o">);</span>
</code></pre></div></div>

<h2 id="conclusão">Conclusão</h2>

<p>Apesar do Stream do Apache Kafka parecer muito limitado para testes, é possível construir boas suites se separarmos a Topologia. Todo código deve ser testado de forma rápida e eficiente, por isso eu sempre recomendo a criação de testes unitários para que tenhamos uma resposta rápida.</p>

<p>O Schema Registry também permite o mock apesar de não ter uma documentação de fácil acesso sobre o assunto.</p>

                </article>
                
                <div style="text-align: center;margin: 10px auto;max-width: 50%;">
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
                        <img alt="Licença Creative Commons" style="border-width:0"
                            src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
                    </a>
                    <br />
                    Este obra está licenciado com uma Licença
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
                        Creative Commons Atribuição-NãoComercial-CompartilhaIgual 4.0 Internacional
                    </a>.
                </div>
                
                <div class="article-footer">
                    
                    <div class="published">
                        <div>Escrito em 27/janeiro/2023</div>
                    </div>
                    
                    
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
        
        
         
 
     
        
        
         
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
        
        
         
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
        
        
         
 
     
        
        
         
 
     
        
        
         
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
        
        
         


    
<div class="related-posts">
    <h2>Posts relacionados</h2>
     
        
         
            
    <a href="/posts/entendendo-o-kafka">
                
                    Entendendo o Kafka — Uma Introdução à Plataforma de Eventos
                
    </a>
                
                 
     
        
         
            
    <a href="/posts/ordenacao-no-kafka">
                
                    Ordenação no Kafka
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
            
    <a href="/posts/jakarta-ee-e-microprofile-io">
                
                    Especificações Jakarta EE & Microprofile.io: Jakarta EE e Microprofile.io
                
    </a>
                
                 
     
        
         
             
         
             
         
            
    <a href="/posts/escolhendo-uma-implementacao-jakarta-ee-e-microprofile-io">
                
                    Especificações Jakarta EE & Microprofile.io: Escolhendo uma implementação Jakarta EE & Microprofile.io
                
    </a>
                
                 
     
        
         
            
    <a href="/posts/o-que-e-o-apache-kafka">
                
                    Entendendo o Kafka: O que é o Apache Kafka
                
    </a>
                
                 
     
        
         
            
    <a href="/posts/rodando-o-apache-kafka-localmente">
                
                    Entendendo o Kafka: Rodando o Apache Kafka localmente
                
    </a>
                
                 
     
        
         
            
    <a href="/posts/enviando-mensagens">
                
                    Entendendo o Kafka: Enviando Mensagens
                
    </a>
                
                 
     
        
         
            
    <a href="/posts/recebendo-mensagens">
                
                    Entendendo o Kafka: Recebendo Mensagens
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
            
    <a href="/posts/como-criar-uma-linguagem-usando-antlr4-e-java">
                
                    Como criar uma linguagem usando ANTLR4 e Java
                
    </a>
                
                 
     
        
         
             
         
             
         
            
    <a href="/posts/trabalhando-com-dinheiro">
                
                    Coisas que todo Sênior deve saber: Trabalhando com dinheiro!
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
            
    <a href="/posts/deixando-rastros-ou-como-usar-log">
                
                    Coisas que todo Sênior deve saber: Deixando rastros, ou como usar log
                
    </a>
                
                 
     
        
            

</div>
                    
                </div>
            </div>
        </div>
        </div>
    </main>
    <footer class="footer">
	<ul class="footer-links">
		<li>
			<a href="/pj-clt/">
				<button type="button" class="btn btn-dark">
					Calculadora PJxCLT
				</button>
			</a>
		</li>
		<li>
			<a href="https://www.youtube.com/@victor.osorio">
				<i class="fab fa-youtube fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>
			<a href="http://github.com/vepo"> 
				<i class="fab fa-github fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>
			<a href="http://www.linkedin.com/in/victorosorio">
				<i class="fab fa-linkedin-in fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>
			<a href="https://bsky.app/profile/vepo.dev">
				<i class="fab fa-bluesky fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>
			<a rel="me" href="https://mastodon.social/@vepo">
				<i class="fab fa-brands fa-mastodon fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>&nbsp;</li>
	</ul>
</footer>

</body>
