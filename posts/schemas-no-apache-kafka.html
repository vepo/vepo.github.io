<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" type="image/png" href="/icon.png" />
  <meta name="google-site-verification" content="xw_kgncLhv22qVjTIPi7adALZre8FIHY02-DGCuYuZ4" />

   <!-- SEO stuff -->
  
  <title>Schemas no Apache Kafka</title>
  <meta property="og:title" content="Schemas no Apache Kafka" />
  

  
  <meta name="description" content="Um dos grandes problemas com Apache Kafka é lidar com schema das mensagens. Nesse post vou levantar alguns problemas e algumas soluções." />
  <meta property="og:description" content="Um dos grandes problemas com Apache Kafka é lidar com schema das mensagens. Nesse post vou levantar alguns problemas e algumas soluções." />
  

  
  <meta name="keywords" content="Event-Driven Architecture, Apache Kafka">
  

  <link rel="canonical" href="https://blog.vepo.dev/posts/schemas-no-apache-kafka" />
  <meta property="og:url" content="https://blog.vepo.dev/posts/schemas-no-apache-kafka" />
  <meta property="og:site_name" content="Notas do dia a dia de um engenheiro de software" />

  
  <meta property="og:image" content="https://blog.vepo.dev/assets/images/mesa-trabalho-100-42.webp" />
  

  
  <!-- if it's an article -->
  <meta property="og:type" content="article" />
  
  <meta property="article:published_time" content="2022-05-04T18:59:00+00:00" />
  <meta property="article:modified_time" content="2022-05-04T18:59:00+00:00" />
  

  <meta content="https://www.linkedin.com/in/victorosorio/" property="article:author">

  
  
  

  
  
  <meta content="Event-Driven Architecture" property="article:tag">
  
  <meta content="Apache Kafka" property="article:tag">
  
  

  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "BlogPosting",
      "headline": "Schemas no Apache Kafka",
      "datePublished": "2022-05-04T18:59:00+00:00",
      
      "description": "Um dos grandes problemas com Apache Kafka é lidar com schema das mensagens. Nesse post vou levantar alguns problemas e algumas soluções.",
      
      
      "url": "https://blog.vepo.dev/posts/schemas-no-apache-kafka"
    }
  </script>

  

  <link rel="author" href="https://www.linkedin.com/in/victorosorio/" />
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
  <link href="https://db.onlinewebfonts.com/c/1e44faec07b8b81f60a3215d76bd0086?family=Irvin-Heading" rel="stylesheet">
  <link href="https://db.onlinewebfonts.com/c/68e94a17c3e618dbe0936fcbf25b26c6?family=TNY+Adobe+Caslon+Pro+Regular" rel="stylesheet"> 
  <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/assets/css/main.css" />
  <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/assets/css/syntax.css">
  <script src="/assets/js/jquery.min.js"></script>
  <script src="/assets/js/adjustments.js" async></script>
  <!--script src="https://stats.vepo.dev/load-stats.js" async></script-->
  <script src="https://kit.fontawesome.com/9b30a05807.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="/assets/js/pdf.js"></script>
  <script>
      window.MathJax = {
      tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
      };
  </script>
</head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YXWDKRN6ZR"></script>
<script async>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-YXWDKRN6ZR');
</script>


<body>
    <main class="container">
        <div class="row g-5">
            <div class="col-md-2">
                <div class="position-sticky" style="top: 2rem;">
                    <header class="site-header">
                        <h3 class="site-title"><a href="/">Victor Osório</a></h3>
                        <nav class="menu-list">
	
	<a href="/tags" class="menu-link">Tags</a>
	
	<a href="/series" class="menu-link">Séries</a>
	
	<a href="/palestras" class="menu-link">Palestras</a>
	
	<a href="/en" class="menu-link">English</a>
	
	<a href="/tutorial" class="menu-link">Tutoriais</a>
	
	<a href="/livros" class="menu-link">Livros</a>
	
	<a href="/about" class="menu-link">Sobre</a>
	
</nav>
                    </header>
                </div>
            </div>
            <div class="col-md-10 main-content">
                <div class="article cover-image">
                    
                    <img alt="Schemas no Apache Kafka" src="/assets/images/mesa-trabalho-100-42.webp" class="img-fluid" />
                    
                </div>
                <div class="title">
                    
                    <h1 class="serie-title">
                        Schemas no Apache Kafka
                    </h1>
                    
                </div>
                
                
                <div class="publish_date">
                    <strong>
                        <time datetime="2022-05-04T18:59:00+00:00">
                            04/maio/2022
                        </time>
                    </strong>
                </div>
                
                <div class="tag-container">
                    
                    <a class="label label-default event-driven-architecture" href="/tags/#event-driven-architecture">
                        <i class="fas fa-tags"></i>
                        Event-Driven Architecture
                    </a>
                    
                    <a class="label label-default apache-kafka" href="/tags/#apache-kafka">
                        <i class="fas fa-tags"></i>
                        Apache Kafka
                    </a>
                    
                </div>
                
                
                <hr>
                
                
                <article>
                    <p>Esse post é um resumo sobre Apache Kafka e Schemas.</p>

<h2 id="apache-kafka-e-schemas">Apache Kafka e Schemas</h2>

<p>Antes de começar a debater precisamos resolver um mito: <strong>Kafka não é um banco de dados</strong>. Apesar de ser usado como Fonte Única de Verdade (<a href="https://en.wikipedia.org/wiki/Single_source_of_truth"><em>Single Source of Truth</em></a>), mas muitas das funcionalidades dos bancos SQL (DBMS) ou mesmo dos bancos NoSQL não estarão presente. Martin Kleppman, autor do livro <em>Designing Data-Intensive Applications</em>, defende nessa apresentação de 2019 que podemos sim considerar o Kafka uma base de dados, mas isso vai depender da forma como ele é usado, não sendo a função principal da plataforma.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/BuE6JvQE_CY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<p>Todo bando de dados, mesmo os não relacionais, possuem alguma forma de gerenciamento de schemas para os dados do mesmo tipo lógico (tabelas, collections, tópicos, canais, ou qualquer dados que podem ser agrupados conjuntamente). Mas Apache Kafka é totalmente agnóstico em relação ao conteúdo das mensagens e das chaves também. Não conhecer o conteúdo das mensagens é o Trade-off necessário para que o throughput do broker seja maior, essa é uma desisão de design, pois funcionalidades como serialização e desserialização foram delegadas para os clientes (produtores, consumidores, streams e connectors). Ao broker cabe apenas receber e enviar mensagens binárias.</p>

<p>Talvez a afirmação que o Kafka é agnóstico em relação ao conteúdo da chave possa parecer estranha. Se considerarmos o Kafka como uma plataforma ele não é agnóstico, mas o Broker Kafka não conhece o conteúdo da chave, o tipo e nem o algoritmo usado para associar chave e partição. Mesmo a chave é usada pelo producer para decidir para qual partição a mensagem será enviada a mensagem e essa decisão pode ser alterada pela com o uso da configuração <a href="https://kafka.apache.org/documentation/#producerconfigs_partitioner.class"><code class="language-plaintext highlighter-rouge">partitioner.class</code></a>.</p>

<p>Então ao se implementar um produtor devemos definir quais classes farão a serialização das mensagens pois essa não é uma configuração para o qual existe um valor padrão. Os formatos mais comuns de serialização são JSON, AVRO e Protocol Buffers. O formato JSON, tão usado no protocolo HTTP, não é o formato recomendado irá demandar mais espaço em disco pois as mensagens não são compactadas. Já o AVRO ou o Protocol Buffers são otimizadas para reduzir o espaço em disco armazenando as mensagens em formato binário, mas cada um desses formatos terá suas peculiaridades que não discuteremos aqui.</p>

<p>Como o Kafka não lida com Schemas, é um padrão usar um serviço para registro de schemas. A solução mais conhecida é o Schema Registry da Confluent, ao usar o serializador compatível com o Schema Registry a cada nova mensagem é verificada se houve mudanças de schema e se elas são compatíveis com o já schema registrado. Esse padrão pode adicionar um pouco de latência, pois no melhor caso há uma verificação de Schema e no pior caso há o registro do schema em através de uma requisição HTTP. Mas usar um serviço de registro de schemas pode ser útil para alcança um baixo acoplamento entre times, pois o time que desenvolve um consumidor não precisa conversar com o time que desenvolve o produto. Outra vantagem é que as classes necessárias para implementar o objeto de negócio pode ser geradas automaticamente.</p>

<h2 id="evolução-de-schemas">Evolução de Schemas</h2>

<p>Mensagens armazenadas no Apache Kafka são imutáveis, mas os serviços que produzem e consomem mensagens não são imutáveis o que nos leva ao seguinte questionamento: <em>como lidar com a mudança de schema na evolução de um sistema?</em></p>

<p>O paper <a href="https://www.sciencedirect.com/science/article/pii/S0164121221000674#b26">An empirical characterization of event sourced systems and their schema evolution — Lessons from industry</a> vai apresentar cinco processos de evolução, mas como no Apache Kafka não é permitido se alterar o conteúdo das mensagens, apenas quatro são aplicavéis.</p>

<ol>
  <li>Eventos versionados: Todos os schemas devem ser declarados no código e cabe ao consumidor decidir qual schema usar.</li>
  <li>Schema fraco: o método de serialização permite que campos sejam adicionados e removidos sem prejuízo para a leitura, cabendo ao consumidor verificar se o valor que se deseja ler ainda existe.</li>
  <li>Up Casting: Ao receber um evento, o consumidor irá transformar o schema dele no mais recente. O consumidor deve conhecer todos os schemas e a função de transformação que atualizará cada schema na versão mais recente.</li>
  <li>Transformação In-Place: o schema de todos os eventos são alterados na Fonte Única de Verdade. Esse padrão é impossível de ser utilizado no Apache Kafka</li>
  <li>Copia-e-Transforma: um novo agrupamento é criado contendo mensagens usando o novo schema. O agrupamento anterior pode ser mantido.</li>
</ol>

<p>Para se evoluir um schema AVRO, deve-se manter o nome dos campos e dos records, pois eles são usados na serialização para se associar o respectivo campo ao seu valor. Já uma mensagem Protocol Buffer tem sempre associado um identificador para cada campo, podendo assim serem renomeados. Deve-se sempre manter em mente que ao se atualizar um produtor, todos os consumidores devem ser compatíveis com esse novo schema.</p>

<h2 id="compatibilidade-de-schemas">Compatibilidade de Schemas</h2>

<p>O Schema Registry da Confluente define alguns tipos de compatibilidade assim como uma biblioteca para checar se o schema atual é compatível com o anterior. Esse nível de compatibilidade pode se validar de uma alteração de Schema pode ser feita ou não.</p>

<div>
    <table>
        <thead>
            <tr>
                <th>Tipo de compatibilidade</th>
                <th>Alterações permitidas</th>
                <th>Nível de verificação</th>
                <th>Quem atualizar primeiro</th>
            </tr>
        </thead>
        <tbody>
            <tr>
            <td>Backward</td>
                <td>
                    <div>
                        <ul>
                            <li>Apagar campos</li>
                            <li>Adicionar campos opicionais</li>
                        </ul>
                    </div>
                </td>
                <td>Última versão</td>
                <td>Consumidores</td>
            </tr>
            <tr>
                <td>Backward Transitive</td>
                <td>
                    <div>
                        <ul>
                            <li>Apagar campos</li>
                            <li>Adicionar campos opicionais</li>
                        </ul>
                    </div>
                </td>
                <td>Todas as versões anteriores</td>
                <td>Consumidores</td>
            </tr>
            <tr>
                <td>Forward</td>
                <td>
                    <div>
                        <ul>
                            <li>Adicionar campos</li>
                            <li>Apagar campos opicionais</li>
                        </ul>
                    </div>
                </td>
                <td>Última versão</td>
                <td>Produtores</td>
            </tr>
            <tr>
                <td>Forward Transitive</td>
                <td>
                    <div>
                        <ul>
                            <li>Adicionar campos</li>
                            <li>Apagar campos opicionais</li>
                        </ul>
                    </div>
                </td>
                <td>Todas as versões anteriores</td>
                <td>Produtores</td>
            </tr>
            <tr>
                <td>Full</td>
                <td>
                    <div>
                        <ul>
                            <li>Adicionar campos opicionais</li>
                            <li>Apagar campos opcionais</li>
                        </ul>
                    </div>
                </td>
                <td>Última versão</td>
                <td>Qualquer</td>
            </tr>
            <tr>
                <td>Full Transitive</td>
                <td>
                    <div>
                        <ul>
                            <li>Adicionar campos opicionais</li>
                            <li>Apagar campos opcionais</li>
                        </ul>
                    </div>
                </td>
                <td>Todas as versões anteriores</td>
                <td>Qualquer</td>
            </tr>
            <tr>
                <td>None</td>
                <td>
                    <div>
                        <ul>
                            <li>Todas as alterações são aceitas</li>
                        </ul>
                    </div>
                </td>
                <td>Não é verificada compatibilidade</td>
                <td>Depende</td>
            </tr>
        </tbody>
    </table>
</div>

<p>De todas essas compatibilidades, somente a nenhuma (<em>None</em>) é preocupante, pois vai requerer que exista um plano de migração dos dados conforme já vimos.</p>

                </article>
                
                <div style="text-align: center;margin: 10px auto;max-width: 50%;">
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
                        <img alt="Licença Creative Commons" style="border-width:0"
                            src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
                    </a>
                    <br />
                    Este obra está licenciado com uma Licença
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
                        Creative Commons Atribuição-NãoComercial-CompartilhaIgual 4.0 Internacional
                    </a>.
                </div>
                
                <div class="article-footer">
                    
                    <div class="published">
                        <div>Escrito em 04/maio/2022</div>
                    </div>
                    
                    
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
        
        
         
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
        
        
         
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
        
        
         
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
        
        
         
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
        
        
         
 
     
         
     
        
        
         
 
     
         
     
        
        
         
 
     
         
     
        
        
         
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
         
     
 
     
         
     
        
        
         
 
     
         
     
        
        
         


    
<div class="related-posts">
    <h2>Posts relacionados</h2>
     
        
         
             
         
            
    <a href="/posts/entendendo-o-kafka">
                
                    Entendendo o Kafka — Uma Introdução à Plataforma de Eventos
                
    </a>
                
                 
     
        
         
             
         
            
    <a href="/posts/ordenacao-no-kafka">
                
                    Ordenação no Kafka
                
    </a>
                
                 
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
            
    <a href="/posts/o-que-e-o-apache-kafka">
                
                    Entendendo o Kafka: O que é o Apache Kafka
                
    </a>
                
                 
     
        
         
             
         
            
    <a href="/posts/rodando-o-apache-kafka-localmente">
                
                    Entendendo o Kafka: Rodando o Apache Kafka localmente
                
    </a>
                
                 
     
        
         
             
         
            
    <a href="/posts/enviando-mensagens">
                
                    Entendendo o Kafka: Enviando Mensagens
                
    </a>
                
                 
     
        
         
             
         
            
    <a href="/posts/recebendo-mensagens">
                
                    Entendendo o Kafka: Recebendo Mensagens
                
    </a>
                
                 
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
            
    <a href="/posts/anatomia-de-um-topico">
                
                    Entendendo o Kafka: Anatomia de um Tópico
                
    </a>
                
                 
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
            
    <a href="/posts/log-cleanup-no-kafka">
                
                    Entendendo o Kafka: Log Cleanup no Kafka
                
    </a>
                
                 
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
            
    <a href="/posts/event-driven-architecture">
                
                    Arquitetura Event-Driven
                
    </a>
                
                 
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
            
    <a href="/posts/mock-schema-registry">
                
                    Testes de Kafka Stream e Schema Registry
                
    </a>
                
                 
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
     
        
         
             
         
             
         
    

</div>
                    
                </div>
            </div>
        </div>
        </div>
    </main>
    <footer class="footer">
	<ul class="footer-links">
		<li>
			<a href="/pj-clt/">
				<button type="button" class="btn btn-dark">
					Calculadora PJxCLT
				</button>
			</a>
		</li>
		<li>
			<a href="https://www.youtube.com/@victor.osorio">
				<i class="fab fa-youtube fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>
			<a href="http://github.com/vepo"> 
				<i class="fab fa-github fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>
			<a href="http://www.linkedin.com/in/victorosorio">
				<i class="fab fa-linkedin-in fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>
			<a href="https://bsky.app/profile/vepo.dev">
				<i class="fab fa-bluesky fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>
			<a rel="me" href="https://mastodon.social/@vepo">
				<i class="fab fa-brands fa-mastodon fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>&nbsp;</li>
	</ul>
</footer>

</body>
