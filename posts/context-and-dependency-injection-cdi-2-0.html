<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" type="image/png" href="/icon.png" />
  <meta name="google-site-verification" content="xw_kgncLhv22qVjTIPi7adALZre8FIHY02-DGCuYuZ4" />

   <!-- SEO stuff -->
  
  <title>Especificações Jakarta EE & Microprofile.io: Contexts and Dependency Injection (CDI) 2.0</title>
  <meta property="og:title" content="Especificações Jakarta EE & Microprofile.io: Contexts and Dependency Injection (CDI) 2.0" />
  

  
  <meta name="description" content="Nesse post vou detalhar um pouco as funcionalidades do Java CDI e como podem ser usadas para melhorar seu código." />
  <meta property="og:description" content="Nesse post vou detalhar um pouco as funcionalidades do Java CDI e como podem ser usadas para melhorar seu código." />
  

  
  <meta name="keywords" content="Jakarta-EE, Java-EE, Java, Java CDI, CDI">
  

  <link rel="canonical" href="https://blog.vepo.dev/posts/context-and-dependency-injection-cdi-2-0" />
  <meta property="og:url" content="https://blog.vepo.dev/posts/context-and-dependency-injection-cdi-2-0" />
  <meta property="og:site_name" content="Notas do dia a dia de um engenheiro de software" />

  
  <meta property="og:image" content="https://blog.vepo.dev/assets/images/web.avif" />
  

  
  <!-- if it's an article -->
  <meta property="og:type" content="article" />
  
  <meta property="article:published_time" content="2021-03-26T17:00:00+00:00" />
  <meta property="article:modified_time" content="2021-03-26T17:00:00+00:00" />
  

  <meta content="https://www.linkedin.com/in/victorosorio/" property="article:author">

  
  
  

  
  
  <meta content="Jakarta-EE" property="article:tag">
  
  <meta content="Java-EE" property="article:tag">
  
  <meta content="Java" property="article:tag">
  
  <meta content="Java CDI" property="article:tag">
  
  <meta content="CDI" property="article:tag">
  
  

  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "BlogPosting",
      "headline": "Contexts and Dependency Injection (CDI) 2.0",
      "datePublished": "2021-03-26T17:00:00+00:00",
      
      "description": "Nesse post vou detalhar um pouco as funcionalidades do Java CDI e como podem ser usadas para melhorar seu código.",
      
      
      "sameAs" : [
        "https://dev.to/vepo/contexts-and-dependency-injection-cdi-2-0-1ae4"
      ],
      
      "url": "https://blog.vepo.dev/posts/context-and-dependency-injection-cdi-2-0"
    }
  </script>

  

  <link rel="author" href="https://www.linkedin.com/in/victorosorio/" />
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
  <link href="https://db.onlinewebfonts.com/c/1e44faec07b8b81f60a3215d76bd0086?family=Irvin-Heading" rel="stylesheet">
  <link href="https://db.onlinewebfonts.com/c/68e94a17c3e618dbe0936fcbf25b26c6?family=TNY+Adobe+Caslon+Pro+Regular" rel="stylesheet"> 
  <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/assets/css/main.css" />
  <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/assets/css/syntax.css">
  <script src="/assets/js/jquery.min.js"></script>
  <script src="/assets/js/adjustments.js" async></script>
  <!--script src="https://stats.vepo.dev/load-stats.js" async></script-->
  <script src="https://kit.fontawesome.com/9b30a05807.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="/assets/js/pdf.js"></script>
  <script>
      window.MathJax = {
      tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
      };
  </script>
</head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YXWDKRN6ZR"></script>
<script async>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-YXWDKRN6ZR');
</script>


<body>
    <main class="container">
        <div class="row g-5">
            <div class="col-md-2">
                <div class="position-sticky" style="top: 2rem;">
                    <header class="site-header">
                        <h3 class="site-title"><a href="/">Victor Osório</a></h3>
                        <nav class="menu-list">
	
	<a href="/tags" class="menu-link">Tags</a>
	
	<a href="/series" class="menu-link">Séries</a>
	
	<a href="/palestras" class="menu-link">Palestras</a>
	
	<a href="/en" class="menu-link">English</a>
	
	<a href="/tutorial" class="menu-link">Tutoriais</a>
	
	<a href="/livros" class="menu-link">Livros</a>
	
	<a href="/about" class="menu-link">Sobre</a>
	
</nav>
                    </header>
                </div>
            </div>
            <div class="col-md-10 main-content">
                <div class="article cover-image">
                    
                    <img alt="Contexts and Dependency Injection (CDI) 2.0" src="/assets/images/web.avif" class="img-fluid" />
                    
                </div>
                <div class="title">
                    
                    <h1 class="serie-title">
                        Especificações Jakarta EE & Microprofile.io
                    </h1>
                    <h2>
                        Contexts and Dependency Injection (CDI) 2.0
                    </h2>
                    
                </div>
                
                
                <div class="publish_date">
                    <strong>
                        <time datetime="2021-03-26T17:00:00+00:00">
                            26/março/2021
                        </time>
                    </strong>
                </div>
                
                <div class="tag-container">
                    
                    <a class="label label-default jakarta-ee" href="/tags/#jakarta-ee">
                        <i class="fas fa-tags"></i>
                        Jakarta-EE
                    </a>
                    
                    <a class="label label-default java-ee" href="/tags/#java-ee">
                        <i class="fas fa-tags"></i>
                        Java-EE
                    </a>
                    
                    <a class="label label-default java" href="/tags/#java">
                        <i class="fas fa-tags"></i>
                        Java
                    </a>
                    
                    <a class="label label-default java-cdi" href="/tags/#java-cdi">
                        <i class="fas fa-tags"></i>
                        Java CDI
                    </a>
                    
                    <a class="label label-default cdi" href="/tags/#cdi">
                        <i class="fas fa-tags"></i>
                        CDI
                    </a>
                    
                </div>
                
                
                <div>
                    Post originalmente publicado em <a href="https://dev.to/vepo/contexts-and-dependency-injection-cdi-2-0-1ae4">dev.to</a>.
                </div>
                
                <hr>
                
                





<div class="series">
    <div class="serie-contents">
        
        <h2>
            Especificações Jakarta EE & Microprofile.io<br/>
            <span class="description">(série de 3 partes)</span>
        </h2>
        
            
            <a href="/posts/jakarta-ee-e-microprofile-io">
                <div class="serie-article">Jakarta EE e Microprofile.io</div>
            </a>
            
        
            
            <a href="/posts/escolhendo-uma-implementacao-jakarta-ee-e-microprofile-io">
                <div class="serie-article">Escolhendo uma implementação Jakarta EE & Microprofile.io</div>
            </a>
            
        
            
            <div class="serie-article selected">Contexts and Dependency Injection (CDI) 2.0</div>
            
        
    </div>
</div>

                <article>
                    <p>CDI é a especificação mais básica do Jakarta EE e do Microprofile.io. Está na base de todas as outras e é utilizada por quase todas outras.</p>

<h2 id="o-meu-projeto-tem-cdi">O meu projeto tem CDI?</h2>

<p>Pra quem não conhece a especificação, pode ficar perdido. Era o que acontecia comigo. Você se depara com classes assim:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ApplicationScoped</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="kt">long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">userRepository</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">userId</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>E você se pergunta:</p>
<ul>
  <li><em>Tá, quem instancia essa classe?</em></li>
  <li><em>Como eu configuro <code class="language-plaintext highlighter-rouge">userRepository</code>?</em></li>
  <li><em>Como eu uso UserService?</em></li>
</ul>

<p>Se você não sabe responder essas perguntas, vamos lá….</p>

<h2 id="o-que-é-cdi">O que é CDI?</h2>

<p>A primeira versão de <em>Contexts and Dependency Injection for Java EE (CDI)</em> entrou no Java EE 6, e rapidamente se tornou uma das mais importantes e populares especificações da plataforma.</p>

<p>CDI define um conjunto de especificações que permite uma boa modularização do código do projeto:</p>

<ul>
  <li>Um ciclo de vida bem definidos para objetos e seu respectivo contextos. Também um conjunto extensível de contextos.</li>
  <li>Um sofisticado e mecanismo de injeção com tipagem forte sem configuração</li>
  <li>Suporte a construção de Componentes totalmente desacoplados</li>
  <li>Integração com JSF</li>
  <li>Decorators</li>
  <li>Interceptors</li>
  <li>Programação Event-Driven</li>
</ul>

<h3 id="escopo">Escopo</h3>

<p>O Java CDI define uma API básica para que frameworks de dependency injection possam criar, gerenciar e remover TypeSafe beans automaticamente dentro de containers Jakarta EE.</p>

<h3 id="porque-usar-cdi">Porque usar CDI</h3>

<p>CDI permite desacoplar totalmente o ciclo de vida de um objeto e seu uso. O desenvolvedor que usa uma classe não precisa saber como instanciar e nem como remover estes objetos. Permitindo assim:</p>

<ul>
  <li>Velocidade de Desenvolvimento</li>
  <li>Padronização do código</li>
  <li>Baixo acoplamento e alta coesão</li>
  <li>Foco na Lógica de Negócio</li>
</ul>

<h2 id="definições">Definições</h2>

<p>Para entender o que é o Java CDI é preciso compreender algumas definições antes.</p>

<h3 id="inversão-de-controle">Inversão de Controle</h3>

<p>Inversão de controle, <a href="https://martinfowler.com/bliki/InversionOfControl.html">segundo Martin Fowler</a>, é o que difere Frameworks de Bibliotecas. Ao usar uma biblioteca, deve ser explicitamente carregado no código as dependências de cada componente. Ao se usar um componene, as dependências de cada componente são carregadas pelo mesmo, sendo <strong>apenas</strong> responsabilidade do desenvolvedor usar o compomenente.</p>

<h3 id="programação-por-aspectos">Programação por Aspectos</h3>

<p>Quando se fala de AOP, há inúmeros conceitos, mas podemos ser bem simples em definir. Ao se escrever um código, o desenvolvedor pode separar vários níveis de tipos de códigos. Aqueles que definem o que está sendo feito, requisitos funcionais e requisitos básicos.</p>

<p>Vamos imaginar que você está desenvolvendo um endpoint para tratar de reservar um item em um carrinho de compra. Existe o código de reservar o item (1), existe o código que implementará o protocolo HTTP (2) e existe outras funcionalidades que darão segurança ao serviço (3). <strong>1</strong> é o código principal, <strong>2</strong> e <strong>3</strong> são apenas aspectos desse código e podem ser definidos ortogonalmente ao código. Como fazer isso? Vamos ver a seguir: Decorators ou Interceptors!</p>

<h2 id="criando-um-projeto-cdi">Criando um Projeto CDI</h2>

<p>Para criar um projeto CDI, basta adicionar o arquivo <code class="language-plaintext highlighter-rouge">src/main/resources/META-INF/beans.xml</code> a um projeto Maven.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://xmlns.jcp.org/xml/ns/javaee"</span> 
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> 
    <span class="na">xsi:schemaLocation=</span><span class="s">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/beans_1_1.xsd"</span> 
    <span class="na">bean-discovery-mode=</span><span class="s">"all"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div>

<p>Isso fará com que automaticamente TODOS os objetos definidos nesse projeto sejam considerados um bean e carregados aotumaticamente.</p>

<h2 id="instanciando-objetos-cdi">Instanciando Objetos CDI</h2>

<p>Objetos CDI são automaticamente carregados. Para isso é preciso que sigam os seguintes requisitos:</p>
<ul>
  <li>Não seja uma Inner Class</li>
  <li>Não seja uma Classe abstrata e não possui a Annotation @Decorator</li>
  <li>Não implementa a interface javax.enterprise.inject.spi.Extension</li>
  <li>Não possui a Annotation @Vetoed e nem está em um pacote com @Vetoed</li>
  <li>Tem um construtor apropriado
    <ul>
      <li>Um construtor sem parâmetros</li>
      <li><del>Um construtor com parâmetros com @Inject</del>
        <ul>
          <li>Está na especificação, mas não funciona! 🤔 🤦‍♂️</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="escopo-e-contexto">Escopo e Contexto</h3>

<p>Cada objeto deve definir qual o seu escopo. Isso impactará diretamente quando cada objeto será criado e removido. Ou se existirá apenas um ou várias ao mesmo tempo. Os escopos pre definidos pelo Java CDI são:</p>

<table>
  <thead>
    <tr>
      <th>Scope</th>
      <th>Annotation</th>
      <th>Duration</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Request</td>
      <td>@RequestScoped</td>
      <td>A user’s interaction with a web application in a single HTTP request.</td>
    </tr>
    <tr>
      <td>Session</td>
      <td>@SessionScoped</td>
      <td>A user’s interaction with a web application across multiple HTTP requests.</td>
    </tr>
    <tr>
      <td>Application</td>
      <td>@ApplicationScoped</td>
      <td>Shared state across all users’ interactions with a web application.</td>
    </tr>
    <tr>
      <td>Dependent</td>
      <td>@Dependent</td>
      <td>The default scope if none is specified; it means that an object exists to serve exactly one client (bean) and has the same lifecycle as that client (bean).</td>
    </tr>
    <tr>
      <td>Conversation</td>
      <td>@ConversationScoped</td>
      <td>A user’s interaction with a JavaServer Faces application, within explicit developer-controlled boundaries that extend the scope across multiple invocations of the JavaServer Faces lifecycle. All long-running conversations are scoped to a particular HTTP servlet session and may not cross session boundaries.</td>
    </tr>
  </tbody>
</table>

<p>Nesse tutorial, para facilitar os exemplos, vamos tratar apenas dos escopos Request e Application.</p>

<p>O <code class="language-plaintext highlighter-rouge">SessionScoped</code> é usado em projetos JSF onde há uma sessão de usuário ativa.</p>

<h3 id="diretamente">Diretamente</h3>

<p>Qualquer objeto que cumpra todos os requisitos acima. Como você pode ver em <a href="https://github.com/vepo/cdi-tutorial/blob/master/src/main/java/io/vepo/access/user/UserRepository.java">UserRepository.java</a>, o campo <code class="language-plaintext highlighter-rouge">collection</code> é inserido e inicializado apenas usando a annotation <code class="language-plaintext highlighter-rouge">@Inject</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Dependent</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRepository</span> <span class="o">{</span>
    <span class="o">[...]</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="nc">MongoCollection</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">collection</span><span class="o">;</span>

    <span class="o">[...]</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="ciclo-de-vida">Ciclo de Vida</h3>

<p>Juntamente com a instanciação, o Java CDI permite controlar o ciclo de vida de um objeto. Se for preciso limpar o objeto ao mesmo ser removido ou instanciar objetos não CDI, como faz?</p>

<p>Para isso podemos usar as annotations <code class="language-plaintext highlighter-rouge">@PostConstruct</code> e <code class="language-plaintext highlighter-rouge">@PreDestroy</code>.</p>

<p>Veja o exemplo de <a href="https://github.com/vepo/cdi-tutorial/blob/master/src/main/java/io/vepo/access/infra/MongoClientFactory.java">MongoClientFactory</a>. Observe que ao ser inicializado, é chamado automaticamente o metodo <code class="language-plaintext highlighter-rouge">buildMongoClient</code> e ao ser removido o metodo <code class="language-plaintext highlighter-rouge">cleanup</code>.</p>

<h2 id="factory">Factory</h2>

<p><em>E se a classe não for definida no meu código, como faço?</em></p>

<p>Para isso, podemos inicializar ela através de uma <a href="https://refactoring.guru/pt-br/design-patterns/factory-method/java/example"><strong>Factory</strong></a>.</p>

<p>Em CDI ela é definida pela annotation <code class="language-plaintext highlighter-rouge">@Produces</code>.</p>

<p>Veja o caso de <code class="language-plaintext highlighter-rouge">MongoClientFactory</code>, a classe é usada pelo CDI para instanciar qualquer instancia de <a href="https://github.com/vepo/cdi-tutorial/blob/master/src/main/java/io/vepo/access/infra/MongoClientFactory.java#L84">MongoCollection</a>.</p>

<p>Se a classe MongoCollection fosse Closeable, eu precisaria também implementaro um metodo pra isso, logo:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">disposeMongoCollection</span><span class="o">(</span><span class="nd">@Dispose</span> <span class="nc">MongoCollection</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">collection</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// close if possible</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="usando-qualifiers">Usando Qualifiers</h2>

<p>E se agora eu precisar escolher entre implementações distintas? Como faço?</p>

<p>O CDI também tem a solução para isso com baixo acoplamento. Primeiro você vai ter que definir uma interface ou uma class abstrata. Em nosso exemplos vamos criar o <code class="language-plaintext highlighter-rouge">HelloService</code> com a unica intenção de dizer <em>Oi</em>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HelloService</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">sayHello</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Nessa interface não é necessário praticamente nada.</p>

<p>Depois é necessário definir quais serão os qualifiers usados:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Qualifier</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="no">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="no">TYPE</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">FIELD</span> <span class="o">})</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">PtBr</span> <span class="o">{</span>

<span class="o">}</span>
</code></pre></div></div>

<p>O proximo passo é definir as implementações, segue abaixo as duas que fiz:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ApplicationScoped</span>
<span class="nd">@PtBr</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloServicePtBr</span> <span class="kd">implements</span> <span class="nc">HelloService</span> <span class="o">{</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">sayHello</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Olá! %s"</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>E</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ApplicationScoped</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloServiceUs</span> <span class="kd">implements</span> <span class="nc">HelloService</span> <span class="o">{</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">sayHello</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Hello! %s"</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Nos dois casos acima, você pode observar que <code class="language-plaintext highlighter-rouge">HelloServiceUs</code> é a implementação padrão, enquanto <code class="language-plaintext highlighter-rouge">HelloServicePtBr</code> seria uma alternativa. Assim podemos usar:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SayHelloEndpoing</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="nc">HelloService</span> <span class="n">helloService</span><span class="o">;</span>

    <span class="c1">// something</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Para usar a implementação padrão, e apenas adicionando <code class="language-plaintext highlighter-rouge">@PtBr</code> podemos alterar a implementação.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SayHelloEndpoing</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="nd">@PtBr</span>
    <span class="kd">private</span> <span class="nc">HelloService</span> <span class="n">helloService</span><span class="o">;</span>

    <span class="c1">// something</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Assim é possível trocar a implementação de um componente com minimas alterações nas classes.</p>

<h2 id="interceptando">Interceptando</h2>

<p>Uma última feature do CDI é a possibilidade de se interceptar. Essa é a implementação do que podemos chamar de AOP.</p>

<p>Vamos deixar claro, qual a intenção de se usar um interceptador? Remover do código funcionalidades que não fazem parte da intenção direta do código. Por exemplo: Uma criação de usuário, exitem as regras de negócio e transações, transações são elegíveis para um interceptador, enquantoas regras de negócio DEVEM estar expressas no código.</p>

<p>Como fazer uma interceptação?</p>

<ol>
  <li>Sua classe a ser interceptada deve ser provida pelo CDI</li>
  <li>Uma <code class="language-plaintext highlighter-rouge">Annotation</code>, usando <code class="language-plaintext highlighter-rouge">@Inherited</code> e <code class="language-plaintext highlighter-rouge">@InterceptorBinding</code>, para marcar o metodo/classe</li>
  <li>Sua classe a ser interceptada deve ter algum qualifier associado (a ela ou ao método)</li>
  <li>Deve ser declarado um interceptador tanto na classe como no <code class="language-plaintext highlighter-rouge">beans.xml</code>.</li>
</ol>

<p>Vamos supor que em algumas classes eu desejo gerar estatisticas, então observe a implementação abaixo:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Measured</span>
<span class="nd">@Interceptor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StatisticInterceptor</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">StatisticInterceptor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@AroundInvoke</span>
	<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">calculateExecutionTime</span><span class="o">(</span><span class="nc">InvocationContext</span> <span class="n">invocationContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="nc">Object</span> <span class="n">returnedValue</span> <span class="o">=</span> <span class="n">invocationContext</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">endTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"The execution of {}.{} took {}ms"</span><span class="o">,</span> <span class="n">invocationContext</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span>
        <span class="n">invocationContext</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">returnedValue</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Observe a execução! Sucesso! 😀</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2020-05-27 13:37:16,263 INFO  [i.v.a.i.s.StatisticInterceptor] (default task-1) The execution of findByUsernameAndPassword.io.vepo.access.user.UserRepository took 6ms
2020-05-27 13:37:16,333 INFO  [i.v.a.i.s.StatisticInterceptor] (default task-1) The execution of login.io.vepo.access.user.UserEndpoint took 113ms
2020-05-27 13:37:35,087 INFO  [i.v.a.i.s.StatisticInterceptor] (default task-1) The execution of findByUsernameAndPassword.io.vepo.access.user.UserRepository took 2ms
2020-05-27 13:37:35,088 INFO  [i.v.a.i.s.StatisticInterceptor] (default task-1) The execution of login.io.vepo.access.user.UserEndpoint took 4ms
2020-05-27 13:37:40,430 INFO  [i.v.a.i.s.StatisticInterceptor] (default task-1) The execution of findByUsernameAndPassword.io.vepo.access.user.UserRepository took 2ms
2020-05-27 13:37:40,431 INFO  [i.v.a.i.s.StatisticInterceptor] (default task-1) The execution of login.io.vepo.access.user.UserEndpoint took 3ms
</code></pre></div></div>

<h2 id="events-e-observers">Events e Observers</h2>

<p>Uma última feature para usar do CDI são os eventos. O CDI habilita a comunicação asincrona e desacoplada dentro de uma mesma JVM.</p>

<p>Um evento pode ser qualquer objeto Java, de preferência um que representa o evento em si. No meu exemplo usei o <code class="language-plaintext highlighter-rouge">UserCreated</code> e <code class="language-plaintext highlighter-rouge">UserRemoved</code> para representar essas ações.</p>

<p>Como enviar? Basta instanciar um producer usando o <code class="language-plaintext highlighter-rouge">@Inject</code> e pronto:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Inject</span>
<span class="kd">private</span> <span class="nc">Event</span><span class="o">&lt;</span><span class="nc">UserCreated</span><span class="o">&gt;</span> <span class="n">createdEvent</span><span class="o">;</span>


<span class="nd">@POST</span>
<span class="nd">@Secured</span>
<span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
<span class="nd">@Consumes</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">User</span> <span class="nf">createUser</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Credentials: {}"</span><span class="o">,</span> <span class="n">credentials</span><span class="o">);</span>
	<span class="n">user</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">passwordEncrypter</span><span class="o">.</span><span class="na">encrypt</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()));</span>
	<span class="k">this</span><span class="o">.</span><span class="na">userRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
	<span class="k">this</span><span class="o">.</span><span class="na">createdEvent</span><span class="o">.</span><span class="na">fire</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserCreated</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">()));</span>
	<span class="k">return</span> <span class="n">user</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Para consumir esse evento, basta criar um método com <code class="language-plaintext highlighter-rouge">@Observes UserCreated userCreatedEvent</code>.</p>

<p>Vejamos a implementação:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ApplicationScoped</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SendEmailHandler</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">SendEmailHandler</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendUserCreatedEmail</span><span class="o">(</span><span class="nd">@Observes</span> <span class="nc">UserCreated</span> <span class="n">userCreatedEvent</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Sending User Created email! {}"</span><span class="o">,</span> <span class="n">userCreatedEvent</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendUserRemovedEmail</span><span class="o">(</span><span class="nd">@Observes</span> <span class="nc">UserRemoved</span> <span class="n">userRemovedEvent</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Sending User Removed email! {}"</span><span class="o">,</span> <span class="n">userRemovedEvent</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="conclusão">Conclusão</h2>

<p>CDI ajudar a controlar o ciclo de vida de um objeto e com isso diminui o acomplamento do seu código. Para quem não o conhece parece mágica, por isso é importante que seu equipe tenha total conhecimento da especificação antes de usa-lo.</p>

<p>Com os Intercepts do CDI é possível remover códigos que são ortogonais a lógica de negócio para que estes não atrapalhem o entendimento. Deixando a base de código clara e compartimentada.</p>

<p>Com os Eventos CDI é possível fazer com que seu código seja mais desacoplado e que novas funcionalidades não precisem alterar códigos antigos.</p>

<p>Bom uso!</p>

<p><em>Está faltando mais alguma coisa? Está achando confuso? Pergunte que eu posso melhorar!</em> 😀</p>

<p>Todos os exemplos desse post estão em:</p>

<div class="github-repo">
    <h2>
        <img class="logo" src="/assets/images/plugins/github-logo.png" alt="GitHub logo" loading="lazy" />
        <img class="user" src="https://avatars.githubusercontent.com/u/353569?v=4" loading="lazy" />
        <span class="url">
            <a href="https://github.com/vepo">
                vepo
            </a> 
            /
            <a href="https://github.com/vepo/cdi-tutorial">
                cdi-tutorial
            </a>
        </span>
    </h2>
</div>


                </article>
                
                <div style="text-align: center;margin: 10px auto;max-width: 50%;">
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
                        <img alt="Licença Creative Commons" style="border-width:0"
                            src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
                    </a>
                    <br />
                    Este obra está licenciado com uma Licença
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
                        Creative Commons Atribuição-NãoComercial-CompartilhaIgual 4.0 Internacional
                    </a>.
                </div>
                





<div class="series">
    <div class="serie-contents">
        
        <h2>
            Especificações Jakarta EE & Microprofile.io<br/>
            <span class="description">(série de 3 partes)</span>
        </h2>
        
            
            <a href="/posts/jakarta-ee-e-microprofile-io">
                <div class="serie-article">Jakarta EE e Microprofile.io</div>
            </a>
            
        
            
            <a href="/posts/escolhendo-uma-implementacao-jakarta-ee-e-microprofile-io">
                <div class="serie-article">Escolhendo uma implementação Jakarta EE & Microprofile.io</div>
            </a>
            
        
            
            <div class="serie-article selected">Contexts and Dependency Injection (CDI) 2.0</div>
            
        
    </div>
</div>

                <div class="article-footer">
                    
                    <div class="published">
                        <div>Escrito em 26/março/2021</div>
                    </div>
                    
                    
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
        
        
         
 
     
        
        
         
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
         
     
         
     
 
     
         
     
         
     
        
        
         


    
<div class="related-posts">
    <h2>Posts relacionados</h2>
     
        
         
             
         
             
         
            
    <a href="/posts/entendendo-o-kafka">
                
                    Entendendo o Kafka — Uma Introdução à Plataforma de Eventos
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
            
    <a href="/posts/jakarta-ee-e-microprofile-io">
                
                    Especificações Jakarta EE & Microprofile.io: Jakarta EE e Microprofile.io
                
    </a>
                
                 
     
        
         
            
    <a href="/posts/escolhendo-uma-implementacao-jakarta-ee-e-microprofile-io">
                
                    Especificações Jakarta EE & Microprofile.io: Escolhendo uma implementação Jakarta EE & Microprofile.io
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
            
    <a href="/posts/como-criar-uma-linguagem-usando-antlr4-e-java">
                
                    Como criar uma linguagem usando ANTLR4 e Java
                
    </a>
                
                 
     
        
         
             
         
             
         
            
    <a href="/posts/trabalhando-com-dinheiro">
                
                    Coisas que todo Sênior deve saber: Trabalhando com dinheiro!
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
            
    <a href="/posts/deixando-rastros-ou-como-usar-log">
                
                    Coisas que todo Sênior deve saber: Deixando rastros, ou como usar log
                
    </a>
                
                 
     
        
         
             
         
             
         
            
    <a href="/posts/anatomia-de-um-topico">
                
                    Entendendo o Kafka: Anatomia de um Tópico
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
            
    <a href="/posts/s-o-l-i-d-a-solida-base-para-orientacao-a-objeto">
                
                    Coisas que todo Sênior deve saber: S.O.L.I.D.: A sólida base para Orientação a Objeto
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
            
    <a href="/posts/devops-como-comecar">
                
                    Coisas que todo Sênior deve saber: DevOps! Como começar?
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
            
    <a href="/posts/testes-101-testando-aplicacoes-java">
                
                    Level Up: Testes 101 - Testando aplicações Java
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
             
         
             
         
     
        
         
             
         
             
         
            
    <a href="/posts/criando-um-stream-em-java">
                
                    Criando um Stream em Java
                
    </a>
                
                 
     
        
            

</div>
                    
                </div>
            </div>
        </div>
        </div>
    </main>
    <footer class="footer">
	<ul class="footer-links">
		<li>
			<a href="/pj-clt/">
				<button type="button" class="btn btn-dark">
					Calculadora PJxCLT
				</button>
			</a>
		</li>
		<li>
			<a href="https://www.youtube.com/@victor.osorio">
				<i class="fab fa-youtube fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>
			<a href="http://github.com/vepo"> 
				<i class="fab fa-github fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>
			<a href="http://www.linkedin.com/in/victorosorio">
				<i class="fab fa-linkedin-in fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>
			<a href="https://bsky.app/profile/vepo.dev">
				<i class="fab fa-bluesky fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>
			<a rel="me" href="https://mastodon.social/@vepo">
				<i class="fab fa-brands fa-mastodon fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>&nbsp;</li>
	</ul>
</footer>

</body>
