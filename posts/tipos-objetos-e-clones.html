<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" type="image/png" href="/icon.png" />
  <meta name="google-site-verification" content="xw_kgncLhv22qVjTIPi7adALZre8FIHY02-DGCuYuZ4" />

   <!-- SEO stuff -->
  
  <title>Tipos, Objetos e Clones</title>
  <meta property="og:title" content="Tipos, Objetos e Clones" />
  

  
  <meta name="description" content="Como Java lida com objetos e tipos primitivos? O que é Stack e Heap? O que seria passagem por valor e por referência? Existe isso em Java?" />
  <meta property="og:description" content="Como Java lida com objetos e tipos primitivos? O que é Stack e Heap? O que seria passagem por valor e por referência? Existe isso em Java?" />
  

  
  <meta name="keywords" content="Java, Memória, Clone">
  

  <link rel="canonical" href="https://blog.vepo.dev/posts/tipos-objetos-e-clones" />
  <meta property="og:url" content="https://blog.vepo.dev/posts/tipos-objetos-e-clones" />
  <meta property="og:site_name" content="Notas do dia a dia de um engenheiro de software" />

  
  <meta property="og:image" content="https://blog.vepo.dev/assets/images/pexels-negative-space-169573.jpg" />
  

  
  <!-- if it's an article -->
  <meta property="og:type" content="article" />
  
  <meta property="article:published_time" content="2021-05-22T15:13:00+00:00" />
  <meta property="article:modified_time" content="2021-05-22T15:13:00+00:00" />
  

  <meta content="https://www.linkedin.com/in/victorosorio/" property="article:author">

  
  
  

  
  
  <meta content="Java" property="article:tag">
  
  <meta content="Memória" property="article:tag">
  
  <meta content="Clone" property="article:tag">
  
  

  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "BlogPosting",
      "headline": "Tipos, Objetos e Clones",
      "datePublished": "2021-05-22T15:13:00+00:00",
      
      "description": "Como Java lida com objetos e tipos primitivos? O que é Stack e Heap? O que seria passagem por valor e por referência? Existe isso em Java?",
      
      
      "url": "https://blog.vepo.dev/posts/tipos-objetos-e-clones"
    }
  </script>

  

  <link rel="author" href="https://www.linkedin.com/in/victorosorio/" />
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
  <link href="https://db.onlinewebfonts.com/c/1e44faec07b8b81f60a3215d76bd0086?family=Irvin-Heading" rel="stylesheet">
  <link href="https://db.onlinewebfonts.com/c/68e94a17c3e618dbe0936fcbf25b26c6?family=TNY+Adobe+Caslon+Pro+Regular" rel="stylesheet"> 
  <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/assets/css/main.css" />
  <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/assets/css/syntax.css">
  <script src="/assets/js/jquery.min.js"></script>
  <script src="/assets/js/adjustments.js" async></script>
  <!--script src="https://stats.vepo.dev/load-stats.js" async></script-->
  <script src="https://kit.fontawesome.com/9b30a05807.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="/assets/js/pdf.js"></script>
  <script>
      window.MathJax = {
      tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
      };
  </script>
</head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YXWDKRN6ZR"></script>
<script async>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-YXWDKRN6ZR');
</script>


<body>
    <main class="container">
        <div class="row g-5">
            <div class="col-md-2">
                <div class="position-sticky" style="top: 2rem;">
                    <header class="site-header">
                        <h3 class="site-title"><a href="/">Victor Osório</a></h3>
                        <nav class="menu-list">
	
	<a href="/tags" class="menu-link">Tags</a>
	
	<a href="/series" class="menu-link">Séries</a>
	
	<a href="/palestras" class="menu-link">Palestras</a>
	
	<a href="/en" class="menu-link">English</a>
	
	<a href="/tutorial" class="menu-link">Tutoriais</a>
	
	<a href="/livros" class="menu-link">Livros</a>
	
	<a href="/about" class="menu-link">Sobre</a>
	
</nav>
                    </header>
                </div>
            </div>
            <div class="col-md-10 main-content">
                <div class="article cover-image">
                    
                    <img alt="Tipos, Objetos e Clones" src="/assets/images/pexels-negative-space-169573.jpg" class="img-fluid" />
                    
                </div>
                <div class="title">
                    
                    <h1 class="serie-title">
                        Tipos, Objetos e Clones
                    </h1>
                    
                </div>
                
                
                <div class="publish_date">
                    <strong>
                        <time datetime="2021-05-22T15:13:00+00:00">
                            22/maio/2021
                        </time>
                    </strong>
                </div>
                
                <div class="tag-container">
                    
                    <a class="label label-default java" href="/tags/#java">
                        <i class="fas fa-tags"></i>
                        Java
                    </a>
                    
                    <a class="label label-default memória" href="/tags/#memória">
                        <i class="fas fa-tags"></i>
                        Memória
                    </a>
                    
                    <a class="label label-default clone" href="/tags/#clone">
                        <i class="fas fa-tags"></i>
                        Clone
                    </a>
                    
                </div>
                
                
                <hr>
                
                
                <article>
                    <p>Existem algumas discussões em Java que não fazem sentido para quem não entende a forma como um programa lida com dados. Por exemplo, “valor” e “referência” são conceitos altamente relevantes em C/C++, mas não fazem nenhum sentido em Java. Nesse artigo, vou falar um pouco sobre copia por valor e referência e como clonar objetos em Java.</p>

<h2 id="tipos-primitivos-e-objetos">Tipos primitivos e Objetos</h2>

<p>Em Java objetos são basicamente a estrutura de dados mais comum. Por estrutura podemos entender que que é a forma como o dado é armazenado afim de facilitar o desenvolvimento. Assim temos sempre em um código tipos primitivos ou objetos.</p>

<p><em>Mas como lidamos com eles?</em></p>

<p>Para isso é preciso entender outros conceitos, a <em>Heap</em> e a <em>Stack</em>.</p>

<p>A <em>Heap</em> é o espaço de memória onde os objetos existem. Todo objeto Java é criado dentro da <em>Heap</em> e só irá existir uma única instância dele enquanto ele estiver sendo utilizado. Quando ele não for mais necessário, oo <em>Garbage Collector</em> irá remover ele da <em>Heap</em>, mas não iremos tratar disso aqui.</p>

<p>A <em>Stack</em> é onde a pilha de execução é definida. Esse não é só um conceito do Java, qualquer linguagem de programação tem uma pilha de execução, mas em Java a <em>Stack</em> tem uma significância especial, pois é a partir dela que o <em>Garbage Collector</em> irá defini que objeto da <em>Heap</em> pode ser eliminado. <em>Stack</em> significa pilha, e essa estrutura tem esse nome porque o seu comportamento é como uma pilha. Vamos supor que estamos executando um metodo <code class="language-plaintext highlighter-rouge">x</code>, e nesse método tem uma chamada para outro método <code class="language-plaintext highlighter-rouge">y</code>. Ao iniciar a execução de <code class="language-plaintext highlighter-rouge">y</code> um novo contexto é criado onde variáveis podem ser definidas e alteradas. Mas ao finalizar a execução de <code class="language-plaintext highlighter-rouge">y</code>, esse contexto é removido da pilha, retornando ao contexto anterior.</p>

<p><img src="/assets/images/java/heap.png" alt="Memória Heap" /></p>

<p>Assim, podemos dizer que tipos primitivos são definidos como uma posição de memória na <em>Stack</em>, enquanto objetos são definidos como referência a uma posição na <em>Heap</em>.</p>

<p>Foi possível compreender? Mas quais são as implicações disso?</p>

<h2 id="passagem-por-valor-e-por-referência">Passagem por valor e por referência</h2>

<p>Assim quando criamos contextos de execução novos, isso é, ou chamamos uma função ou executamos uma nova thread, alguns objetos podem ser compartilhados entre esses contextos. Vamos supor que estamos criando um usuário e temos alguns métodos que alteram o valor do usuário como <code class="language-plaintext highlighter-rouge">hashPassword</code> e <code class="language-plaintext highlighter-rouge">persist</code>. Assim podemos afirmar o código abaixo altera o valor do objeto <code class="language-plaintext highlighter-rouge">User</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="cm">/* id */</span> <span class="kc">null</span><span class="o">,</span> <span class="cm">/* username */</span> <span class="s">"vepo"</span><span class="o">,</span> <span class="cm">/* password */</span> <span class="s">"12345"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">);</span> <span class="c1">// User [id=null, username=vepo, password=12345]</span>
<span class="n">hashPassword</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>       <span class="c1">// user.password &lt;- "827ccb0eea8a706c4c34a16891f84e7b"</span>
<span class="n">persist</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>             <span class="c1">// user.id       &lt;- 1L</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">);</span> <span class="c1">// User [id=1L, username=vepo, password=827ccb0eea8a706c4c34a16891f84e7b]</span>
</code></pre></div></div>

<p>Nos dois métodos usados acima, podemos afirmar que o parâmetro User é usado como referência. Isso significa que qualquer alteração dentro da pilha de execução dos métodos irá alterar o valor fora do método.</p>

<p><em>Isso acontece com valores primitivos?</em> Não!</p>

<p>Quando falamos de valores primitivos em Java, nunca temos passagem por referência. Vamos supor que temos uma função que calcula um valor de <code class="language-plaintext highlighter-rouge">f(x)</code>, essa função altera o valor de <code class="language-plaintext highlighter-rouge">x</code>, logo ao chamar <code class="language-plaintext highlighter-rouge">f(x)</code>, o valor de x não será alterado no contexto que ele foi chamado.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>  <span class="c1">// 10</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">y</span><span class="o">);</span>  <span class="c1">// 50</span>
</code></pre></div></div>

<p>Porque isso acontece? Porque esse valor é diretamente definido na <em>Stack</em> e não há uma referência para ele.</p>

<p>Isso pode nos levar a dois questionamentos:</p>

<ol>
  <li>É possível fazer passagem por referência para tipos primitivos em Java?</li>
  <li>É possível fazer passagem por valor para objetos em Java?</li>
</ol>

<h2 id="primitivos-como-referência">Primitivos como Referência</h2>

<p>Para responder a primeira pergunta, podemos supor algumas soluções. A primeira seria usar os objetos que encapsulam tipos primitivos (por exemplo, para <code class="language-plaintext highlighter-rouge">int</code> temos <code class="language-plaintext highlighter-rouge">java.lang.Integer</code>), mas essa solução não é válida porque esses valores são imutáveis. Eles foram criados para que outras estruturas que dependem da classe <code class="language-plaintext highlighter-rouge">Oject</code> pudessem referenciar tipos primitivos.</p>

<p><em>Ora, o que é um objeto imutável?</em> Um objeto imutável é um objeto em que seu estado interno não pode ser alterado. Ele reside na <em>Heap</em>, mas seu estado interno é protegido.</p>

<p>A segunda solução seria usar classes que implementam <code class="language-plaintext highlighter-rouge">java.lang.ref.Reference</code>. Mas essas classes também não resolvem o problema, pois essas classes foram criadas para permitirem controle da referência em relação ao <em>Garbage Collector</em>, que não está no escopo da nossa discussão agora. Essas classes são bastante úteis se você deseja criar uma referência fraca, ou saber quando um objeto é elegível para o <em>Garbage Collector</em>.</p>

<p>A última solução, e única possível, é usar as classes do pacote <code class="language-plaintext highlighter-rouge">java.util.concurrent.atomic</code>. Essas classes são um referência única e <em>thread safe</em> para qualquer objeto ou tipo primitivo.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AtomicInteger</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>  <span class="c1">// 11</span>
<span class="n">inc</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>  <span class="c1">// 11</span>
</code></pre></div></div>

<p>Caso você não conheça essa classes, vale a pena fazer alguns exercícios com elas. Elas são bastante úteis para contextos onde é necessário uma referência do tipo <code class="language-plaintext highlighter-rouge">final</code> ou variáveis compartilhada entre várias threads. Como um exemplo da necessidade delas, quando precisavamos de algo similar no Java 4, era necessário criar um vetor com uma posição, assim era como ver código como:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span><span class="o">[]</span> <span class="n">resultado</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[]{</span> <span class="mi">0</span> <span class="o">};</span>  <span class="c1">// Não faça isso. Nunca! </span>
<span class="nc">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">ThreadImpl</span><span class="o">(</span><span class="n">resultado</span><span class="o">));</span>
<span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="n">t</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">resultado</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span> <span class="c1">// Era a única forma de obter um valor antes do AtomicInteger.</span>
</code></pre></div></div>

<h2 id="objetos-como-valor">Objetos como valor</h2>

<p>E para respondermos a segunda pergunta, não temos uma solução pronta na linguagem Java. Quando falamos de objetos sendo passado como valor, logos supomos que eles não são imutáveis. Mas ainda resta uma dúvida: em quais contextos precisamos passar um objeto como valor para um método? Aqui vou supor alguns contextos:</p>

<ol>
  <li>Operações ACID (<em><strong>A</strong>tomicity, <strong>C</strong>onsistency, <strong>I</strong>solation, <strong>D</strong>urability</em>)</li>
  <li>Contextos desconhecidos</li>
  <li>Verificação de conteúdo</li>
</ol>

<p>Quanto temos uma operação ACID, isso significa que o objeto em questão pode passar por uma série de modificações, mas elas só serão efetivadas caso a operação seja bem sucedida. Para isso é preciso manter o valor inicial do objeto, isso significa que toda operação será feita em uma cópia do objeto que depois poderá substituir o original. Essas operações são bem comuns em frameworks, mas normalmente não vamos implementações delas em código de negócio.</p>

<p>Já contextos desconhecidos, são contextos desconhecidos. 🤷‍♂️ Mas há uma forma de explicar… Vamos supor que temos uma aplicação que pode definir pontos de extensões, esses pontos vão ser definidos por usuários e podem ter várias definições. Se vamos ter código que podem ser carregados em tempo de execução que não temos o controle, as vezes pode ser bom garantir que os valores iniciais não são alterados. Principalmente quando esses pontos de extensão se comportam como ouvinte e não como devem alterar o valor inicial.</p>

<p>E por fim a verificação do conteúdo pode ser definida como um código que se deseja ver apenas o que foi alterado. Vamos supor que estamos implementando uma implementação do JPA, mas não desejamos alterar na base os valores não alterados durante a execução, assim o código abaixo não atualizaria todos os valores necessários, apenas aqueles que foram definitivamente alterados.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>                <span class="c1">// User[id=10L, username=vepo, name=Victor Osório, roles=[USER]]</span>
<span class="n">user</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"vepo"</span><span class="o">);</span>                               <span class="c1">// mesmo valor</span>
<span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"Victor Osório"</span><span class="o">);</span>                          <span class="c1">// mesmo valor</span>
<span class="n">user</span><span class="o">.</span><span class="na">setRoles</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="nc">Role</span><span class="o">.</span><span class="na">USER</span><span class="o">,</span> <span class="nc">Role</span><span class="o">.</span><span class="na">ADMIN</span><span class="o">));</span>    <span class="c1">// Adicionando ADMIN</span>
<span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>                                       <span class="c1">// INSERT INTO user_roles (user_id, role) values (10L, "ADMIN");</span>
</code></pre></div></div>

<p>Ora, mas eu ainda não falei em como fazer uma passagem de valor usando a JVM, certo? Porque isso não é possível! Para isso é preciso clonar o objeto, e isso podemos sim fazer pela JVM. Vamos aqui enumerar as formas de se fazer um clone:</p>

<ol>
  <li>Programaticamente</li>
  <li>Programaticamente usando <code class="language-plaintext highlighter-rouge">Object.clone</code></li>
  <li>Programaticamente usando <code class="language-plaintext highlighter-rouge">Object.clone</code> em classe <code class="language-plaintext highlighter-rouge">Cloneable</code></li>
  <li>Por reflexão</li>
</ol>

<p>O primeiro método é o mais declarativo e de forma nenhuma orientada a objeto. O código deve copiar o objeto campo a campo, e isso deve somente acontece quando não tempos o controle sobre a classe a ser clonado. Essa solução, em geral, é péssima, pois é altamente acoplada, isso significa que qualquer alteração da classe sendo clonada, precisa refletir na classe que a está clonando.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">User</span> <span class="n">clone</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">();</span>
<span class="n">clone</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">original</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
<span class="n">clone</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">original</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
<span class="n">clone</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">original</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
<span class="n">clone</span><span class="o">.</span><span class="na">getRoles</span><span class="o">(</span><span class="n">original</span><span class="o">.</span><span class="na">getRoles</span><span class="o">());</span>
</code></pre></div></div>

<p>Quando temos o controle sobre a classe a ser clonada, devemos sobrescrever o metodos <code class="language-plaintext highlighter-rouge">clone</code>. Assim, podemos simplesmente fazer conforme o segundo método listado acima. Dessa forma termos o total controle sobre o método de clonagem e ele é encapsulado dentro da própria classe a ser clonada.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="c1">// [...]</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">clone</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">User</span> <span class="n">clone</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">();</span>
        <span class="n">clone</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">id</span><span class="o">;</span>
        <span class="n">clone</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">username</span><span class="o">;</span>
        <span class="n">clone</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>
        <span class="n">clone</span><span class="o">.</span><span class="na">roles</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">roles</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">clone</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Uma outra maneira de se fazer um clone é usando a interface <code class="language-plaintext highlighter-rouge">Cloneable</code>. Apesar dessa interface não definir nenhum método, quando chamamos <code class="language-plaintext highlighter-rouge">super.clone()</code> para classes que a implementam, a JVM cria uma copia do objeto copiando campo a campo.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="nc">Cloneable</span> <span class="o">{</span>
    <span class="c1">// [...]</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">clone</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="nc">User</span><span class="o">)</span> <span class="kd">super</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">CloneNotSupportedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"A classe implementa Cloneable?"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Essa implementação também tem seus desafios, um deles é que essa copia que a JVM faz é simples. Vamos supor que no caso do nosso usuário, se alterarmos o valor de roles, que é uma lista, esse valor seria alterado nos dois objetos. Isso acontece porque os valores são apenas copiados e não clonados, assim qualquer valor que não seja imutável será compartilhado entre ambas as instâncias. No caso, para termos controle sobre esse comportamente, é preciso abdicar da interface <code class="language-plaintext highlighter-rouge">Cloneable</code> e usar a implementação anterior. Outra desvantagem é, que usando essa implementação, o construtor da classe não é chamado, assim a JVM apenas copia os campos da classe.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">User</span> <span class="n">original</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="mi">10L</span><span class="o">,</span> <span class="s">"vepo"</span><span class="o">,</span> <span class="s">"Victor Osório"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="nc">Roles</span><span class="o">.</span><span class="na">USER</span><span class="o">,</span> <span class="nc">Roles</span><span class="o">.</span><span class="na">ADMIN</span><span class="o">)));</span>
<span class="nc">User</span> <span class="n">clone</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
<span class="n">original</span><span class="o">.</span><span class="na">getRoles</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="nc">Roles</span><span class="o">.</span><span class="na">EDITOR</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">clone</span><span class="o">);</span> <span class="c1">// User[id=10L, username=vepo, name=Victor Osório, roles=[USER, ADMIN, EDITOR]]</span>
</code></pre></div></div>

<p>Por último, podemos fazer o clone de uma classe usando Reflexão. Reflexão, ou <em>Reflection</em>, é a forma de se inspecionar um objeto em tempo de execução, é a API do Java que dá a possibilidade de se criar a grande maioria dos frameworks. Então usando reflexão, é possível criar uma nova instância da classe e copiar campo a campo.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">clone</span><span class="o">(</span><span class="no">T</span> <span class="n">original</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="no">T</span> <span class="n">clone</span> <span class="o">=</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">original</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredConstructor</span><span class="o">().</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Field</span> <span class="n">field</span> <span class="o">:</span> <span class="n">original</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredFields</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="nc">Modifier</span><span class="o">.</span><span class="na">isStatic</span><span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                <span class="n">field</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">clone</span><span class="o">,</span> <span class="n">field</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">original</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">clone</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InstantiationException</span> <span class="o">|</span> <span class="nc">IllegalAccessException</span> <span class="o">|</span> <span class="nc">IllegalArgumentException</span> <span class="o">|</span> <span class="nc">InvocationTargetException</span>
            <span class="o">|</span> <span class="nc">NoSuchMethodException</span> <span class="o">|</span> <span class="nc">SecurityException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Não consigo clonar!"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Com a implementação usando reflexão, podemos ter mais liberdade, não sendo necessário alterar ou implementar em cada classe seu método <code class="language-plaintext highlighter-rouge">clone</code>. A única penalidade é no tempo de execução. Por inspecionar a classe em tempo de execução, ela é mais demorada que a simples cópia dos campos.</p>

<h2 id="possíveis-tipos-de-clone">Possíveis tipos de clone</h2>

<p>Para finalizar a nossa discussão, precisamos debater os tipos de clones que são possíveis. Logo de imediato podemos supor que existe dois tipos de clones, o <em>Shallow Clone</em> e o <em>Deep Clone</em>. No primeiro apenas copiamos os valores de todos os campos do objeto a ser clonado, enquanto no segundo, precisamos verificar se um campo precisa se copiado ou clonado, caso necessário a clonagem, esta deve ser feito.</p>

<p>Para uma representação mais detalhada, vamos supor que cada campo é um nó de um grafo. Assim, ao se fazer o clone precisamos ou copiar o vertice ou a aresta. Quando fazemos o Shallow Clone, apenas copiamos os vertices, apontando para as mesmas arestas. Mas quando fazemos o Deep Clone, criamos uma nova aresta e apontamos o vertice para essa nova aresta.</p>

<p><img src="/assets/images/clones.png" alt="Deep Clone e Shallow Clone usando grafos" /></p>

<p>O Shallow Clone deve ser usado na maioria das vezes, pois não tem complexidade. Se decidirmos criar um clone usando o Deep é preciso algumas verificações. Como não conhecemos a natureza do objeto a ser clonado, deve ser feita uma verificação de unicidade e ciclos. O que isso significa? Quando falamos de unicidade, se temos dois campos apontando para um mesmo objeto, durante a operação de clone, esses dois campos devem apontar para o mesmo objeto clonado. Quando falamos de ciclo, devemos clonar os objetos verificando se não existem ciclos, caso um ciclo seja identificado, a clonagem deve ser interrompida e o mesmo objeto, que já foi clonado, deve ser usado.</p>

<p>O Deep Clone, na grande maioria das vezes, é usado através da serialização. Os objetos são serializados e depois lidos. Essa não é a melhor forma, pois todos os valores não primitivos devem implementar a interface serializer, tem uma péssima performance e há o grande risco dessa operação nunca terminar, caso exista um ciclo no grafo. Um exemplo pode ser encontrado no projeto <a href="https://github.com/imixs/imixs-workflow/blob/master/imixs-workflow-core/src/main/java/org/imixs/workflow/ItemCollection.java#L219">imixs/imixs-workflow</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * This method makes a deep copy of a single item value from a given source
 * ItemCollection. The method can be used in cases the item to copy represents a
 * complex data structure and can not be copied by reference. See also
 * deepCopyOfMap.
 * 
 * @param itemvalue
 * @return
 */</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">cloneItem</span><span class="o">(</span><span class="nc">String</span> <span class="n">itemName</span><span class="o">,</span> <span class="nc">ItemCollection</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">sourceValue</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">getItemValue</span><span class="o">(</span><span class="n">itemName</span><span class="o">);</span>
        <span class="nc">ByteArrayOutputStream</span> <span class="n">bos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="nc">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectOutputStream</span><span class="o">(</span><span class="n">bos</span><span class="o">);</span>
        <span class="c1">// serialize and pass the object</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">sourceValue</span><span class="o">);</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="nc">ByteArrayInputStream</span> <span class="n">bais</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayInputStream</span><span class="o">(</span><span class="n">bos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
        <span class="nc">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="o">(</span><span class="n">bais</span><span class="o">);</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">copy</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">hash</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">itemName</span><span class="o">,</span> <span class="n">copy</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="o">|</span> <span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">warning</span><span class="o">(</span><span class="s">"Unable to clone values of Item '"</span> <span class="o">+</span> <span class="n">itemName</span> <span class="o">+</span> <span class="s">"' - "</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="conclusão">Conclusão</h2>

<p>Nesse pequeno artigo, discutimos desde o que é Tipos primitios e Objetos, até o que é a <em>Heap</em> e a <em>Stack</em>. Com isso foi possivel analisar o que é passagem por valor ou por referência, conceitos que são fundamentais em linguagens como C, mas nem sempre são possíveis de se implementar em Java.</p>

<p>Por fim, vimos quando e como clonar objetos e quais são as possíveis forma de se clonar um objeto.</p>

                </article>
                
                <div style="text-align: center;margin: 10px auto;max-width: 50%;">
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
                        <img alt="Licença Creative Commons" style="border-width:0"
                            src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
                    </a>
                    <br />
                    Este obra está licenciado com uma Licença
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
                        Creative Commons Atribuição-NãoComercial-CompartilhaIgual 4.0 Internacional
                    </a>.
                </div>
                
                <div class="article-footer">
                    
                    <div class="published">
                        <div>Escrito em 22/maio/2021</div>
                    </div>
                    
                    
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         
 
     
        
        
         
 
     
         
     
         
     
         
     
 
     
         
     
         
     
         
     
 
     
        
        
         


    
<div class="related-posts">
    <h2>Posts relacionados</h2>
     
        
         
            
    <a href="/posts/entendendo-o-kafka">
                
                    Entendendo o Kafka — Uma Introdução à Plataforma de Eventos
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
            
    <a href="/posts/jakarta-ee-e-microprofile-io">
                
                    Especificações Jakarta EE & Microprofile.io: Jakarta EE e Microprofile.io
                
    </a>
                
                 
     
        
         
            
    <a href="/posts/escolhendo-uma-implementacao-jakarta-ee-e-microprofile-io">
                
                    Especificações Jakarta EE & Microprofile.io: Escolhendo uma implementação Jakarta EE & Microprofile.io
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
            
    <a href="/posts/como-criar-uma-linguagem-usando-antlr4-e-java">
                
                    Como criar uma linguagem usando ANTLR4 e Java
                
    </a>
                
                 
     
        
         
            
    <a href="/posts/trabalhando-com-dinheiro">
                
                    Coisas que todo Sênior deve saber: Trabalhando com dinheiro!
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
            
    <a href="/posts/deixando-rastros-ou-como-usar-log">
                
                    Coisas que todo Sênior deve saber: Deixando rastros, ou como usar log
                
    </a>
                
                 
     
        
         
            
    <a href="/posts/anatomia-de-um-topico">
                
                    Entendendo o Kafka: Anatomia de um Tópico
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
            
    <a href="/posts/s-o-l-i-d-a-solida-base-para-orientacao-a-objeto">
                
                    Coisas que todo Sênior deve saber: S.O.L.I.D.: A sólida base para Orientação a Objeto
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
     
        
         
            
    <a href="/posts/devops-como-comecar">
                
                    Coisas que todo Sênior deve saber: DevOps! Como começar?
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
            
    <a href="/posts/testes-101-testando-aplicacoes-java">
                
                    Level Up: Testes 101 - Testando aplicações Java
                
    </a>
                
                 
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
             
         
             
         
             
         
     
        
         
            
    <a href="/posts/context-and-dependency-injection-cdi-2-0">
                
                    Especificações Jakarta EE & Microprofile.io: Contexts and Dependency Injection (CDI) 2.0
                
    </a>
                
                 
     
        
            

</div>
                    
                </div>
            </div>
        </div>
        </div>
    </main>
    <footer class="footer">
	<ul class="footer-links">
		<li>
			<a href="/pj-clt/">
				<button type="button" class="btn btn-dark">
					Calculadora PJxCLT
				</button>
			</a>
		</li>
		<li>
			<a href="https://www.youtube.com/@victor.osorio">
				<i class="fab fa-youtube fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>
			<a href="http://github.com/vepo"> 
				<i class="fab fa-github fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>
			<a href="http://www.linkedin.com/in/victorosorio">
				<i class="fab fa-linkedin-in fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>
			<a href="https://bsky.app/profile/vepo.dev">
				<i class="fab fa-bluesky fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>
			<a rel="me" href="https://mastodon.social/@vepo">
				<i class="fab fa-brands fa-mastodon fa-inverse fa-2x"></i>
			</a>
		</li>
		<li>&nbsp;</li>
	</ul>
</footer>

</body>
