<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" type="image/png" href="/icon.png" />

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@koint">
  <meta name="twitter:creator" content="@koint">

  <!-- SEO stuff -->
  <title>Java Memory Leak for JDBC</title>
  <meta property="og:title" content="Java Memory Leak for JDBC" />
  <meta name="twitter:title" content="Java Memory Leak for JDBC">


  
  <meta name="description" content="Have you ever used custom ClassLoaders in Java? This is a troubleshooting for whom is using it." />
  <meta property="og:description" content="Have you ever used custom ClassLoaders in Java? This is a troubleshooting for whom is using it." />
  <meta name="twitter:description" content="Have you ever used custom ClassLoaders in Java? This is a troubleshooting for whom is using it.">

  
  <link rel="canonical" href="/posts/java-memory-leak-for-jdbc/" />
  <meta property="og:url" content="/posts/java-memory-leak-for-jdbc/" />
  <meta name="twitter:url" content="/posts/java-memory-leak-for-jdbc/">

  <meta property="og:site_name" content="Victor OsÃ³rio's Tech Stuffs" />
  <meta property="og:image" content="/assets/images//posts/java-memory-leak-for-jdbc/top.jpg" />
  <meta name="twitter:image" content="/assets/images//posts/java-memory-leak-for-jdbc/top.jpg">

  
  <!-- if it's an article -->
  <meta property="og:type" content="article" />
  
  <meta property="article:published_time" content="2019-06-03T09:46:08-03:00" />
  <meta property="article:modified_time" content="2019-06-03T09:46:08-03:00" />
  

  <meta content="https://www.linkedin.com/in/victorosorio/" property="article:author">

  
  
  

  
  
  <meta content="Java" property="article:tag">
  
  <meta content="JDBC" property="article:tag">
  
  <meta content="Memory Leak" property="article:tag">
  
  <meta content="Garbage Collector" property="article:tag">
  
  

  <script type="application/ld+json">
{"@context": "http://schema.org",
"@type": "BlogPosting",
"headline": "Java Memory Leak for JDBC",
"datePublished": "2019-06-03T09:46:08-03:00",
  
"description": "Have you ever used custom ClassLoaders in Java? This is a troubleshooting for whom is using it.",
  
"url": "/posts/java-memory-leak-for-jdbc/"}</script>

  

  <link rel="author" href="https://www.linkedin.com/in/victorosorio/" />

  <!-- End SEO stuff -->

  <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/assets/css/font-awesome/css/font-awesome.min.css" />
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link href="/assets/css/syntax.css" rel="stylesheet">

  <script src="/assets/js/jquery.min.js"></script>
  <script src="/assets/js/bootstrap.min.js"></script>
  <script data-ad-client="ca-pub-8088229614848913" async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>

<body>
	<div>
	<nav class="navbar navbar-default navbar-fixed-top">
		<div class="container-fluid">
			<div class="navbar-header">
				<button class="navbar-toggle collapsed" type="button" data-toggle="collapse"
					data-target="#navbar-collapse-menu">
					<span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span
						class="icon-bar"></span> <span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="/"> <i class="fa fa-barcode"></i>
				</a>
			</div>
			<div id="navbar-collapse-menu" class="collapse navbar-collapse">
				<ul class="nav navbar-nav">

					
					<!-- If has submenues -->
					
					<li class="dropdown">
						<a class="dropdown-toggle" data-toggle="dropdown" href="#">
							Pet Projects
							<span class="caret"></span>
						</a>
						<ul class="dropdown-menu">
							
							<li>
								<a href="/projects/csv-viewer">
									
									CSV Viewer
								</a>
							</li>
							
							<li>
								<a href="/projects/plain-test">
									
									Plain Test
								</a>
							</li>
							
						</ul>
					</li>
					
					
					<!-- If has submenues -->
					
					<li class="dropdown">
						<a class="dropdown-toggle" data-toggle="dropdown" href="#">
							Presentations
							<span class="caret"></span>
						</a>
						<ul class="dropdown-menu">
							
							<li>
								<a href="/presentations/2020-03-26-sou-java-kafka">
									
									Kafka: Uma introduÃ§Ã£o para Desenvolvedores e Arquitetos
								</a>
							</li>
							
							<li>
								<a href="/presentations/2019-09-14-sou-java-cdi">
									
									Usando Java CDI em projetos Jakarta EE ou Microprofile
								</a>
							</li>
							
						</ul>
					</li>
					
					
					<!-- If has submenues -->
					
					<li><a href="/">Posts</a></li>
					
					
					<!-- If has submenues -->
					
					<li><a href="/tags">Tags</a></li>
					
					
					<!-- If has submenues -->
					
					<li><a href="/about">About</a></li>
					
					
					<!-- If has submenues -->
					
					<li class="dropdown">
						<a class="dropdown-toggle" data-toggle="dropdown" href="#">
							Follow me
							<span class="caret"></span>
						</a>
						<ul class="dropdown-menu">
							
							<li>
								<a href="http://github.com/vepo">
									
									<i class="fa fa-inverse fa-github fa-2x"></i>
									
									GitHub
								</a>
							</li>
							
							<li>
								<a href="http://www.linkedin.com/in/victorosorio">
									
									<i class="fa fa-inverse fa-linkedin-square fa-2x"></i>
									
									LinkedIn
								</a>
							</li>
							
							<li>
								<a href="https://twitter.com/vepo">
									
									<i class="fa fa-inverse fa-twitter fa-2x"></i>
									
									Twitter
								</a>
							</li>
							
						</ul>
					</li>
					
					
				</ul>
			</div>
		</div>
	</nav>
	
	<img alt="Java Memory Leak for JDBC" src="/assets/images/top.jpg" class="img-responsive">
	

	<div class="jumbotron  clearfix">

		<h1 class="text-center">Java Memory Leak for JDBC</h1>

	</div>
</div>
	<div class="container">

		
		<p>
			
			<strong>June 03, 2019</strong>
			
			
			<a class="label label-default" href="/tags/#java">Java</a>
			
			<a class="label label-default" href="/tags/#jdbc">JDBC</a>
			
			<a class="label label-default" href="/tags/#memory-leak">Memory Leak</a>
			
			<a class="label label-default" href="/tags/#garbage-collector">Garbage Collector</a>
			
		</p>
		
		
		<div>
			Post originally published on <a href="https://dev.to/vepo/java-memory-leak-for-jdbc-5dnn">dev.to</a>.
		</div>
		
		<hr>
		

		<h1 id="the-context">The Context</h1>

<p>I had written an engine using a custom ClassLoader. To do that just create a new <a href="https://docs.oracle.com/javase/7/docs/api/java/net/URLClassLoader.html">URLClassLoader</a>, load a jar and execute what code you want, than close the URLClassLoader. If the new ClassLoader doesnâ€™t have access to the current ClassLoader, the loaded classes does not have access to your code. Good! Very Good!</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">URL</span><span class="o">[]</span> <span class="n">jars</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URL</span><span class="o">[]</span> <span class="o">{</span> <span class="cm">/* The jars to be loaded */</span> <span class="o">};</span> <span class="c1">//</span>
<span class="k">try</span> <span class="o">(</span><span class="nc">URLClassLoader</span> <span class="n">classLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">URLClassLoader</span><span class="o">(</span><span class="n">jars</span><span class="o">))</span> <span class="o">{</span>
    <span class="nc">Job</span> <span class="n">job</span> <span class="o">=</span> <span class="n">classLoader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="nc">Job</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="n">job</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h1 id="the-problem">The Problem</h1>

<p>Butâ€¦ We do not have control with the code loaded from an external Jar. That is the problem. So if you want to avoid memory leaks the your custom classloader should be released by Garbage Collector. If the loaded code uses JDBC you will soon get an OutOfMemoryError and everything will crash! Not good!</p>

<h1 id="the-reason">The reason</h1>
<p>Whe JDBC loads the driver they assumes that you will use only one ClassLoader, so  it create a reference to your ClassLoader. This reference prevents the Garbage Collector from removing your custom ClassLoader from the memory.</p>

<p><img src="https://thepracticaldev.s3.amazonaws.com/i/789mmfr2dkp8ezgm2p91.png" alt="" /></p>

<p>So, even if you create your ClassLoader, execute your code and close it. The total of loaded classes will never decrease.</p>

<h1 id="how-to-solve">How to solve?</h1>

<p>To solve this problem we have to unregister all JDBC drivers just after the execution, than close URLClassLoader.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">URL</span><span class="o">[]</span> <span class="n">jars</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URL</span><span class="o">[]</span> <span class="o">{</span> <span class="cm">/* The jars to be loaded */</span> <span class="o">};</span> <span class="c1">//</span>
<span class="k">try</span> <span class="o">(</span><span class="nc">URLClassLoader</span> <span class="n">classLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">URLClassLoader</span><span class="o">(</span><span class="n">jars</span><span class="o">))</span> <span class="o">{</span>
  <span class="nc">Job</span> <span class="n">job</span> <span class="o">=</span> <span class="n">classLoader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="nc">Job</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
  <span class="n">job</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
  <span class="nc">Collections</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="nc">DriverManager</span><span class="o">.</span><span class="na">getDrivers</span><span class="o">()).</span><span class="na">forEach</span><span class="o">(</span><span class="n">driver</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">DriverManager</span><span class="o">.</span><span class="na">deregisterDriver</span><span class="o">(</span><span class="n">driver</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error unregistering driver!"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">});</span>
<span class="o">}</span> 
</code></pre></div></div>

<p>Now, letâ€™s look for the loaded classes:</p>

<p><img src="https://thepracticaldev.s3.amazonaws.com/i/xzaa7ftdokc0078tg9n5.png" alt="" /></p>

<h1 id="possible-problems">Possible problems</h1>

<ol>
  <li>If the executed code create any Thread, the URLClassLoader is not eligible for Garbage Collector.</li>
  <li>If some library create any Thread, same problem from #1.</li>
  <li>MongoDb client create a Thread. ðŸ˜«</li>
</ol>



		
		<div class="published">
			
			<div>Originally published June 03, 2019</div>
			
		</div>

		<div class="related-posts">
			<div class="related-post-header">Related posts</div>
			
			
			
			
			
			
			
			
			
			
			
			
			
			<div class="related-post-item">
				<a href="/posts/jakarta-ee-e-microprofile-io/">
					Jakarta EE e Microprofile.io
				</a>
			</div>
			
			
			
			
			<div class="related-post-item">
				<a href="/posts/escolhendo-uma-implementacao-jakarta-ee-microprofile-io/">
					Escolhendo uma implementaÃ§Ã£o Jakarta EE & Microprofile.io
				</a>
			</div>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			<div class="related-post-item">
				<a href="/posts/thoughts-on-tdd-tests-and-requirements/">
					Tests and Requirements
				</a>
			</div>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			<div class="related-post-item">
				<a href="/posts/a-very-simple-test-driven-development-tutorial/">
					A very simple Test Driven Development Tutorial
				</a>
			</div>
			
			
			
		</div>

		
		<script>window.twttr = (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0],
      t = window.twttr || {};
    if (d.getElementById(id)) return t;
    js = d.createElement(s);
    js.id = id;
    js.src = "https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js, fjs);
  
    t._e = [];
    t.ready = function(f) {
      t._e.push(f);
    };
  
    return t;
  }(document, "script", "twitter-wjs"));</script>
	</div>
	<footer class="footer">
	<ul class="footer-links">
		<li><a href="http://github.com/vepo"> <i class="fa fa-inverse fa-github fa-3x"></i></a></li>
		<li><a href="http://www.linkedin.com/in/victorosorio"> <i
					class="fa fa-inverse fa-linkedin-square fa-3x"></i></a></li>
		<li><a href="https://twitter.com/vepo"> <i class="fa fa-inverse fa-twitter fa-3x"></i></a></li>
	</ul>
</footer>
	<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', '');
</script>
</body>

</html>